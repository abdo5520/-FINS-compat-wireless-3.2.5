<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CompatWireless3.2: drivers/net/wireless/b43/phy_common.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>drivers/net/wireless/b43/phy_common.c</h1><a href="phy__common_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Broadcom B43 wireless driver</span>
<a name="l00004"></a>00004 <span class="comment">  Common PHY routines</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Copyright (c) 2005 Martin Langer &lt;martin-langer@gmx.de&gt;,</span>
<a name="l00007"></a>00007 <span class="comment">  Copyright (c) 2005-2007 Stefano Brivio &lt;stefano.brivio@polimi.it&gt;</span>
<a name="l00008"></a>00008 <span class="comment">  Copyright (c) 2005-2008 Michael Buesch &lt;m@bues.ch&gt;</span>
<a name="l00009"></a>00009 <span class="comment">  Copyright (c) 2005, 2006 Danny van Dyk &lt;kugelfang@gentoo.org&gt;</span>
<a name="l00010"></a>00010 <span class="comment">  Copyright (c) 2005, 2006 Andreas Jaggi &lt;andreas.jaggi@waterwave.ch&gt;</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
<a name="l00013"></a>00013 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
<a name="l00014"></a>00014 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00015"></a>00015 <span class="comment">  (at your option) any later version.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
<a name="l00018"></a>00018 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00019"></a>00019 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00020"></a>00020 <span class="comment">  GNU General Public License for more details.</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">  You should have received a copy of the GNU General Public License</span>
<a name="l00023"></a>00023 <span class="comment">  along with this program; see the file COPYING.  If not, write to</span>
<a name="l00024"></a>00024 <span class="comment">  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,</span>
<a name="l00025"></a>00025 <span class="comment">  Boston, MA 02110-1301, USA.</span>
<a name="l00026"></a>00026 <span class="comment"></span>
<a name="l00027"></a>00027 <span class="comment">*/</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="phy__common_8h.html">phy_common.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="phy__g_8h.html">phy_g.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="phy__a_8h.html">phy_a.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="phy__n_8h.html">phy_n.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="phy__lp_8h.html">phy_lp.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="phy__ht_8h.html">phy_ht.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="phy__lcn_8h.html">phy_lcn.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="b43_8h.html">b43.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="main_8h.html">main.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="phy__common_8h.html#a92a3341f8bdc441c77f7f114b355a1d3">00040</a> <span class="keywordtype">int</span> <a class="code" href="phy__common_8c.html#a92a3341f8bdc441c77f7f114b355a1d3">b43_phy_allocate</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00041"></a>00041 {
<a name="l00042"></a>00042         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;(dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>);
<a name="l00043"></a>00043         <span class="keywordtype">int</span> err;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045         phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a> = NULL;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047         <span class="keywordflow">switch</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a>) {
<a name="l00048"></a>00048         <span class="keywordflow">case</span> <a class="code" href="b43_8h.html#a625ec4d10755d18ef60ab7522c7a3e82">B43_PHYTYPE_A</a>:
<a name="l00049"></a>00049                 phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a> = &amp;<a class="code" href="phy__a_8c.html#ac2bd8176fde20d3885941db47ecc273c">b43_phyops_a</a>;
<a name="l00050"></a>00050                 <span class="keywordflow">break</span>;
<a name="l00051"></a>00051         <span class="keywordflow">case</span> <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>:
<a name="l00052"></a>00052                 phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a> = &amp;<a class="code" href="phy__g_8c.html#aeeb6af546e2258f6e982d93d8474bd66">b43_phyops_g</a>;
<a name="l00053"></a>00053                 <span class="keywordflow">break</span>;
<a name="l00054"></a>00054         <span class="keywordflow">case</span> <a class="code" href="b43_8h.html#a06cd8a71c98dc266f80231ddbf4d517f">B43_PHYTYPE_N</a>:
<a name="l00055"></a>00055 <span class="preprocessor">#ifdef CONFIG_B43_PHY_N</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>                phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a> = &amp;<a class="code" href="phy__n_8c.html#a1b2d907dd3440e218cadebcc13fbda5d">b43_phyops_n</a>;
<a name="l00057"></a>00057 <span class="preprocessor">#endif</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
<a name="l00059"></a>00059         <span class="keywordflow">case</span> <a class="code" href="b43_8h.html#a0c9ac0eab8ebec006e846cd3407a5b74">B43_PHYTYPE_LP</a>:
<a name="l00060"></a>00060 <span class="preprocessor">#ifdef CONFIG_B43_PHY_LP</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>                phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a> = &amp;<a class="code" href="phy__lp_8c.html#aff941e0d990f2c7725bfee8a36b718c8">b43_phyops_lp</a>;
<a name="l00062"></a>00062 <span class="preprocessor">#endif</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
<a name="l00064"></a>00064         <span class="keywordflow">case</span> <a class="code" href="b43_8h.html#a0e005b97ddf96316bb1915d5a1300020">B43_PHYTYPE_HT</a>:
<a name="l00065"></a>00065 <span class="preprocessor">#ifdef CONFIG_B43_PHY_HT</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>                phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a> = &amp;<a class="code" href="phy__ht_8c.html#a6fa64e4cf573dd5fddd8e88d153b6f80">b43_phyops_ht</a>;
<a name="l00067"></a>00067 <span class="preprocessor">#endif</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
<a name="l00069"></a>00069         <span class="keywordflow">case</span> <a class="code" href="b43_8h.html#a4ada07f98e0da175a4585695a4317da1">B43_PHYTYPE_LCN</a>:
<a name="l00070"></a>00070 <span class="preprocessor">#ifdef CONFIG_B43_PHY_LCN</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>                phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a> = &amp;<a class="code" href="phy__lcn_8c.html#ad5080b1a415069724f82c82437eb1834">b43_phyops_lcn</a>;
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
<a name="l00074"></a>00074         }
<a name="l00075"></a>00075         <span class="keywordflow">if</span> (<a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(!phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>))
<a name="l00076"></a>00076                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078         err = phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a165c4f4148350fc709122de3c7ce3efd">allocate</a>(dev);
<a name="l00079"></a>00079         <span class="keywordflow">if</span> (err)
<a name="l00080"></a>00080                 phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a> = NULL;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         <span class="keywordflow">return</span> err;
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="phy__common_8h.html#a521d74185ab8de86484ebd1f9a011b63">00085</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a521d74185ab8de86484ebd1f9a011b63">b43_phy_free</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#ad8e02f50dcdd9630fa2c2dce07d952a5">free</a>(dev);
<a name="l00088"></a>00088         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a> = NULL;
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="phy__common_8h.html#a01698c806ccc56ae4600c72b735f53d8">00091</a> <span class="keywordtype">int</span> <a class="code" href="phy__common_8c.html#a01698c806ccc56ae4600c72b735f53d8">b43_phy_init</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00094"></a>00094         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structb43__phy__operations.html">b43_phy_operations</a> *ops = phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>;
<a name="l00095"></a>00095         <span class="keywordtype">int</span> err;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097         phy-&gt;<a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a> = ops-&gt;<a class="code" href="structb43__phy__operations.html#af9bf251571e08b2c7306a2b48f86a389">get_default_chan</a>(dev);
<a name="l00098"></a>00098 
<a name="l00099"></a>00099         ops-&gt;<a class="code" href="structb43__phy__operations.html#aaa38e90c15b49314308ce760504a3342">software_rfkill</a>(dev, <span class="keyword">false</span>);
<a name="l00100"></a>00100         err = ops-&gt;<a class="code" href="structb43__phy__operations.html#ae9df54bbdba515cd2b3f5576795d6607">init</a>(dev);
<a name="l00101"></a>00101         <span class="keywordflow">if</span> (err) {
<a name="l00102"></a>00102                 <a class="code" href="main_8c.html#ae7d6323280005f3298ddcf79752f1e77">b43err</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>, <span class="stringliteral">&quot;PHY init failed\n&quot;</span>);
<a name="l00103"></a>00103                 <span class="keywordflow">goto</span> err_block_rf;
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105         <span class="comment">/* Make sure to switch hardware and firmware (SHM) to</span>
<a name="l00106"></a>00106 <span class="comment">         * the default channel. */</span>
<a name="l00107"></a>00107         err = <a class="code" href="phy__common_8c.html#a2efed98acfe2e35f6199b0e608e4a18c">b43_switch_channel</a>(dev, ops-&gt;<a class="code" href="structb43__phy__operations.html#af9bf251571e08b2c7306a2b48f86a389">get_default_chan</a>(dev));
<a name="l00108"></a>00108         <span class="keywordflow">if</span> (err) {
<a name="l00109"></a>00109                 <a class="code" href="main_8c.html#ae7d6323280005f3298ddcf79752f1e77">b43err</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>, <span class="stringliteral">&quot;PHY init: Channel switch to default failed\n&quot;</span>);
<a name="l00110"></a>00110                 <span class="keywordflow">goto</span> err_phy_exit;
<a name="l00111"></a>00111         }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         <span class="keywordflow">return</span> 0;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 err_phy_exit:
<a name="l00116"></a>00116         <span class="keywordflow">if</span> (ops-&gt;<a class="code" href="structb43__phy__operations.html#a9598e34d7c35ef7d92d78b5da8d2adbc">exit</a>)
<a name="l00117"></a>00117                 ops-&gt;<a class="code" href="structb43__phy__operations.html#a9598e34d7c35ef7d92d78b5da8d2adbc">exit</a>(dev);
<a name="l00118"></a>00118 err_block_rf:
<a name="l00119"></a>00119         ops-&gt;<a class="code" href="structb43__phy__operations.html#aaa38e90c15b49314308ce760504a3342">software_rfkill</a>(dev, <span class="keyword">true</span>);
<a name="l00120"></a>00120 
<a name="l00121"></a>00121         <span class="keywordflow">return</span> err;
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="phy__common_8h.html#a8b1642c1ef86314f2089117ca975bc31">00124</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a8b1642c1ef86314f2089117ca975bc31">b43_phy_exit</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structb43__phy__operations.html">b43_phy_operations</a> *ops = dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>;
<a name="l00127"></a>00127 
<a name="l00128"></a>00128         ops-&gt;<a class="code" href="structb43__phy__operations.html#aaa38e90c15b49314308ce760504a3342">software_rfkill</a>(dev, <span class="keyword">true</span>);
<a name="l00129"></a>00129         <span class="keywordflow">if</span> (ops-&gt;<a class="code" href="structb43__phy__operations.html#a9598e34d7c35ef7d92d78b5da8d2adbc">exit</a>)
<a name="l00130"></a>00130                 ops-&gt;<a class="code" href="structb43__phy__operations.html#a9598e34d7c35ef7d92d78b5da8d2adbc">exit</a>(dev);
<a name="l00131"></a>00131 }
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="phy__common_8h.html#afa362e73009d656f7574adbbfa0de0e2">00133</a> <span class="keywordtype">bool</span> <a class="code" href="phy__common_8c.html#afa362e73009d656f7574adbbfa0de0e2">b43_has_hardware_pctl</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135         <span class="keywordflow">if</span> (!dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a6a7e29075d89387a43d303c5d7f38430">hardware_power_control</a>)
<a name="l00136"></a>00136                 <span class="keywordflow">return</span> 0;
<a name="l00137"></a>00137         <span class="keywordflow">if</span> (!dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#aeb200df6a26330426a8cb974f232cb57">supports_hwpctl</a>)
<a name="l00138"></a>00138                 <span class="keywordflow">return</span> 0;
<a name="l00139"></a>00139         <span class="keywordflow">return</span> dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#aeb200df6a26330426a8cb974f232cb57">supports_hwpctl</a>(dev);
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="phy__common_8h.html#a00c24702245c80591279e889e287d79f">00142</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a00c24702245c80591279e889e287d79f">b43_radio_lock</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144         u32 macctl;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="preprocessor">#if B43_DEBUG</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>        <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.radio_locked);
<a name="l00148"></a>00148         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.radio_locked = 1;
<a name="l00149"></a>00149 <span class="preprocessor">#endif</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span>
<a name="l00151"></a>00151         macctl = <a class="code" href="b43_8h.html#adfd04e75bffd22461c0c7a3eab648ea1">b43_read32</a>(dev, <a class="code" href="b43_8h.html#ae49bbdbfd9ea55e3f0b21578d9e35ec7">B43_MMIO_MACCTL</a>);
<a name="l00152"></a>00152         macctl |= <a class="code" href="b43_8h.html#a00f085cddfb01679b0f7923b36734690">B43_MACCTL_RADIOLOCK</a>;
<a name="l00153"></a>00153         <a class="code" href="b43_8h.html#a44d913e8694345c005f13a9a95040cd9">b43_write32</a>(dev, <a class="code" href="b43_8h.html#ae49bbdbfd9ea55e3f0b21578d9e35ec7">B43_MMIO_MACCTL</a>, macctl);
<a name="l00154"></a>00154         <span class="comment">/* Commit the write and wait for the firmware</span>
<a name="l00155"></a>00155 <span class="comment">         * to finish any radio register access. */</span>
<a name="l00156"></a>00156         <a class="code" href="b43_8h.html#adfd04e75bffd22461c0c7a3eab648ea1">b43_read32</a>(dev, <a class="code" href="b43_8h.html#ae49bbdbfd9ea55e3f0b21578d9e35ec7">B43_MMIO_MACCTL</a>);
<a name="l00157"></a>00157         udelay(10);
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="phy__common_8h.html#afa073ccfcee4a29ec7e02a37c6995c30">00160</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#afa073ccfcee4a29ec7e02a37c6995c30">b43_radio_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162         u32 macctl;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="preprocessor">#if B43_DEBUG</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span>        <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(!dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.radio_locked);
<a name="l00166"></a>00166         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.radio_locked = 0;
<a name="l00167"></a>00167 <span class="preprocessor">#endif</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>
<a name="l00169"></a>00169         <span class="comment">/* Commit any write */</span>
<a name="l00170"></a>00170         <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a9c5cd27e0247a1843e403b18b7a1ef6d">B43_MMIO_PHY_VER</a>);
<a name="l00171"></a>00171         <span class="comment">/* unlock */</span>
<a name="l00172"></a>00172         macctl = <a class="code" href="b43_8h.html#adfd04e75bffd22461c0c7a3eab648ea1">b43_read32</a>(dev, <a class="code" href="b43_8h.html#ae49bbdbfd9ea55e3f0b21578d9e35ec7">B43_MMIO_MACCTL</a>);
<a name="l00173"></a>00173         macctl &amp;= ~<a class="code" href="b43_8h.html#a00f085cddfb01679b0f7923b36734690">B43_MACCTL_RADIOLOCK</a>;
<a name="l00174"></a>00174         <a class="code" href="b43_8h.html#a44d913e8694345c005f13a9a95040cd9">b43_write32</a>(dev, <a class="code" href="b43_8h.html#ae49bbdbfd9ea55e3f0b21578d9e35ec7">B43_MMIO_MACCTL</a>, macctl);
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00177"></a><a class="code" href="phy__common_8h.html#a91f8d6f96e8acab0a95ea26f5490eaa5">00177</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a91f8d6f96e8acab0a95ea26f5490eaa5">b43_phy_lock</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179 <span class="preprocessor">#if B43_DEBUG</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>        <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.phy_locked);
<a name="l00181"></a>00181         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.phy_locked = 1;
<a name="l00182"></a>00182 <span class="preprocessor">#endif</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>        <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#ab42cbe711656a02f56a3e58b8fda73c4">core_rev</a> &lt; 3);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185         <span class="keywordflow">if</span> (!<a class="code" href="b43_8h.html#a8ffc594f98434da9340205066a4b188f">b43_is_mode</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>, NL80211_IFTYPE_AP))
<a name="l00186"></a>00186                 <a class="code" href="main_8c.html#ad37797ca2e138c27c2dde2ffc37677a9">b43_power_saving_ctl_bits</a>(dev, <a class="code" href="main_8h.html#af41c373499b4d0403b8e2ebe2503729c">B43_PS_AWAKE</a>);
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="phy__common_8h.html#a7e20f7c7257bdf193df63ae1a3b2a26f">00189</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a7e20f7c7257bdf193df63ae1a3b2a26f">b43_phy_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191 <span class="preprocessor">#if B43_DEBUG</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>        <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(!dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.phy_locked);
<a name="l00193"></a>00193         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.phy_locked = 0;
<a name="l00194"></a>00194 <span class="preprocessor">#endif</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>        <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#ab42cbe711656a02f56a3e58b8fda73c4">core_rev</a> &lt; 3);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197         <span class="keywordflow">if</span> (!<a class="code" href="b43_8h.html#a8ffc594f98434da9340205066a4b188f">b43_is_mode</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>, NL80211_IFTYPE_AP))
<a name="l00198"></a>00198                 <a class="code" href="main_8c.html#ad37797ca2e138c27c2dde2ffc37677a9">b43_power_saving_ctl_bits</a>(dev, 0);
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a><a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">00201</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">assert_mac_suspended</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203         <span class="keywordflow">if</span> (!<a class="code" href="b43_8h.html#a3e75683a6a0279e3277985c124a5dee0">B43_DEBUG</a>)
<a name="l00204"></a>00204                 <span class="keywordflow">return</span>;
<a name="l00205"></a>00205         <span class="keywordflow">if</span> ((<a class="code" href="b43_8h.html#a6c3bdf50bac1e19b0f6e3516750c4331">b43_status</a>(dev) &gt;= <a class="code" href="b43_8h.html#abc6126af1d45847bc59afa0aa3216b04add6b34ef5b27600fa828a406e9ef9d8c">B43_STAT_INITIALIZED</a>) &amp;&amp;
<a name="l00206"></a>00206             (dev-&gt;<a class="code" href="structb43__wldev.html#adc728bd8f85fbeb64490b81b89479b71">mac_suspended</a> &lt;= 0)) {
<a name="l00207"></a>00207                 <a class="code" href="main_8c.html#ac3164e7d1ba2fbd05fce755cdb232382">b43dbg</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>, <span class="stringliteral">&quot;PHY/RADIO register access with &quot;</span>
<a name="l00208"></a>00208                        <span class="stringliteral">&quot;enabled MAC.\n&quot;</span>);
<a name="l00209"></a>00209                 dump_stack();
<a name="l00210"></a>00210         }
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a><a class="code" href="phy__common_8h.html#a5b0ff7aded31f6b198da210e42aa4cf2">00213</a> u16 <a class="code" href="phy__common_8c.html#a5b0ff7aded31f6b198da210e42aa4cf2">b43_radio_read</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 reg)
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215         <a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">assert_mac_suspended</a>(dev);
<a name="l00216"></a>00216         <span class="keywordflow">return</span> dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a83150c6bc281c820e28015214e85f392">radio_read</a>(dev, reg);
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a><a class="code" href="phy__common_8h.html#ac00fdf75c09fab7057076c10253170b0">00219</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#ac00fdf75c09fab7057076c10253170b0">b43_radio_write</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 reg, u16 value)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221         <a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">assert_mac_suspended</a>(dev);
<a name="l00222"></a>00222         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a8a36df526d37eab65c9dcd19ca95c9fb">radio_write</a>(dev, reg, value);
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="phy__common_8h.html#aa0d4025c0760e0d0bd1529c62d1fff87">00225</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#aa0d4025c0760e0d0bd1529c62d1fff87">b43_radio_mask</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 offset, u16 mask)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, offset,
<a name="l00228"></a>00228                           <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, offset) &amp; mask);
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a><a class="code" href="phy__common_8h.html#a2d71a0cd69c04c73275668125a89651e">00231</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 offset, u16 <span class="keyword">set</span>)
<a name="l00232"></a>00232 {
<a name="l00233"></a>00233         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, offset,
<a name="l00234"></a>00234                           <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, offset) | <span class="keyword">set</span>);
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="phy__common_8h.html#a977aa8411429bf4468cff41f6020ea02">00237</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 offset, u16 mask, u16 <span class="keyword">set</span>)
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, offset,
<a name="l00240"></a>00240                           (<a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, offset) &amp; mask) | <span class="keyword">set</span>);
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a><a class="code" href="phy__common_8h.html#a03304a9babb3f6bd671e7675168c6f06">00243</a> u16 <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 reg)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245         <a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">assert_mac_suspended</a>(dev);
<a name="l00246"></a>00246         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a4085eee9b4c83506071f0418c381dea7">writes_counter</a> = 0;
<a name="l00247"></a>00247         <span class="keywordflow">return</span> dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#aea65ba09805d1d5c1606ce7ba54dc468">phy_read</a>(dev, reg);
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="phy__common_8h.html#a771be8516fddf5dd3f42196ba536739e">00250</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 reg, u16 value)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252         <a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">assert_mac_suspended</a>(dev);
<a name="l00253"></a>00253         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#aa64fb3d5e143a361a7a84b2c8967d204">phy_write</a>(dev, reg, value);
<a name="l00254"></a>00254         <span class="keywordflow">if</span> (++dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a4085eee9b4c83506071f0418c381dea7">writes_counter</a> == <a class="code" href="phy__common_8h.html#ab5a871ae0c27d9d02aae3c8759a45173">B43_MAX_WRITES_IN_ROW</a>) {
<a name="l00255"></a>00255                 <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a9c5cd27e0247a1843e403b18b7a1ef6d">B43_MMIO_PHY_VER</a>);
<a name="l00256"></a>00256                 dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a4085eee9b4c83506071f0418c381dea7">writes_counter</a> = 0;
<a name="l00257"></a>00257         }
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00260"></a><a class="code" href="phy__common_8h.html#a7f6accd2de2c16a2ef2e36e4098c28ce">00260</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a7f6accd2de2c16a2ef2e36e4098c28ce">b43_phy_copy</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 destreg, u16 srcreg)
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262         <a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">assert_mac_suspended</a>(dev);
<a name="l00263"></a>00263         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#aa64fb3d5e143a361a7a84b2c8967d204">phy_write</a>(dev, destreg,
<a name="l00264"></a>00264                 dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#aea65ba09805d1d5c1606ce7ba54dc468">phy_read</a>(dev, srcreg));
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="phy__common_8h.html#af989c6b9b6c21865492deca5a70754d4">00267</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 offset, u16 mask)
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a63e63aa8024eecd68c6b821725f06f71">phy_maskset</a>) {
<a name="l00270"></a>00270                 <a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">assert_mac_suspended</a>(dev);
<a name="l00271"></a>00271                 dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a63e63aa8024eecd68c6b821725f06f71">phy_maskset</a>(dev, offset, mask, 0);
<a name="l00272"></a>00272         } <span class="keywordflow">else</span> {
<a name="l00273"></a>00273                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, offset,
<a name="l00274"></a>00274                               <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, offset) &amp; mask);
<a name="l00275"></a>00275         }
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="phy__common_8h.html#ac1f1488d81fb9ba843ec6c2995958452">00278</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 offset, u16 <span class="keyword">set</span>)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a63e63aa8024eecd68c6b821725f06f71">phy_maskset</a>) {
<a name="l00281"></a>00281                 <a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">assert_mac_suspended</a>(dev);
<a name="l00282"></a>00282                 dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a63e63aa8024eecd68c6b821725f06f71">phy_maskset</a>(dev, offset, 0xFFFF, <span class="keyword">set</span>);
<a name="l00283"></a>00283         } <span class="keywordflow">else</span> {
<a name="l00284"></a>00284                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, offset,
<a name="l00285"></a>00285                               <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, offset) | <span class="keyword">set</span>);
<a name="l00286"></a>00286         }
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a><a class="code" href="phy__common_8h.html#aabba815f5765fe05a552c6c0cdf1e69b">00289</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 offset, u16 mask, u16 <span class="keyword">set</span>)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a63e63aa8024eecd68c6b821725f06f71">phy_maskset</a>) {
<a name="l00292"></a>00292                 <a class="code" href="phy__common_8c.html#a0388f9e2b9491fcf2212c910ecb68388">assert_mac_suspended</a>(dev);
<a name="l00293"></a>00293                 dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a63e63aa8024eecd68c6b821725f06f71">phy_maskset</a>(dev, offset, mask, <span class="keyword">set</span>);
<a name="l00294"></a>00294         } <span class="keywordflow">else</span> {
<a name="l00295"></a>00295                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, offset,
<a name="l00296"></a>00296                               (<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, offset) &amp; mask) | <span class="keyword">set</span>);
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a><a class="code" href="phy__common_8h.html#a2efed98acfe2e35f6199b0e608e4a18c">00300</a> <span class="keywordtype">int</span> <a class="code" href="phy__common_8c.html#a2efed98acfe2e35f6199b0e608e4a18c">b43_switch_channel</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> new_channel)
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;(dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>);
<a name="l00303"></a>00303         u16 channelcookie, savedcookie;
<a name="l00304"></a>00304         <span class="keywordtype">int</span> err;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306         <span class="keywordflow">if</span> (new_channel == <a class="code" href="phy__common_8h.html#ae7e446aa525c8e52dfbbc8b4d171e835">B43_DEFAULT_CHANNEL</a>)
<a name="l00307"></a>00307                 new_channel = phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#af9bf251571e08b2c7306a2b48f86a389">get_default_chan</a>(dev);
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         <span class="comment">/* First we set the channel radio code to prevent the</span>
<a name="l00310"></a>00310 <span class="comment">         * firmware from sending ghost packets.</span>
<a name="l00311"></a>00311 <span class="comment">         */</span>
<a name="l00312"></a>00312         channelcookie = new_channel;
<a name="l00313"></a>00313         <span class="keywordflow">if</span> (<a class="code" href="b43_8h.html#aaea9136ad670401f899f2ea0a5288bf5">b43_current_band</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>) == IEEE80211_BAND_5GHZ)
<a name="l00314"></a>00314                 channelcookie |= <a class="code" href="b43_8h.html#abca0a3a3cb60c0abe56ae40aa00d4af3">B43_SHM_SH_CHAN_5GHZ</a>;
<a name="l00315"></a>00315         <span class="comment">/* FIXME: set 40Mhz flag if required */</span>
<a name="l00316"></a>00316         <span class="keywordflow">if</span> (0)
<a name="l00317"></a>00317                 channelcookie |= <a class="code" href="b43_8h.html#a2cf6f768b43c0289df1ce970dfd65089">B43_SHM_SH_CHAN_40MHZ</a>;
<a name="l00318"></a>00318         savedcookie = <a class="code" href="main_8c.html#ac30aab4afe8c188ec821fb432ae2b46f">b43_shm_read16</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, <a class="code" href="b43_8h.html#a60683db1789b15fc0804f2bfa64d8b65">B43_SHM_SH_CHAN</a>);
<a name="l00319"></a>00319         <a class="code" href="main_8c.html#a28f7e4e0e4386f41d555003b22b2775f">b43_shm_write16</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, <a class="code" href="b43_8h.html#a60683db1789b15fc0804f2bfa64d8b65">B43_SHM_SH_CHAN</a>, channelcookie);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321         <span class="comment">/* Now try to switch the PHY hardware channel. */</span>
<a name="l00322"></a>00322         err = phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#ac2dad6d2a30f06eea0d869086cdd7cef">switch_channel</a>(dev, new_channel);
<a name="l00323"></a>00323         <span class="keywordflow">if</span> (err)
<a name="l00324"></a>00324                 <span class="keywordflow">goto</span> err_restore_cookie;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a> = new_channel;
<a name="l00327"></a>00327         <span class="comment">/* Wait for the radio to tune to the channel and stabilize. */</span>
<a name="l00328"></a>00328         msleep(8);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330         <span class="keywordflow">return</span> 0;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 err_restore_cookie:
<a name="l00333"></a>00333         <a class="code" href="main_8c.html#a28f7e4e0e4386f41d555003b22b2775f">b43_shm_write16</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>,
<a name="l00334"></a>00334                         <a class="code" href="b43_8h.html#a60683db1789b15fc0804f2bfa64d8b65">B43_SHM_SH_CHAN</a>, savedcookie);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336         <span class="keywordflow">return</span> err;
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a><a class="code" href="phy__common_8h.html#ab5aa98091c0828bdd5b94c6f0d63b1ad">00339</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#ab5aa98091c0828bdd5b94c6f0d63b1ad">b43_software_rfkill</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, <span class="keywordtype">bool</span> blocked)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343         <a class="code" href="main_8c.html#a555504fbafc3537b275e563515f7f6d4">b43_mac_suspend</a>(dev);
<a name="l00344"></a>00344         phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#aaa38e90c15b49314308ce760504a3342">software_rfkill</a>(dev, blocked);
<a name="l00345"></a>00345         phy-&gt;<a class="code" href="structb43__phy.html#a3c8e49aec6d085527c4a0589271970ec">radio_on</a> = !blocked;
<a name="l00346"></a>00346         <a class="code" href="main_8c.html#a9078cc08815f04ffb2ca7d5e7eaf071c">b43_mac_enable</a>(dev);
<a name="l00347"></a>00347 }
<a name="l00348"></a>00348 
<a name="l00354"></a><a class="code" href="phy__common_8h.html#ac7e39b47c675e3d4bdcb19cc09045151">00354</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#ac7e39b47c675e3d4bdcb19cc09045151">b43_phy_txpower_adjust_work</a>(<span class="keyword">struct</span> work_struct *work)
<a name="l00355"></a>00355 {
<a name="l00356"></a>00356         <span class="keyword">struct </span><a class="code" href="structb43__wl.html">b43_wl</a> *wl = container_of(work, <span class="keyword">struct</span> <a class="code" href="structb43__wl.html">b43_wl</a>,
<a name="l00357"></a>00357                                          <a class="code" href="structb43__wl.html#aa1e232bf614bb5c71eae6c2582250bf2">txpower_adjust_work</a>);
<a name="l00358"></a>00358         <span class="keyword">struct </span><a class="code" href="structb43__wldev.html">b43_wldev</a> *<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         mutex_lock(&amp;wl-&gt;<a class="code" href="structb43__wl.html#aa80f52c30c811a44dbefd3490aec4945">mutex</a>);
<a name="l00361"></a>00361         dev = wl-&gt;<a class="code" href="structb43__wl.html#a6114d7970d32b547a1e3e32d84d9813b">current_dev</a>;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="keywordflow">if</span> (likely(dev &amp;&amp; (<a class="code" href="b43_8h.html#a6c3bdf50bac1e19b0f6e3516750c4331">b43_status</a>(dev) &gt;= <a class="code" href="b43_8h.html#abc6126af1d45847bc59afa0aa3216b04adf80cda8dd42fadfaae2608454197f51">B43_STAT_STARTED</a>)))
<a name="l00364"></a>00364                 dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a697e028cc40e8afccfdee8d1d84d8762">adjust_txpower</a>(dev);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         mutex_unlock(&amp;wl-&gt;<a class="code" href="structb43__wl.html#aa80f52c30c811a44dbefd3490aec4945">mutex</a>);
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00369"></a><a class="code" href="phy__common_8h.html#a0e494029d77178ed9d6f7816d186c551">00369</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#a0e494029d77178ed9d6f7816d186c551">b43_phy_txpower_check</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00372"></a>00372         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> now = jiffies;
<a name="l00373"></a>00373         <span class="keyword">enum</span> <a class="code" href="phy__common_8h.html#a6db3c97c17dd2ad5300b634b7526fd03">b43_txpwr_result</a> result;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="phy__common_8h.html#a60fb41913ea9f9334e07880eb6b30d2eab33856f2189560125ec4cb605fcba407">B43_TXPWR_IGNORE_TIME</a>)) {
<a name="l00376"></a>00376                 <span class="comment">/* Check if it&#39;s time for a TXpower check. */</span>
<a name="l00377"></a>00377                 <span class="keywordflow">if</span> (time_before(now, phy-&gt;<a class="code" href="structb43__phy.html#af615a5d46e967e435f5cc566a34dacad">next_txpwr_check_time</a>))
<a name="l00378"></a>00378                         <span class="keywordflow">return</span>; <span class="comment">/* Not yet */</span>
<a name="l00379"></a>00379         }
<a name="l00380"></a>00380         <span class="comment">/* The next check will be needed in two seconds, or later. */</span>
<a name="l00381"></a>00381         phy-&gt;<a class="code" href="structb43__phy.html#af615a5d46e967e435f5cc566a34dacad">next_txpwr_check_time</a> = round_jiffies(now + (HZ * 2));
<a name="l00382"></a>00382 
<a name="l00383"></a>00383         <span class="keywordflow">if</span> ((dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a7b61688d8f77fe253308150f344eb259">board_vendor</a> == SSB_BOARDVENDOR_BCM) &amp;&amp;
<a name="l00384"></a>00384             (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a8225eee827fd5a0c40849625fbf88330">board_type</a> == SSB_BOARD_BU4306))
<a name="l00385"></a>00385                 <span class="keywordflow">return</span>; <span class="comment">/* No software txpower adjustment needed */</span>
<a name="l00386"></a>00386 
<a name="l00387"></a>00387         result = phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a0da8b28688a610c8478602696fb5a849">recalc_txpower</a>(dev, !!(flags &amp; <a class="code" href="phy__common_8h.html#a60fb41913ea9f9334e07880eb6b30d2ea8aaa29a31b95c58752db9b07dce3de65">B43_TXPWR_IGNORE_TSSI</a>));
<a name="l00388"></a>00388         <span class="keywordflow">if</span> (result == <a class="code" href="phy__common_8h.html#a6db3c97c17dd2ad5300b634b7526fd03ac688dafff0513e979c11092e64ba76fa">B43_TXPWR_RES_DONE</a>)
<a name="l00389"></a>00389                 <span class="keywordflow">return</span>; <span class="comment">/* We are done. */</span>
<a name="l00390"></a>00390         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(result != <a class="code" href="phy__common_8h.html#a6db3c97c17dd2ad5300b634b7526fd03a899c8d4ba958ab63ab33d04bee1bc01e">B43_TXPWR_RES_NEED_ADJUST</a>);
<a name="l00391"></a>00391         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#a697e028cc40e8afccfdee8d1d84d8762">adjust_txpower</a> == NULL);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <span class="comment">/* We must adjust the transmission power in hardware.</span>
<a name="l00394"></a>00394 <span class="comment">         * Schedule b43_phy_txpower_adjust_work(). */</span>
<a name="l00395"></a>00395         ieee80211_queue_work(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>-&gt;<a class="code" href="structb43__wl.html#a551eff2e1c92bf64bd92e4c1fec5597b">hw</a>, &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>-&gt;<a class="code" href="structb43__wl.html#aa1e232bf614bb5c71eae6c2582250bf2">txpower_adjust_work</a>);
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="phy__common_8h.html#a581634cd38f96a546a16e80ced8cf0b7">00398</a> <span class="keywordtype">int</span> <a class="code" href="phy__common_8c.html#a581634cd38f96a546a16e80ced8cf0b7">b43_phy_shm_tssi_read</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 shm_offset)
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400         <span class="keyword">const</span> <span class="keywordtype">bool</span> is_ofdm = (shm_offset != <a class="code" href="b43_8h.html#a9af2bb015b0f3aba52e5234b7eb4e577">B43_SHM_SH_TSSI_CCK</a>);
<a name="l00401"></a>00401         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structb43__phy.html#af3b7069da8172f2477251700a24f6f8a">a</a>, b, c, d;
<a name="l00402"></a>00402         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> average;
<a name="l00403"></a>00403         u32 tmp;
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         tmp = <a class="code" href="main_8c.html#a6c2b7ac9fc93ba27357ae95675b8484a">b43_shm_read32</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, shm_offset);
<a name="l00406"></a>00406         a = tmp &amp; 0xFF;
<a name="l00407"></a>00407         b = (tmp &gt;&gt; 8) &amp; 0xFF;
<a name="l00408"></a>00408         c = (tmp &gt;&gt; 16) &amp; 0xFF;
<a name="l00409"></a>00409         d = (tmp &gt;&gt; 24) &amp; 0xFF;
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (a == 0 || a == <a class="code" href="b43_8h.html#abaf39b666a6db8a426f2f124472ecba4">B43_TSSI_MAX</a> ||
<a name="l00411"></a>00411             b == 0 || b == <a class="code" href="b43_8h.html#abaf39b666a6db8a426f2f124472ecba4">B43_TSSI_MAX</a> ||
<a name="l00412"></a>00412             c == 0 || c == <a class="code" href="b43_8h.html#abaf39b666a6db8a426f2f124472ecba4">B43_TSSI_MAX</a> ||
<a name="l00413"></a>00413             d == 0 || d == <a class="code" href="b43_8h.html#abaf39b666a6db8a426f2f124472ecba4">B43_TSSI_MAX</a>)
<a name="l00414"></a>00414                 <span class="keywordflow">return</span> -ENOENT;
<a name="l00415"></a>00415         <span class="comment">/* The values are OK. Clear them. */</span>
<a name="l00416"></a>00416         tmp = <a class="code" href="b43_8h.html#abaf39b666a6db8a426f2f124472ecba4">B43_TSSI_MAX</a> | (<a class="code" href="b43_8h.html#abaf39b666a6db8a426f2f124472ecba4">B43_TSSI_MAX</a> &lt;&lt; 8) |
<a name="l00417"></a>00417               (<a class="code" href="b43_8h.html#abaf39b666a6db8a426f2f124472ecba4">B43_TSSI_MAX</a> &lt;&lt; 16) | (<a class="code" href="b43_8h.html#abaf39b666a6db8a426f2f124472ecba4">B43_TSSI_MAX</a> &lt;&lt; 24);
<a name="l00418"></a>00418         <a class="code" href="main_8c.html#a2141285c33d6611aadb9d64f4f8db894">b43_shm_write32</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, shm_offset, tmp);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         <span class="keywordflow">if</span> (is_ofdm) {
<a name="l00421"></a>00421                 a = (a + 32) &amp; 0x3F;
<a name="l00422"></a>00422                 b = (b + 32) &amp; 0x3F;
<a name="l00423"></a>00423                 c = (c + 32) &amp; 0x3F;
<a name="l00424"></a>00424                 d = (d + 32) &amp; 0x3F;
<a name="l00425"></a>00425         }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427         <span class="comment">/* Get the average of the values with 0.5 added to each value. */</span>
<a name="l00428"></a>00428         average = (a + b + c + d + 2) / 4;
<a name="l00429"></a>00429         <span class="keywordflow">if</span> (is_ofdm) {
<a name="l00430"></a>00430                 <span class="comment">/* Adjust for CCK-boost */</span>
<a name="l00431"></a>00431                 <span class="keywordflow">if</span> (<a class="code" href="main_8c.html#ac30aab4afe8c188ec821fb432ae2b46f">b43_shm_read16</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, <a class="code" href="b43_8h.html#a457b6b6ee0481a00c1b1f5651cceb0e7">B43_SHM_SH_HOSTFLO</a>)
<a name="l00432"></a>00432                     &amp; <a class="code" href="b43_8h.html#aa10f5e6ceb0354ef8b8e35def02e4d8f">B43_HF_CCKBOOST</a>)
<a name="l00433"></a>00433                         average = (average &gt;= 13) ? (average - 13) : 0;
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="keywordflow">return</span> average;
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 
<a name="l00439"></a><a class="code" href="phy__common_8h.html#af49ad5a8624b5b2cc16fa2bfc75d095d">00439</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#af49ad5a8624b5b2cc16fa2bfc75d095d">b43_phyop_switch_analog_generic</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, <span class="keywordtype">bool</span> on)
<a name="l00440"></a>00440 {
<a name="l00441"></a>00441         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a1c562314febbe4c4477d45c7ee89521e">B43_MMIO_PHY0</a>, on ? 0 : 0xF4);
<a name="l00442"></a>00442 }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 
<a name="l00445"></a><a class="code" href="phy__common_8h.html#a68bf4fddcc04c2f976206b88455d3a61">00445</a> <span class="keywordtype">bool</span> <a class="code" href="phy__common_8c.html#a68bf4fddcc04c2f976206b88455d3a61">b43_channel_type_is_40mhz</a>(<span class="keyword">enum</span> nl80211_channel_type <a class="code" href="structb43__phy.html#a82402ff096b084b3602fbc3147cc66f4">channel_type</a>)
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447         <span class="keywordflow">return</span> (channel_type == NL80211_CHAN_HT40MINUS ||
<a name="l00448"></a>00448                 channel_type == NL80211_CHAN_HT40PLUS);
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 <span class="comment">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/BmacPhyClkFgc */</span>
<a name="l00452"></a><a class="code" href="phy__common_8h.html#ac6b943b8d455a3d3f136fd79636755b0">00452</a> <span class="keywordtype">void</span> <a class="code" href="phy__common_8c.html#ac6b943b8d455a3d3f136fd79636755b0">b43_phy_force_clock</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, <span class="keywordtype">bool</span> force)
<a name="l00453"></a>00453 {
<a name="l00454"></a>00454         u32 tmp;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         WARN_ON(dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> != <a class="code" href="b43_8h.html#a06cd8a71c98dc266f80231ddbf4d517f">B43_PHYTYPE_N</a> &amp;&amp;
<a name="l00457"></a>00457                 dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> != <a class="code" href="b43_8h.html#a0e005b97ddf96316bb1915d5a1300020">B43_PHYTYPE_HT</a>);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         <span class="keywordflow">switch</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a880bb9d651e18b4cc58ff060ae06b131">bus_type</a>) {
<a name="l00460"></a>00460 <span class="preprocessor">#ifdef CONFIG_B43_BCMA</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>        <span class="keywordflow">case</span> B43_BUS_BCMA:
<a name="l00462"></a>00462                 tmp = bcma_aread32(dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#af89341f941e94abb2f8ac6e98dd5c101">bdev</a>, BCMA_IOCTL);
<a name="l00463"></a>00463                 <span class="keywordflow">if</span> (force)
<a name="l00464"></a>00464                         tmp |= BCMA_IOCTL_FGC;
<a name="l00465"></a>00465                 <span class="keywordflow">else</span>
<a name="l00466"></a>00466                         tmp &amp;= ~BCMA_IOCTL_FGC;
<a name="l00467"></a>00467                 bcma_awrite32(dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#af89341f941e94abb2f8ac6e98dd5c101">bdev</a>, BCMA_IOCTL, tmp);
<a name="l00468"></a>00468                 <span class="keywordflow">break</span>;
<a name="l00469"></a>00469 <span class="preprocessor">#endif</span>
<a name="l00470"></a>00470 <span class="preprocessor"></span><span class="preprocessor">#ifdef CONFIG_B43_SSB</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="bus_8h.html#a7d9e1f255fdc367cca560f2be24647f5a6e49471bf473723b618718b72a3dbc91">B43_BUS_SSB</a>:
<a name="l00472"></a>00472                 tmp = ssb_read32(dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a68f9a4660126ada1510b28be93e1dd0d">sdev</a>, SSB_TMSLOW);
<a name="l00473"></a>00473                 <span class="keywordflow">if</span> (force)
<a name="l00474"></a>00474                         tmp |= SSB_TMSLOW_FGC;
<a name="l00475"></a>00475                 <span class="keywordflow">else</span>
<a name="l00476"></a>00476                         tmp &amp;= ~SSB_TMSLOW_FGC;
<a name="l00477"></a>00477                 ssb_write32(dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a68f9a4660126ada1510b28be93e1dd0d">sdev</a>, SSB_TMSLOW, tmp);
<a name="l00478"></a>00478                 <span class="keywordflow">break</span>;
<a name="l00479"></a>00479 <span class="preprocessor">#endif</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span>        }
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 <span class="comment">/* http://bcm-v4.sipsolutions.net/802.11/PHY/Cordic */</span>
<a name="l00484"></a><a class="code" href="phy__common_8h.html#a8928a3e5490bd5d09726a0498fcd04a2">00484</a> <span class="keyword">struct </span><a class="code" href="structb43__c32.html">b43_c32</a> <a class="code" href="phy__common_8c.html#a8928a3e5490bd5d09726a0498fcd04a2">b43_cordic</a>(int theta)
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486         <span class="keyword">static</span> <span class="keyword">const</span> u32 arctg[] = {
<a name="l00487"></a>00487                 2949120, 1740967, 919879, 466945, 234379, 117304,
<a name="l00488"></a>00488                   58666,   29335,  14668,   7334,   3667,   1833,
<a name="l00489"></a>00489                     917,     458,    229,    115,     57,     29,
<a name="l00490"></a>00490         };
<a name="l00491"></a>00491         u8 <a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a>;
<a name="l00492"></a>00492         s32 tmp;
<a name="l00493"></a>00493         s8 signx = 1;
<a name="l00494"></a>00494         u32 angle = 0;
<a name="l00495"></a>00495         <span class="keyword">struct </span><a class="code" href="structb43__c32.html">b43_c32</a> ret = { .<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> = 39797, .q = 0, };
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         <span class="keywordflow">while</span> (theta &gt; (180 &lt;&lt; 16))
<a name="l00498"></a>00498                 theta -= (360 &lt;&lt; 16);
<a name="l00499"></a>00499         <span class="keywordflow">while</span> (theta &lt; -(180 &lt;&lt; 16))
<a name="l00500"></a>00500                 theta += (360 &lt;&lt; 16);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502         <span class="keywordflow">if</span> (theta &gt; (90 &lt;&lt; 16)) {
<a name="l00503"></a>00503                 theta -= (180 &lt;&lt; 16);
<a name="l00504"></a>00504                 signx = -1;
<a name="l00505"></a>00505         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (theta &lt; -(90 &lt;&lt; 16)) {
<a name="l00506"></a>00506                 theta += (180 &lt;&lt; 16);
<a name="l00507"></a>00507                 signx = -1;
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         <span class="keywordflow">for</span> (<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> = 0; <a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> &lt;= 17; <a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a>++) {
<a name="l00511"></a>00511                 <span class="keywordflow">if</span> (theta &gt; angle) {
<a name="l00512"></a>00512                         tmp = ret.<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> - (ret.<a class="code" href="structb43__c32.html#ac21b7ccdee5b9384f710601c7df89714">q</a> &gt;&gt; <a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a>);
<a name="l00513"></a>00513                         ret.<a class="code" href="structb43__c32.html#ac21b7ccdee5b9384f710601c7df89714">q</a> += ret.<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> &gt;&gt; <a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a>;
<a name="l00514"></a>00514                         ret.<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> = tmp;
<a name="l00515"></a>00515                         angle += arctg[<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a>];
<a name="l00516"></a>00516                 } <span class="keywordflow">else</span> {
<a name="l00517"></a>00517                         tmp = ret.<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> + (ret.<a class="code" href="structb43__c32.html#ac21b7ccdee5b9384f710601c7df89714">q</a> &gt;&gt; <a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a>);
<a name="l00518"></a>00518                         ret.<a class="code" href="structb43__c32.html#ac21b7ccdee5b9384f710601c7df89714">q</a> -= ret.<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> &gt;&gt; <a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a>;
<a name="l00519"></a>00519                         ret.<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> = tmp;
<a name="l00520"></a>00520                         angle -= arctg[<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a>];
<a name="l00521"></a>00521                 }
<a name="l00522"></a>00522         }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524         ret.<a class="code" href="structb43__c32.html#ab47f254a0fc1ee38b6d118738077138e">i</a> *= signx;
<a name="l00525"></a>00525         ret.<a class="code" href="structb43__c32.html#ac21b7ccdee5b9384f710601c7df89714">q</a> *= signx;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="keywordflow">return</span> ret;
<a name="l00528"></a>00528 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 11 22:05:16 2013 for CompatWireless3.2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
