<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CompatWireless3.2: drivers/net/wireless/b43/phy_g.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>drivers/net/wireless/b43/phy_g.c</h1><a href="phy__g_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Broadcom B43 wireless driver</span>
<a name="l00004"></a>00004 <span class="comment">  IEEE 802.11g PHY driver</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Copyright (c) 2005 Martin Langer &lt;martin-langer@gmx.de&gt;,</span>
<a name="l00007"></a>00007 <span class="comment">  Copyright (c) 2005-2007 Stefano Brivio &lt;stefano.brivio@polimi.it&gt;</span>
<a name="l00008"></a>00008 <span class="comment">  Copyright (c) 2005-2008 Michael Buesch &lt;m@bues.ch&gt;</span>
<a name="l00009"></a>00009 <span class="comment">  Copyright (c) 2005, 2006 Danny van Dyk &lt;kugelfang@gentoo.org&gt;</span>
<a name="l00010"></a>00010 <span class="comment">  Copyright (c) 2005, 2006 Andreas Jaggi &lt;andreas.jaggi@waterwave.ch&gt;</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
<a name="l00013"></a>00013 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
<a name="l00014"></a>00014 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00015"></a>00015 <span class="comment">  (at your option) any later version.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
<a name="l00018"></a>00018 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00019"></a>00019 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00020"></a>00020 <span class="comment">  GNU General Public License for more details.</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">  You should have received a copy of the GNU General Public License</span>
<a name="l00023"></a>00023 <span class="comment">  along with this program; see the file COPYING.  If not, write to</span>
<a name="l00024"></a>00024 <span class="comment">  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,</span>
<a name="l00025"></a>00025 <span class="comment">  Boston, MA 02110-1301, USA.</span>
<a name="l00026"></a>00026 <span class="comment"></span>
<a name="l00027"></a>00027 <span class="comment">*/</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="b43_8h.html">b43.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="phy__g_8h.html">phy_g.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="phy__common_8h.html">phy_common.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="lo_8h.html">lo.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="main_8h.html">main.h</a>&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;linux/bitrev.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;linux/slab.h&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="phy__g_8c.html#aeefb762fad7b17aca2d2df8a69f43c02">00039</a> <span class="keyword">static</span> <span class="keyword">const</span> s8 <a class="code" href="phy__g_8c.html#aeefb762fad7b17aca2d2df8a69f43c02">b43_tssi2dbm_g_table</a>[] = {
<a name="l00040"></a>00040         77, 77, 77, 76,
<a name="l00041"></a>00041         76, 76, 75, 75,
<a name="l00042"></a>00042         74, 74, 73, 73,
<a name="l00043"></a>00043         73, 72, 72, 71,
<a name="l00044"></a>00044         71, 70, 70, 69,
<a name="l00045"></a>00045         68, 68, 67, 67,
<a name="l00046"></a>00046         66, 65, 65, 64,
<a name="l00047"></a>00047         63, 63, 62, 61,
<a name="l00048"></a>00048         60, 59, 58, 57,
<a name="l00049"></a>00049         56, 55, 54, 53,
<a name="l00050"></a>00050         52, 50, 49, 47,
<a name="l00051"></a>00051         45, 43, 40, 37,
<a name="l00052"></a>00052         33, 28, 22, 14,
<a name="l00053"></a>00053         5, -7, -20, -20,
<a name="l00054"></a>00054         -20, -20, -20, -20,
<a name="l00055"></a>00055         -20, -20, -20, -20,
<a name="l00056"></a>00056 };
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="phy__g_8c.html#a910efb4c4106577631bf42c35703cb8e">00058</a> <span class="keyword">static</span> <span class="keyword">const</span> u8 <a class="code" href="phy__g_8c.html#a910efb4c4106577631bf42c35703cb8e">b43_radio_channel_codes_bg</a>[] = {
<a name="l00059"></a>00059         12, 17, 22, 27,
<a name="l00060"></a>00060         32, 37, 42, 47,
<a name="l00061"></a>00061         52, 57, 62, 67,
<a name="l00062"></a>00062         72, 84,
<a name="l00063"></a>00063 };
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a0c473583d8f3c46e081b1bb3834fa909">b43_calc_nrssi_threshold</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev);
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="phy__g_8c.html#a6e2516a2956f95f7b875c1ecd009a215">00069</a> <span class="preprocessor">#define bitrev4(tmp) (bitrev8(tmp) &gt;&gt; 4)</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="comment">/* Get the freq, as it has to be written to the device. */</span>
<a name="l00073"></a><a class="code" href="phy__g_8c.html#acb3b7edd4a4c7aa7a635ee4812fd971b">00073</a> <span class="keyword">static</span> <span class="keyword">inline</span> u16 <a class="code" href="phy__g_8c.html#acb3b7edd4a4c7aa7a635ee4812fd971b">channel2freq_bg</a>(u8 channel)
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(!(channel &gt;= 1 &amp;&amp; channel &lt;= 14));
<a name="l00076"></a>00076 
<a name="l00077"></a>00077         <span class="keywordflow">return</span> <a class="code" href="phy__g_8c.html#a910efb4c4106577631bf42c35703cb8e">b43_radio_channel_codes_bg</a>[channel - 1];
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="phy__g_8c.html#a806b0a27f3323b0746382944c69fa0b7">00080</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a806b0a27f3323b0746382944c69fa0b7">generate_rfatt_list</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l00081"></a>00081                                 <span class="keyword">struct</span> <a class="code" href="structb43__rfatt__list.html">b43_rfatt_list</a> *list)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085         <span class="comment">/* APHY.rev &lt; 5 || GPHY.rev &lt; 6 */</span>
<a name="l00086"></a>00086         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structb43__rfatt.html">b43_rfatt</a> rfatt_0[] = {
<a name="l00087"></a>00087                 {.<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 3,.with_padmix = 0,},
<a name="l00088"></a>00088                 {.att = 1,.with_padmix = 0,},
<a name="l00089"></a>00089                 {.att = 5,.with_padmix = 0,},
<a name="l00090"></a>00090                 {.att = 7,.with_padmix = 0,},
<a name="l00091"></a>00091                 {.att = 9,.with_padmix = 0,},
<a name="l00092"></a>00092                 {.att = 2,.with_padmix = 0,},
<a name="l00093"></a>00093                 {.att = 0,.with_padmix = 0,},
<a name="l00094"></a>00094                 {.att = 4,.with_padmix = 0,},
<a name="l00095"></a>00095                 {.att = 6,.with_padmix = 0,},
<a name="l00096"></a>00096                 {.att = 8,.with_padmix = 0,},
<a name="l00097"></a>00097                 {.att = 1,.with_padmix = 1,},
<a name="l00098"></a>00098                 {.att = 2,.with_padmix = 1,},
<a name="l00099"></a>00099                 {.att = 3,.with_padmix = 1,},
<a name="l00100"></a>00100                 {.att = 4,.with_padmix = 1,},
<a name="l00101"></a>00101         };
<a name="l00102"></a>00102         <span class="comment">/* Radio.rev == 8 &amp;&amp; Radio.version == 0x2050 */</span>
<a name="l00103"></a>00103         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structb43__rfatt.html">b43_rfatt</a> rfatt_1[] = {
<a name="l00104"></a>00104                 {.<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 2,.with_padmix = 1,},
<a name="l00105"></a>00105                 {.att = 4,.with_padmix = 1,},
<a name="l00106"></a>00106                 {.att = 6,.with_padmix = 1,},
<a name="l00107"></a>00107                 {.att = 8,.with_padmix = 1,},
<a name="l00108"></a>00108                 {.att = 10,.with_padmix = 1,},
<a name="l00109"></a>00109                 {.att = 12,.with_padmix = 1,},
<a name="l00110"></a>00110                 {.att = 14,.with_padmix = 1,},
<a name="l00111"></a>00111         };
<a name="l00112"></a>00112         <span class="comment">/* Otherwise */</span>
<a name="l00113"></a>00113         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structb43__rfatt.html">b43_rfatt</a> rfatt_2[] = {
<a name="l00114"></a>00114                 {.<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 0,.with_padmix = 1,},
<a name="l00115"></a>00115                 {.att = 2,.with_padmix = 1,},
<a name="l00116"></a>00116                 {.att = 4,.with_padmix = 1,},
<a name="l00117"></a>00117                 {.att = 6,.with_padmix = 1,},
<a name="l00118"></a>00118                 {.att = 8,.with_padmix = 1,},
<a name="l00119"></a>00119                 {.att = 9,.with_padmix = 1,},
<a name="l00120"></a>00120                 {.att = 9,.with_padmix = 1,},
<a name="l00121"></a>00121         };
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="keywordflow">if</span> (!<a class="code" href="phy__common_8c.html#afa362e73009d656f7574adbbfa0de0e2">b43_has_hardware_pctl</a>(dev)) {
<a name="l00124"></a>00124                 <span class="comment">/* Software pctl */</span>
<a name="l00125"></a>00125                 list-&gt;<a class="code" href="structb43__rfatt__list.html#a6e7e95d6ffc0c55f4c6a8b104ae3fa29">list</a> = rfatt_0;
<a name="l00126"></a>00126                 list-&gt;<a class="code" href="structb43__rfatt__list.html#a6a7ec1fbfc1c48c119a44e296701cc5b">len</a> = ARRAY_SIZE(rfatt_0);
<a name="l00127"></a>00127                 list-&gt;<a class="code" href="structb43__rfatt__list.html#aa02c9644ecdbd3cf8c1ef60835d77ba7">min_val</a> = 0;
<a name="l00128"></a>00128                 list-&gt;<a class="code" href="structb43__rfatt__list.html#a7e1de863cebd26bf59ef8301c49a6d7f">max_val</a> = 9;
<a name="l00129"></a>00129                 <span class="keywordflow">return</span>;
<a name="l00130"></a>00130         }
<a name="l00131"></a>00131         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050 &amp;&amp; phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l00132"></a>00132                 <span class="comment">/* Hardware pctl */</span>
<a name="l00133"></a>00133                 list-&gt;<a class="code" href="structb43__rfatt__list.html#a6e7e95d6ffc0c55f4c6a8b104ae3fa29">list</a> = rfatt_1;
<a name="l00134"></a>00134                 list-&gt;<a class="code" href="structb43__rfatt__list.html#a6a7ec1fbfc1c48c119a44e296701cc5b">len</a> = ARRAY_SIZE(rfatt_1);
<a name="l00135"></a>00135                 list-&gt;<a class="code" href="structb43__rfatt__list.html#aa02c9644ecdbd3cf8c1ef60835d77ba7">min_val</a> = 0;
<a name="l00136"></a>00136                 list-&gt;<a class="code" href="structb43__rfatt__list.html#a7e1de863cebd26bf59ef8301c49a6d7f">max_val</a> = 14;
<a name="l00137"></a>00137                 <span class="keywordflow">return</span>;
<a name="l00138"></a>00138         }
<a name="l00139"></a>00139         <span class="comment">/* Hardware pctl */</span>
<a name="l00140"></a>00140         list-&gt;<a class="code" href="structb43__rfatt__list.html#a6e7e95d6ffc0c55f4c6a8b104ae3fa29">list</a> = rfatt_2;
<a name="l00141"></a>00141         list-&gt;<a class="code" href="structb43__rfatt__list.html#a6a7ec1fbfc1c48c119a44e296701cc5b">len</a> = ARRAY_SIZE(rfatt_2);
<a name="l00142"></a>00142         list-&gt;<a class="code" href="structb43__rfatt__list.html#aa02c9644ecdbd3cf8c1ef60835d77ba7">min_val</a> = 0;
<a name="l00143"></a>00143         list-&gt;<a class="code" href="structb43__rfatt__list.html#a7e1de863cebd26bf59ef8301c49a6d7f">max_val</a> = 9;
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a><a class="code" href="phy__g_8c.html#a350bf328dac1cf65d45255b036a84686">00146</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a350bf328dac1cf65d45255b036a84686">generate_bbatt_list</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l00147"></a>00147                                 <span class="keyword">struct</span> <a class="code" href="structb43__bbatt__list.html">b43_bbatt_list</a> *list)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structb43__bbatt.html">b43_bbatt</a> bbatt_0[] = {
<a name="l00150"></a>00150                 {.<a class="code" href="structb43__bbatt.html#afb22eb36d414900b27a1cea58718e822">att</a> = 0,},
<a name="l00151"></a>00151                 {.att = 1,},
<a name="l00152"></a>00152                 {.att = 2,},
<a name="l00153"></a>00153                 {.att = 3,},
<a name="l00154"></a>00154                 {.att = 4,},
<a name="l00155"></a>00155                 {.att = 5,},
<a name="l00156"></a>00156                 {.att = 6,},
<a name="l00157"></a>00157                 {.att = 7,},
<a name="l00158"></a>00158                 {.att = 8,},
<a name="l00159"></a>00159         };
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         list-&gt;<a class="code" href="structb43__bbatt__list.html#a4180f38e8caabceb910f6e44ca7bd294">list</a> = bbatt_0;
<a name="l00162"></a>00162         list-&gt;<a class="code" href="structb43__bbatt__list.html#acf1437af3f2bf1a1293b87279f9ff10a">len</a> = ARRAY_SIZE(bbatt_0);
<a name="l00163"></a>00163         list-&gt;<a class="code" href="structb43__bbatt__list.html#abf95f6e204c4f921b2eedcfad3f7c53b">min_val</a> = 0;
<a name="l00164"></a>00164         list-&gt;<a class="code" href="structb43__bbatt__list.html#a54da50e9c3b483a3737804bd61f55379">max_val</a> = 8;
<a name="l00165"></a>00165 }
<a name="l00166"></a>00166 
<a name="l00167"></a><a class="code" href="phy__g_8c.html#ac449cc1efdbb2780d326da08903dbb93">00167</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#ac449cc1efdbb2780d326da08903dbb93">b43_shm_clear_tssi</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00168"></a>00168 {
<a name="l00169"></a>00169         <a class="code" href="main_8c.html#a28f7e4e0e4386f41d555003b22b2775f">b43_shm_write16</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, 0x0058, 0x7F7F);
<a name="l00170"></a>00170         <a class="code" href="main_8c.html#a28f7e4e0e4386f41d555003b22b2775f">b43_shm_write16</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, 0x005a, 0x7F7F);
<a name="l00171"></a>00171         <a class="code" href="main_8c.html#a28f7e4e0e4386f41d555003b22b2775f">b43_shm_write16</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, 0x0070, 0x7F7F);
<a name="l00172"></a>00172         <a class="code" href="main_8c.html#a28f7e4e0e4386f41d555003b22b2775f">b43_shm_write16</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, 0x0072, 0x7F7F);
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment">/* Synthetic PU workaround */</span>
<a name="l00176"></a><a class="code" href="phy__g_8c.html#a070256ea5337a006d3db2c1b097bd364">00176</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a070256ea5337a006d3db2c1b097bd364">b43_synth_pu_workaround</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u8 channel)
<a name="l00177"></a>00177 {
<a name="l00178"></a>00178         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180         might_sleep();
<a name="l00181"></a>00181 
<a name="l00182"></a>00182         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> != 0x2050 || phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> &gt;= 6) {
<a name="l00183"></a>00183                 <span class="comment">/* We do not need the workaround. */</span>
<a name="l00184"></a>00184                 <span class="keywordflow">return</span>;
<a name="l00185"></a>00185         }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187         <span class="keywordflow">if</span> (channel &lt;= 10) {
<a name="l00188"></a>00188                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a881966bd6256b2cdcbdf5c76e2249456">B43_MMIO_CHANNEL</a>,
<a name="l00189"></a>00189                             <a class="code" href="phy__g_8c.html#acb3b7edd4a4c7aa7a635ee4812fd971b">channel2freq_bg</a>(channel + 4));
<a name="l00190"></a>00190         } <span class="keywordflow">else</span> {
<a name="l00191"></a>00191                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a881966bd6256b2cdcbdf5c76e2249456">B43_MMIO_CHANNEL</a>, <a class="code" href="phy__g_8c.html#acb3b7edd4a4c7aa7a635ee4812fd971b">channel2freq_bg</a>(1));
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193         msleep(1);
<a name="l00194"></a>00194         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a881966bd6256b2cdcbdf5c76e2249456">B43_MMIO_CHANNEL</a>, <a class="code" href="phy__g_8c.html#acb3b7edd4a4c7aa7a635ee4812fd971b">channel2freq_bg</a>(channel));
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="comment">/* Set the baseband attenuation value on chip. */</span>
<a name="l00198"></a><a class="code" href="phy__g_8h.html#a07f4d4a279fc43639adf2fe3e9e993d9">00198</a> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a07f4d4a279fc43639adf2fe3e9e993d9">b43_gphy_set_baseband_attenuation</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l00199"></a>00199                                        u16 baseband_attenuation)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> == 0) {
<a name="l00204"></a>00204                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a1c562314febbe4c4477d45c7ee89521e">B43_MMIO_PHY0</a>, (<a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a1c562314febbe4c4477d45c7ee89521e">B43_MMIO_PHY0</a>)
<a name="l00205"></a>00205                                                  &amp; 0xFFF0) |
<a name="l00206"></a>00206                             baseband_attenuation);
<a name="l00207"></a>00207         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> &gt; 1) {
<a name="l00208"></a>00208                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__g_8h.html#a8a4c2b657dd8831113947426ecb8988f">B43_PHY_DACCTL</a>, 0xFFC3, (baseband_attenuation &lt;&lt; 2));
<a name="l00209"></a>00209         } <span class="keywordflow">else</span> {
<a name="l00210"></a>00210                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__g_8h.html#a8a4c2b657dd8831113947426ecb8988f">B43_PHY_DACCTL</a>, 0xFF87, (baseband_attenuation &lt;&lt; 3));
<a name="l00211"></a>00211         }
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <span class="comment">/* Adjust the transmission power output (G-PHY) */</span>
<a name="l00215"></a><a class="code" href="phy__g_8c.html#a0e0f5052d0931d6fb44784874cc9235a">00215</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a0e0f5052d0931d6fb44784874cc9235a">b43_set_txpower_g</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l00216"></a>00216                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structb43__bbatt.html">b43_bbatt</a> *bbatt,
<a name="l00217"></a>00217                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structb43__rfatt.html">b43_rfatt</a> *rfatt, u8 tx_control)
<a name="l00218"></a>00218 {
<a name="l00219"></a>00219         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00220"></a>00220         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l00221"></a>00221         <span class="keyword">struct </span><a class="code" href="structb43__txpower__lo__control.html">b43_txpower_lo_control</a> *lo = gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>;
<a name="l00222"></a>00222         u16 bb, rf;
<a name="l00223"></a>00223         u16 <a class="code" href="structb43__txpower__lo__control.html#a4490f98b26e1acd94b828cd7c7ae9851">tx_bias</a>, <a class="code" href="structb43__txpower__lo__control.html#a749d31d68a3088e0fb913dbdfbc2cd76">tx_magn</a>;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225         bb = bbatt-&gt;<a class="code" href="structb43__bbatt.html#afb22eb36d414900b27a1cea58718e822">att</a>;
<a name="l00226"></a>00226         rf = rfatt-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a>;
<a name="l00227"></a>00227         tx_bias = lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#a4490f98b26e1acd94b828cd7c7ae9851">tx_bias</a>;
<a name="l00228"></a>00228         tx_magn = lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#a749d31d68a3088e0fb913dbdfbc2cd76">tx_magn</a>;
<a name="l00229"></a>00229         <span class="keywordflow">if</span> (unlikely(tx_bias == 0xFF))
<a name="l00230"></a>00230                 tx_bias = 0;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         <span class="comment">/* Save the values for later. Use memmove, because it&#39;s valid</span>
<a name="l00233"></a>00233 <span class="comment">         * to pass &amp;gphy-&gt;rfatt as rfatt pointer argument. Same for bbatt. */</span>
<a name="l00234"></a>00234         gphy-&gt;<a class="code" href="structb43__phy__g.html#a517345f9708b14fe2280a1fe5fe69b2a">tx_control</a> = tx_control;
<a name="l00235"></a>00235         memmove(&amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>, rfatt, <span class="keyword">sizeof</span>(*rfatt));
<a name="l00236"></a>00236         gphy-&gt;<a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>.<a class="code" href="structb43__rfatt.html#a247ff931a7f936bed5cfb990f3d8ab89">with_padmix</a> = !!(tx_control &amp; <a class="code" href="phy__g_8h.html#a8d9d46847cde6629e925371d02900e1c">B43_TXCTL_TXMIX</a>);
<a name="l00237"></a>00237         memmove(&amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>, bbatt, <span class="keyword">sizeof</span>(*bbatt));
<a name="l00238"></a>00238 
<a name="l00239"></a>00239         <span class="keywordflow">if</span> (<a class="code" href="debugfs_8c.html#a2d8cac4c4fae4116d2248d9b5c3a782b">b43_debug</a>(dev, <a class="code" href="debugfs_8h.html#a9ce3904e91efa8e7a9663235bd3257f4aca6890bc7b28f7933c0b8bde140c92ba">B43_DBG_XMITPOWER</a>)) {
<a name="l00240"></a>00240                 <a class="code" href="main_8c.html#ac3164e7d1ba2fbd05fce755cdb232382">b43dbg</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>, <span class="stringliteral">&quot;Tuning TX-power to bbatt(%u), &quot;</span>
<a name="l00241"></a>00241                        <span class="stringliteral">&quot;rfatt(%u), tx_control(0x%02X), &quot;</span>
<a name="l00242"></a>00242                        <span class="stringliteral">&quot;tx_bias(0x%02X), tx_magn(0x%02X)\n&quot;</span>,
<a name="l00243"></a>00243                        bb, rf, tx_control, tx_bias, tx_magn);
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         <a class="code" href="phy__g_8c.html#a07f4d4a279fc43639adf2fe3e9e993d9">b43_gphy_set_baseband_attenuation</a>(dev, bb);
<a name="l00247"></a>00247         <a class="code" href="main_8c.html#a28f7e4e0e4386f41d555003b22b2775f">b43_shm_write16</a>(dev, <a class="code" href="b43_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf1176fce48515a37f9be16ac9d71f782">B43_SHM_SHARED</a>, <a class="code" href="b43_8h.html#a7055e2d8abbab19a447d8ec41d48a423">B43_SHM_SH_RFATT</a>, rf);
<a name="l00248"></a>00248         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050 &amp;&amp; phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l00249"></a>00249                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x43,
<a name="l00250"></a>00250                                   (rf &amp; 0x000F) | (tx_control &amp; 0x0070));
<a name="l00251"></a>00251         } <span class="keywordflow">else</span> {
<a name="l00252"></a>00252                 <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(dev, 0x43, 0xFFF0, (rf &amp; 0x000F));
<a name="l00253"></a>00253                 <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(dev, 0x52, ~0x0070, (tx_control &amp; 0x0070));
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255         <span class="keywordflow">if</span> (<a class="code" href="phy__g_8h.html#a16f2a298c5abaa99472f056b83895b9a">has_tx_magnification</a>(phy)) {
<a name="l00256"></a>00256                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x52, tx_magn | tx_bias);
<a name="l00257"></a>00257         } <span class="keywordflow">else</span> {
<a name="l00258"></a>00258                 <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(dev, 0x52, 0xFFF0, (tx_bias &amp; 0x000F));
<a name="l00259"></a>00259         }
<a name="l00260"></a>00260         <a class="code" href="lo_8c.html#a32522f98b89628f5b532cdb56c65b123">b43_lo_g_adjust</a>(dev);
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="comment">/* GPHY_TSSI_Power_Lookup_Table_Init */</span>
<a name="l00264"></a><a class="code" href="phy__g_8c.html#a3ff11c8c6d436ed712638390c7fa3009">00264</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a3ff11c8c6d436ed712638390c7fa3009">b43_gphy_tssi_power_lt_init</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l00267"></a>00267         <span class="keywordtype">int</span> i;
<a name="l00268"></a>00268         u16 value;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270         <span class="keywordflow">for</span> (i = 0; i &lt; 32; i++)
<a name="l00271"></a>00271                 <a class="code" href="phy__a_8h.html#a53b0f35cb22775c784e911c203b52482">b43_ofdmtab_write16</a>(dev, 0x3C20, i, gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a>[i]);
<a name="l00272"></a>00272         <span class="keywordflow">for</span> (i = 32; i &lt; 64; i++)
<a name="l00273"></a>00273                 <a class="code" href="phy__a_8h.html#a53b0f35cb22775c784e911c203b52482">b43_ofdmtab_write16</a>(dev, 0x3C00, i - 32, gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a>[i]);
<a name="l00274"></a>00274         <span class="keywordflow">for</span> (i = 0; i &lt; 64; i += 2) {
<a name="l00275"></a>00275                 value = (u16) gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a>[i];
<a name="l00276"></a>00276                 value |= ((u16) gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a>[i + 1]) &lt;&lt; 8;
<a name="l00277"></a>00277                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x380 + (i / 2), value);
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279 }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="comment">/* GPHY_Gain_Lookup_Table_Init */</span>
<a name="l00282"></a><a class="code" href="phy__g_8c.html#a655d85bd98fb83256f526345b6532032">00282</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a655d85bd98fb83256f526345b6532032">b43_gphy_gain_lt_init</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00285"></a>00285         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l00286"></a>00286         <span class="keyword">struct </span><a class="code" href="structb43__txpower__lo__control.html">b43_txpower_lo_control</a> *lo = gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>;
<a name="l00287"></a>00287         u16 nr_written = 0;
<a name="l00288"></a>00288         u16 tmp;
<a name="l00289"></a>00289         u8 rf, bb;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         <span class="keywordflow">for</span> (rf = 0; rf &lt; lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#a5a18a32a9ba71f3860873d3a3a9855fd">rfatt_list</a>.<a class="code" href="structb43__rfatt__list.html#a6a7ec1fbfc1c48c119a44e296701cc5b">len</a>; rf++) {
<a name="l00292"></a>00292                 <span class="keywordflow">for</span> (bb = 0; bb &lt; lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#ac465063ced589ab08a38ebd3343d1cca">bbatt_list</a>.<a class="code" href="structb43__bbatt__list.html#acf1437af3f2bf1a1293b87279f9ff10a">len</a>; bb++) {
<a name="l00293"></a>00293                         <span class="keywordflow">if</span> (nr_written &gt;= 0x40)
<a name="l00294"></a>00294                                 <span class="keywordflow">return</span>;
<a name="l00295"></a>00295                         tmp = lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#ac465063ced589ab08a38ebd3343d1cca">bbatt_list</a>.<a class="code" href="structb43__bbatt__list.html#a4180f38e8caabceb910f6e44ca7bd294">list</a>[bb].<a class="code" href="structb43__bbatt.html#afb22eb36d414900b27a1cea58718e822">att</a>;
<a name="l00296"></a>00296                         tmp &lt;&lt;= 8;
<a name="l00297"></a>00297                         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8)
<a name="l00298"></a>00298                                 tmp |= 0x50;
<a name="l00299"></a>00299                         <span class="keywordflow">else</span>
<a name="l00300"></a>00300                                 tmp |= 0x40;
<a name="l00301"></a>00301                         tmp |= lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#a5a18a32a9ba71f3860873d3a3a9855fd">rfatt_list</a>.<a class="code" href="structb43__rfatt__list.html#a6e7e95d6ffc0c55f4c6a8b104ae3fa29">list</a>[rf].<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a>;
<a name="l00302"></a>00302                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x3C0 + nr_written, tmp);
<a name="l00303"></a>00303                         nr_written++;
<a name="l00304"></a>00304                 }
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 
<a name="l00308"></a><a class="code" href="phy__g_8c.html#ab57927fd6c0c7efa8408634ffb1baca1">00308</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#ab57927fd6c0c7efa8408634ffb1baca1">b43_set_all_gains</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l00309"></a>00309                               s16 first, s16 second, s16 third)
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00312"></a>00312         u16 i;
<a name="l00313"></a>00313         u16 start = 0x08, end = 0x18;
<a name="l00314"></a>00314         u16 tmp;
<a name="l00315"></a>00315         u16 table;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt;= 1) {
<a name="l00318"></a>00318                 start = 0x10;
<a name="l00319"></a>00319                 end = 0x20;
<a name="l00320"></a>00320         }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322         table = <a class="code" href="phy__a_8h.html#a4391c96f974218b635992dc9ba418675">B43_OFDMTAB_GAINX</a>;
<a name="l00323"></a>00323         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt;= 1)
<a name="l00324"></a>00324                 table = <a class="code" href="phy__a_8h.html#a1c0ce405fa9304d6f91f875582e838e0">B43_OFDMTAB_GAINX_R1</a>;
<a name="l00325"></a>00325         <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++)
<a name="l00326"></a>00326                 <a class="code" href="phy__a_8h.html#a53b0f35cb22775c784e911c203b52482">b43_ofdmtab_write16</a>(dev, table, i, first);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="keywordflow">for</span> (i = start; i &lt; end; i++)
<a name="l00329"></a>00329                 <a class="code" href="phy__a_8h.html#a53b0f35cb22775c784e911c203b52482">b43_ofdmtab_write16</a>(dev, table, i, second);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <span class="keywordflow">if</span> (third != -1) {
<a name="l00332"></a>00332                 tmp = ((u16) third &lt;&lt; 14) | ((u16) third &lt;&lt; 6);
<a name="l00333"></a>00333                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A0, 0xBFBF, tmp);
<a name="l00334"></a>00334                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A1, 0xBFBF, tmp);
<a name="l00335"></a>00335                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A2, 0xBFBF, tmp);
<a name="l00336"></a>00336         }
<a name="l00337"></a>00337         <a class="code" href="main_8c.html#a81f3a88ca0158a67ecadf6f38d9f6c4c">b43_dummy_transmission</a>(dev, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l00338"></a>00338 }
<a name="l00339"></a>00339 
<a name="l00340"></a><a class="code" href="phy__g_8c.html#a0ae2d386ab09838d38248475ab50acf8">00340</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a0ae2d386ab09838d38248475ab50acf8">b43_set_original_gains</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00341"></a>00341 {
<a name="l00342"></a>00342         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00343"></a>00343         u16 i, tmp;
<a name="l00344"></a>00344         u16 table;
<a name="l00345"></a>00345         u16 start = 0x0008, end = 0x0018;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt;= 1) {
<a name="l00348"></a>00348                 start = 0x0010;
<a name="l00349"></a>00349                 end = 0x0020;
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         table = <a class="code" href="phy__a_8h.html#a4391c96f974218b635992dc9ba418675">B43_OFDMTAB_GAINX</a>;
<a name="l00353"></a>00353         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt;= 1)
<a name="l00354"></a>00354                 table = <a class="code" href="phy__a_8h.html#a1c0ce405fa9304d6f91f875582e838e0">B43_OFDMTAB_GAINX_R1</a>;
<a name="l00355"></a>00355         <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
<a name="l00356"></a>00356                 tmp = (i &amp; 0xFFFC);
<a name="l00357"></a>00357                 tmp |= (i &amp; 0x0001) &lt;&lt; 1;
<a name="l00358"></a>00358                 tmp |= (i &amp; 0x0002) &gt;&gt; 1;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360                 <a class="code" href="phy__a_8h.html#a53b0f35cb22775c784e911c203b52482">b43_ofdmtab_write16</a>(dev, table, i, tmp);
<a name="l00361"></a>00361         }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="keywordflow">for</span> (i = start; i &lt; end; i++)
<a name="l00364"></a>00364                 <a class="code" href="phy__a_8h.html#a53b0f35cb22775c784e911c203b52482">b43_ofdmtab_write16</a>(dev, table, i, i - start);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A0, 0xBFBF, 0x4040);
<a name="l00367"></a>00367         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A1, 0xBFBF, 0x4040);
<a name="l00368"></a>00368         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A2, 0xBFBF, 0x4000);
<a name="l00369"></a>00369         <a class="code" href="main_8c.html#a81f3a88ca0158a67ecadf6f38d9f6c4c">b43_dummy_transmission</a>(dev, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 <span class="comment">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<a name="l00373"></a><a class="code" href="phy__g_8c.html#a9e4e4dcc4f394f6100b0a9636f59e698">00373</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a9e4e4dcc4f394f6100b0a9636f59e698">b43_nrssi_hw_write</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 offset, s16 val)
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="b43_8h.html#a5f94be01f41b4dfabd8096b4d330fa44">B43_PHY_NRSSILT_CTRL</a>, offset);
<a name="l00376"></a>00376         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="b43_8h.html#acf630329579268b5aec1df4c15fa7989">B43_PHY_NRSSILT_DATA</a>, (u16) val);
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="comment">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<a name="l00380"></a><a class="code" href="phy__g_8c.html#a5aec458dd4fe4ecd0ae90838e384315e">00380</a> <span class="keyword">static</span> s16 <a class="code" href="phy__g_8c.html#a5aec458dd4fe4ecd0ae90838e384315e">b43_nrssi_hw_read</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 offset)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382         u16 val;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="b43_8h.html#a5f94be01f41b4dfabd8096b4d330fa44">B43_PHY_NRSSILT_CTRL</a>, offset);
<a name="l00385"></a>00385         val = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="b43_8h.html#acf630329579268b5aec1df4c15fa7989">B43_PHY_NRSSILT_DATA</a>);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387         <span class="keywordflow">return</span> (s16) val;
<a name="l00388"></a>00388 }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390 <span class="comment">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<a name="l00391"></a><a class="code" href="phy__g_8c.html#af288eaada6243d702227f01aa993d37e">00391</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#af288eaada6243d702227f01aa993d37e">b43_nrssi_hw_update</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 val)
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393         u16 i;
<a name="l00394"></a>00394         s16 tmp;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396         <span class="keywordflow">for</span> (i = 0; i &lt; 64; i++) {
<a name="l00397"></a>00397                 tmp = <a class="code" href="phy__g_8c.html#a5aec458dd4fe4ecd0ae90838e384315e">b43_nrssi_hw_read</a>(dev, i);
<a name="l00398"></a>00398                 tmp -= val;
<a name="l00399"></a>00399                 tmp = clamp_val(tmp, -32, 31);
<a name="l00400"></a>00400                 <a class="code" href="phy__g_8c.html#a9e4e4dcc4f394f6100b0a9636f59e698">b43_nrssi_hw_write</a>(dev, i, tmp);
<a name="l00401"></a>00401         }
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="comment">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<a name="l00405"></a><a class="code" href="phy__g_8c.html#ada96c261e7696f5b773fa2f610afc9e8">00405</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#ada96c261e7696f5b773fa2f610afc9e8">b43_nrssi_mem_update</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00406"></a>00406 {
<a name="l00407"></a>00407         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l00408"></a>00408         s16 i, delta;
<a name="l00409"></a>00409         s32 tmp;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         delta = 0x1F - gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[0];
<a name="l00412"></a>00412         <span class="keywordflow">for</span> (i = 0; i &lt; 64; i++) {
<a name="l00413"></a>00413                 tmp = (i - delta) * gphy-&gt;<a class="code" href="structb43__phy__g.html#aae7b114d268d8dc229601b5f5f7e6b29">nrssislope</a>;
<a name="l00414"></a>00414                 tmp /= 0x10000;
<a name="l00415"></a>00415                 tmp += 0x3A;
<a name="l00416"></a>00416                 tmp = clamp_val(tmp, 0, 0x3F);
<a name="l00417"></a>00417                 gphy-&gt;<a class="code" href="structb43__phy__g.html#aa646acd32e5858c3977a27719f82b1a4">nrssi_lt</a>[i] = tmp;
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419 }
<a name="l00420"></a>00420 
<a name="l00421"></a><a class="code" href="phy__g_8c.html#ada43cf18d377a15f122cce14ed6402f2">00421</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#ada43cf18d377a15f122cce14ed6402f2">b43_calc_nrssi_offset</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00422"></a>00422 {
<a name="l00423"></a>00423         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00424"></a>00424         u16 backup[20] = { 0 };
<a name="l00425"></a>00425         s16 v47F;
<a name="l00426"></a>00426         u16 i;
<a name="l00427"></a>00427         u16 saved = 0xFFFF;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429         backup[0] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0001);
<a name="l00430"></a>00430         backup[1] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0811);
<a name="l00431"></a>00431         backup[2] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0812);
<a name="l00432"></a>00432         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {    <span class="comment">/* Not in specs, but needed to prevent PPC machine check */</span>
<a name="l00433"></a>00433                 backup[3] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0814);
<a name="l00434"></a>00434                 backup[4] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0815);
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436         backup[5] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x005A);
<a name="l00437"></a>00437         backup[6] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0059);
<a name="l00438"></a>00438         backup[7] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0058);
<a name="l00439"></a>00439         backup[8] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x000A);
<a name="l00440"></a>00440         backup[9] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0003);
<a name="l00441"></a>00441         backup[10] = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x007A);
<a name="l00442"></a>00442         backup[11] = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x0043);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0429, 0x7FFF);
<a name="l00445"></a>00445         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0001, 0x3FFF, 0x4000);
<a name="l00446"></a>00446         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0811, 0x000C);
<a name="l00447"></a>00447         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0812, 0xFFF3, 0x0004);
<a name="l00448"></a>00448         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0802, ~(0x1 | 0x2));
<a name="l00449"></a>00449         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 6) {
<a name="l00450"></a>00450                 backup[12] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x002E);
<a name="l00451"></a>00451                 backup[13] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x002F);
<a name="l00452"></a>00452                 backup[14] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x080F);
<a name="l00453"></a>00453                 backup[15] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0810);
<a name="l00454"></a>00454                 backup[16] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0801);
<a name="l00455"></a>00455                 backup[17] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0060);
<a name="l00456"></a>00456                 backup[18] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0014);
<a name="l00457"></a>00457                 backup[19] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0478);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002E, 0);
<a name="l00460"></a>00460                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002F, 0);
<a name="l00461"></a>00461                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x080F, 0);
<a name="l00462"></a>00462                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0810, 0);
<a name="l00463"></a>00463                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0478, 0x0100);
<a name="l00464"></a>00464                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0801, 0x0040);
<a name="l00465"></a>00465                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0060, 0x0040);
<a name="l00466"></a>00466                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0014, 0x0200);
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468         <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x0070);
<a name="l00469"></a>00469         <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x0080);
<a name="l00470"></a>00470         udelay(30);
<a name="l00471"></a>00471 
<a name="l00472"></a>00472         v47F = (s16) ((<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x047F) &gt;&gt; 8) &amp; 0x003F);
<a name="l00473"></a>00473         <span class="keywordflow">if</span> (v47F &gt;= 0x20)
<a name="l00474"></a>00474                 v47F -= 0x40;
<a name="l00475"></a>00475         <span class="keywordflow">if</span> (v47F == 31) {
<a name="l00476"></a>00476                 <span class="keywordflow">for</span> (i = 7; i &gt;= 4; i--) {
<a name="l00477"></a>00477                         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x007B, i);
<a name="l00478"></a>00478                         udelay(20);
<a name="l00479"></a>00479                         v47F =
<a name="l00480"></a>00480                             (s16) ((<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x047F) &gt;&gt; 8) &amp; 0x003F);
<a name="l00481"></a>00481                         <span class="keywordflow">if</span> (v47F &gt;= 0x20)
<a name="l00482"></a>00482                                 v47F -= 0x40;
<a name="l00483"></a>00483                         <span class="keywordflow">if</span> (v47F &lt; 31 &amp;&amp; saved == 0xFFFF)
<a name="l00484"></a>00484                                 saved = i;
<a name="l00485"></a>00485                 }
<a name="l00486"></a>00486                 <span class="keywordflow">if</span> (saved == 0xFFFF)
<a name="l00487"></a>00487                         saved = 4;
<a name="l00488"></a>00488         } <span class="keywordflow">else</span> {
<a name="l00489"></a>00489                 <a class="code" href="phy__common_8c.html#aa0d4025c0760e0d0bd1529c62d1fff87">b43_radio_mask</a>(dev, 0x007A, 0x007F);
<a name="l00490"></a>00490                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {    <span class="comment">/* Not in specs, but needed to prevent PPC machine check */</span>
<a name="l00491"></a>00491                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0814, 0x0001);
<a name="l00492"></a>00492                         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0815, 0xFFFE);
<a name="l00493"></a>00493                 }
<a name="l00494"></a>00494                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0811, 0x000C);
<a name="l00495"></a>00495                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0812, 0x000C);
<a name="l00496"></a>00496                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0811, 0x0030);
<a name="l00497"></a>00497                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0812, 0x0030);
<a name="l00498"></a>00498                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x005A, 0x0480);
<a name="l00499"></a>00499                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0059, 0x0810);
<a name="l00500"></a>00500                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0058, 0x000D);
<a name="l00501"></a>00501                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 0) {
<a name="l00502"></a>00502                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0003, 0x0122);
<a name="l00503"></a>00503                 } <span class="keywordflow">else</span> {
<a name="l00504"></a>00504                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x000A, 0x2000);
<a name="l00505"></a>00505                 }
<a name="l00506"></a>00506                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {    <span class="comment">/* Not in specs, but needed to prevent PPC machine check */</span>
<a name="l00507"></a>00507                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0814, 0x0004);
<a name="l00508"></a>00508                         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0815, 0xFFFB);
<a name="l00509"></a>00509                 }
<a name="l00510"></a>00510                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0003, 0xFF9F, 0x0040);
<a name="l00511"></a>00511                 <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x000F);
<a name="l00512"></a>00512                 <a class="code" href="phy__g_8c.html#ab57927fd6c0c7efa8408634ffb1baca1">b43_set_all_gains</a>(dev, 3, 0, 1);
<a name="l00513"></a>00513                 <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(dev, 0x0043, 0x00F0, 0x000F);
<a name="l00514"></a>00514                 udelay(30);
<a name="l00515"></a>00515                 v47F = (s16) ((<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x047F) &gt;&gt; 8) &amp; 0x003F);
<a name="l00516"></a>00516                 <span class="keywordflow">if</span> (v47F &gt;= 0x20)
<a name="l00517"></a>00517                         v47F -= 0x40;
<a name="l00518"></a>00518                 <span class="keywordflow">if</span> (v47F == -32) {
<a name="l00519"></a>00519                         <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
<a name="l00520"></a>00520                                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x007B, i);
<a name="l00521"></a>00521                                 udelay(20);
<a name="l00522"></a>00522                                 v47F =
<a name="l00523"></a>00523                                     (s16) ((<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x047F) &gt;&gt; 8) &amp;
<a name="l00524"></a>00524                                            0x003F);
<a name="l00525"></a>00525                                 <span class="keywordflow">if</span> (v47F &gt;= 0x20)
<a name="l00526"></a>00526                                         v47F -= 0x40;
<a name="l00527"></a>00527                                 <span class="keywordflow">if</span> (v47F &gt; -31 &amp;&amp; saved == 0xFFFF)
<a name="l00528"></a>00528                                         saved = i;
<a name="l00529"></a>00529                         }
<a name="l00530"></a>00530                         <span class="keywordflow">if</span> (saved == 0xFFFF)
<a name="l00531"></a>00531                                 saved = 3;
<a name="l00532"></a>00532                 } <span class="keywordflow">else</span>
<a name="l00533"></a>00533                         saved = 0;
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x007B, saved);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 6) {
<a name="l00538"></a>00538                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002E, backup[12]);
<a name="l00539"></a>00539                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002F, backup[13]);
<a name="l00540"></a>00540                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x080F, backup[14]);
<a name="l00541"></a>00541                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0810, backup[15]);
<a name="l00542"></a>00542         }
<a name="l00543"></a>00543         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {    <span class="comment">/* Not in specs, but needed to prevent PPC machine check */</span>
<a name="l00544"></a>00544                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0814, backup[3]);
<a name="l00545"></a>00545                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0815, backup[4]);
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x005A, backup[5]);
<a name="l00548"></a>00548         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0059, backup[6]);
<a name="l00549"></a>00549         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0058, backup[7]);
<a name="l00550"></a>00550         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x000A, backup[8]);
<a name="l00551"></a>00551         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0003, backup[9]);
<a name="l00552"></a>00552         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0043, backup[11]);
<a name="l00553"></a>00553         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x007A, backup[10]);
<a name="l00554"></a>00554         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0802, <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0802) | 0x1 | 0x2);
<a name="l00555"></a>00555         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0429, 0x8000);
<a name="l00556"></a>00556         <a class="code" href="phy__g_8c.html#a0ae2d386ab09838d38248475ab50acf8">b43_set_original_gains</a>(dev);
<a name="l00557"></a>00557         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 6) {
<a name="l00558"></a>00558                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0801, backup[16]);
<a name="l00559"></a>00559                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0060, backup[17]);
<a name="l00560"></a>00560                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0014, backup[18]);
<a name="l00561"></a>00561                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0478, backup[19]);
<a name="l00562"></a>00562         }
<a name="l00563"></a>00563         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0001, backup[0]);
<a name="l00564"></a>00564         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0812, backup[2]);
<a name="l00565"></a>00565         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0811, backup[1]);
<a name="l00566"></a>00566 }
<a name="l00567"></a>00567 
<a name="l00568"></a><a class="code" href="phy__g_8c.html#ae11eeb69eea9f510730039dd9a623140">00568</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#ae11eeb69eea9f510730039dd9a623140">b43_calc_nrssi_slope</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00569"></a>00569 {
<a name="l00570"></a>00570         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00571"></a>00571         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l00572"></a>00572         u16 backup[18] = { 0 };
<a name="l00573"></a>00573         u16 tmp;
<a name="l00574"></a>00574         s16 nrssi0, nrssi1;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> != <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> &gt;= 9)
<a name="l00579"></a>00579                 <span class="keywordflow">return</span>;
<a name="l00580"></a>00580         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8)
<a name="l00581"></a>00581                 <a class="code" href="phy__g_8c.html#ada43cf18d377a15f122cce14ed6402f2">b43_calc_nrssi_offset</a>(dev);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>, 0x7FFF);
<a name="l00584"></a>00584         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0802, 0xFFFC);
<a name="l00585"></a>00585         backup[7] = <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, 0x03E2);
<a name="l00586"></a>00586         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x03E2, <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, 0x03E2) | 0x8000);
<a name="l00587"></a>00587         backup[0] = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x007A);
<a name="l00588"></a>00588         backup[1] = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x0052);
<a name="l00589"></a>00589         backup[2] = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x0043);
<a name="l00590"></a>00590         backup[3] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0015);
<a name="l00591"></a>00591         backup[4] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x005A);
<a name="l00592"></a>00592         backup[5] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0059);
<a name="l00593"></a>00593         backup[6] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0058);
<a name="l00594"></a>00594         backup[8] = <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, 0x03E6);
<a name="l00595"></a>00595         backup[9] = <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>);
<a name="l00596"></a>00596         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 3) {
<a name="l00597"></a>00597                 backup[10] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x002E);
<a name="l00598"></a>00598                 backup[11] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x002F);
<a name="l00599"></a>00599                 backup[12] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x080F);
<a name="l00600"></a>00600                 backup[13] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="b43_8h.html#a8a6398d85e31927f9d6bbfdac3ef3bb7">B43_PHY_G_LO_CONTROL</a>);
<a name="l00601"></a>00601                 backup[14] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0801);
<a name="l00602"></a>00602                 backup[15] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0060);
<a name="l00603"></a>00603                 backup[16] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0014);
<a name="l00604"></a>00604                 backup[17] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0478);
<a name="l00605"></a>00605                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002E, 0);
<a name="l00606"></a>00606                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="b43_8h.html#a8a6398d85e31927f9d6bbfdac3ef3bb7">B43_PHY_G_LO_CONTROL</a>, 0);
<a name="l00607"></a>00607                 <span class="keywordflow">switch</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a>) {
<a name="l00608"></a>00608                 <span class="keywordflow">case</span> 4:
<a name="l00609"></a>00609                 <span class="keywordflow">case</span> 6:
<a name="l00610"></a>00610                 <span class="keywordflow">case</span> 7:
<a name="l00611"></a>00611                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0478, 0x0100);
<a name="l00612"></a>00612                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0801, 0x0040);
<a name="l00613"></a>00613                         <span class="keywordflow">break</span>;
<a name="l00614"></a>00614                 <span class="keywordflow">case</span> 3:
<a name="l00615"></a>00615                 <span class="keywordflow">case</span> 5:
<a name="l00616"></a>00616                         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0801, 0xFFBF);
<a name="l00617"></a>00617                         <span class="keywordflow">break</span>;
<a name="l00618"></a>00618                 }
<a name="l00619"></a>00619                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0060, 0x0040);
<a name="l00620"></a>00620                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0014, 0x0200);
<a name="l00621"></a>00621         }
<a name="l00622"></a>00622         <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x0070);
<a name="l00623"></a>00623         <a class="code" href="phy__g_8c.html#ab57927fd6c0c7efa8408634ffb1baca1">b43_set_all_gains</a>(dev, 0, 8, 0);
<a name="l00624"></a>00624         <a class="code" href="phy__common_8c.html#aa0d4025c0760e0d0bd1529c62d1fff87">b43_radio_mask</a>(dev, 0x007A, 0x00F7);
<a name="l00625"></a>00625         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l00626"></a>00626                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0811, 0xFFCF, 0x0030);
<a name="l00627"></a>00627                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0812, 0xFFCF, 0x0010);
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629         <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x0080);
<a name="l00630"></a>00630         udelay(20);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632         nrssi0 = (s16) ((<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x047F) &gt;&gt; 8) &amp; 0x003F);
<a name="l00633"></a>00633         <span class="keywordflow">if</span> (nrssi0 &gt;= 0x0020)
<a name="l00634"></a>00634                 nrssi0 -= 0x0040;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         <a class="code" href="phy__common_8c.html#aa0d4025c0760e0d0bd1529c62d1fff87">b43_radio_mask</a>(dev, 0x007A, 0x007F);
<a name="l00637"></a>00637         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l00638"></a>00638                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0003, 0xFF9F, 0x0040);
<a name="l00639"></a>00639         }
<a name="l00640"></a>00640 
<a name="l00641"></a>00641         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>,
<a name="l00642"></a>00642                     <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>)
<a name="l00643"></a>00643                     | 0x2000);
<a name="l00644"></a>00644         <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x000F);
<a name="l00645"></a>00645         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0015, 0xF330);
<a name="l00646"></a>00646         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l00647"></a>00647                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0812, 0xFFCF, 0x0020);
<a name="l00648"></a>00648                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0811, 0xFFCF, 0x0020);
<a name="l00649"></a>00649         }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651         <a class="code" href="phy__g_8c.html#ab57927fd6c0c7efa8408634ffb1baca1">b43_set_all_gains</a>(dev, 3, 0, 1);
<a name="l00652"></a>00652         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l00653"></a>00653                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0043, 0x001F);
<a name="l00654"></a>00654         } <span class="keywordflow">else</span> {
<a name="l00655"></a>00655                 tmp = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x0052) &amp; 0xFF0F;
<a name="l00656"></a>00656                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0052, tmp | 0x0060);
<a name="l00657"></a>00657                 tmp = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x0043) &amp; 0xFFF0;
<a name="l00658"></a>00658                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0043, tmp | 0x0009);
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x005A, 0x0480);
<a name="l00661"></a>00661         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0059, 0x0810);
<a name="l00662"></a>00662         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0058, 0x000D);
<a name="l00663"></a>00663         udelay(20);
<a name="l00664"></a>00664         nrssi1 = (s16) ((<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x047F) &gt;&gt; 8) &amp; 0x003F);
<a name="l00665"></a>00665         <span class="keywordflow">if</span> (nrssi1 &gt;= 0x0020)
<a name="l00666"></a>00666                 nrssi1 -= 0x0040;
<a name="l00667"></a>00667         <span class="keywordflow">if</span> (nrssi0 == nrssi1)
<a name="l00668"></a>00668                 gphy-&gt;<a class="code" href="structb43__phy__g.html#aae7b114d268d8dc229601b5f5f7e6b29">nrssislope</a> = 0x00010000;
<a name="l00669"></a>00669         <span class="keywordflow">else</span>
<a name="l00670"></a>00670                 gphy-&gt;<a class="code" href="structb43__phy__g.html#aae7b114d268d8dc229601b5f5f7e6b29">nrssislope</a> = 0x00400000 / (nrssi0 - nrssi1);
<a name="l00671"></a>00671         <span class="keywordflow">if</span> (nrssi0 &gt;= -4) {
<a name="l00672"></a>00672                 gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[0] = nrssi1;
<a name="l00673"></a>00673                 gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[1] = nrssi0;
<a name="l00674"></a>00674         }
<a name="l00675"></a>00675         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 3) {
<a name="l00676"></a>00676                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002E, backup[10]);
<a name="l00677"></a>00677                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002F, backup[11]);
<a name="l00678"></a>00678                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x080F, backup[12]);
<a name="l00679"></a>00679                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="b43_8h.html#a8a6398d85e31927f9d6bbfdac3ef3bb7">B43_PHY_G_LO_CONTROL</a>, backup[13]);
<a name="l00680"></a>00680         }
<a name="l00681"></a>00681         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l00682"></a>00682                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0812, 0xFFCF);
<a name="l00683"></a>00683                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0811, 0xFFCF);
<a name="l00684"></a>00684         }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x007A, backup[0]);
<a name="l00687"></a>00687         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0052, backup[1]);
<a name="l00688"></a>00688         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0043, backup[2]);
<a name="l00689"></a>00689         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x03E2, backup[7]);
<a name="l00690"></a>00690         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x03E6, backup[8]);
<a name="l00691"></a>00691         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>, backup[9]);
<a name="l00692"></a>00692         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0015, backup[3]);
<a name="l00693"></a>00693         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x005A, backup[4]);
<a name="l00694"></a>00694         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0059, backup[5]);
<a name="l00695"></a>00695         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0058, backup[6]);
<a name="l00696"></a>00696         <a class="code" href="phy__g_8c.html#a070256ea5337a006d3db2c1b097bd364">b43_synth_pu_workaround</a>(dev, phy-&gt;<a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a>);
<a name="l00697"></a>00697         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0802, (0x0001 | 0x0002));
<a name="l00698"></a>00698         <a class="code" href="phy__g_8c.html#a0ae2d386ab09838d38248475ab50acf8">b43_set_original_gains</a>(dev);
<a name="l00699"></a>00699         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>, 0x8000);
<a name="l00700"></a>00700         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 3) {
<a name="l00701"></a>00701                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0801, backup[14]);
<a name="l00702"></a>00702                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0060, backup[15]);
<a name="l00703"></a>00703                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0014, backup[16]);
<a name="l00704"></a>00704                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0478, backup[17]);
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706         <a class="code" href="phy__g_8c.html#ada96c261e7696f5b773fa2f610afc9e8">b43_nrssi_mem_update</a>(dev);
<a name="l00707"></a>00707         <a class="code" href="phy__g_8c.html#a0c473583d8f3c46e081b1bb3834fa909">b43_calc_nrssi_threshold</a>(dev);
<a name="l00708"></a>00708 }
<a name="l00709"></a>00709 
<a name="l00710"></a><a class="code" href="phy__g_8c.html#a0c473583d8f3c46e081b1bb3834fa909">00710</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a0c473583d8f3c46e081b1bb3834fa909">b43_calc_nrssi_threshold</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l00711"></a>00711 {
<a name="l00712"></a>00712         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00713"></a>00713         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l00714"></a>00714         s32 a, b;
<a name="l00715"></a>00715         s16 tmp16;
<a name="l00716"></a>00716         u16 tmp_u16;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> != <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720         <span class="keywordflow">if</span> (!phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> ||
<a name="l00721"></a>00721             !(dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;boardflags_lo &amp; <a class="code" href="b43_8h.html#aa3662813d12e20a94f8af57b16cb45b5">B43_BFL_RSSI</a>)) {
<a name="l00722"></a>00722                 tmp16 = <a class="code" href="phy__g_8c.html#a5aec458dd4fe4ecd0ae90838e384315e">b43_nrssi_hw_read</a>(dev, 0x20);
<a name="l00723"></a>00723                 <span class="keywordflow">if</span> (tmp16 &gt;= 0x20)
<a name="l00724"></a>00724                         tmp16 -= 0x40;
<a name="l00725"></a>00725                 <span class="keywordflow">if</span> (tmp16 &lt; 3) {
<a name="l00726"></a>00726                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x048A, 0xF000, 0x09EB);
<a name="l00727"></a>00727                 } <span class="keywordflow">else</span> {
<a name="l00728"></a>00728                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x048A, 0xF000, 0x0AED);
<a name="l00729"></a>00729                 }
<a name="l00730"></a>00730         } <span class="keywordflow">else</span> {
<a name="l00731"></a>00731                 <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#a8b5ca25c5979421db8a60d97d26d6716">interfmode</a> == <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a013300a08f3e3e4f4cc335ec14e62b9f">B43_INTERFMODE_NONWLAN</a>) {
<a name="l00732"></a>00732                         a = 0xE;
<a name="l00733"></a>00733                         b = 0xA;
<a name="l00734"></a>00734                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!gphy-&gt;<a class="code" href="structb43__phy__g.html#a039f294157f4707f4fabdca4c1721a04">aci_wlan_automatic</a> &amp;&amp; gphy-&gt;<a class="code" href="structb43__phy__g.html#a716086bdb0a4e341090388e3d92e2e0b">aci_enable</a>) {
<a name="l00735"></a>00735                         a = 0x13;
<a name="l00736"></a>00736                         b = 0x12;
<a name="l00737"></a>00737                 } <span class="keywordflow">else</span> {
<a name="l00738"></a>00738                         a = 0xE;
<a name="l00739"></a>00739                         b = 0x11;
<a name="l00740"></a>00740                 }
<a name="l00741"></a>00741 
<a name="l00742"></a>00742                 a = a * (gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[1] - gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[0]);
<a name="l00743"></a>00743                 a += (gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[0] &lt;&lt; 6);
<a name="l00744"></a>00744                 <span class="keywordflow">if</span> (a &lt; 32)
<a name="l00745"></a>00745                         a += 31;
<a name="l00746"></a>00746                 <span class="keywordflow">else</span>
<a name="l00747"></a>00747                         a += 32;
<a name="l00748"></a>00748                 a = a &gt;&gt; 6;
<a name="l00749"></a>00749                 a = clamp_val(a, -31, 31);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751                 b = b * (gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[1] - gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[0]);
<a name="l00752"></a>00752                 b += (gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[0] &lt;&lt; 6);
<a name="l00753"></a>00753                 <span class="keywordflow">if</span> (b &lt; 32)
<a name="l00754"></a>00754                         b += 31;
<a name="l00755"></a>00755                 <span class="keywordflow">else</span>
<a name="l00756"></a>00756                         b += 32;
<a name="l00757"></a>00757                 b = b &gt;&gt; 6;
<a name="l00758"></a>00758                 b = clamp_val(b, -31, 31);
<a name="l00759"></a>00759 
<a name="l00760"></a>00760                 tmp_u16 = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x048A) &amp; 0xF000;
<a name="l00761"></a>00761                 tmp_u16 |= ((u32) b &amp; 0x0000003F);
<a name="l00762"></a>00762                 tmp_u16 |= (((u32) a &amp; 0x0000003F) &lt;&lt; 6);
<a name="l00763"></a>00763                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x048A, tmp_u16);
<a name="l00764"></a>00764         }
<a name="l00765"></a>00765 }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 <span class="comment">/* Stack implementation to save/restore values from the</span>
<a name="l00768"></a>00768 <span class="comment"> * interference mitigation code.</span>
<a name="l00769"></a>00769 <span class="comment"> * It is save to restore values in random order.</span>
<a name="l00770"></a>00770 <span class="comment"> */</span>
<a name="l00771"></a><a class="code" href="phy__g_8c.html#ad2cc70a1d77962344c6aa7f98be4109e">00771</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#ad2cc70a1d77962344c6aa7f98be4109e">_stack_save</a>(u32 *_stackptr, <span class="keywordtype">size_t</span> *stackidx,
<a name="l00772"></a>00772                         u8 <span class="keywordtype">id</span>, u16 offset, u16 value)
<a name="l00773"></a>00773 {
<a name="l00774"></a>00774         u32 *stackptr = &amp;(_stackptr[*stackidx]);
<a name="l00775"></a>00775 
<a name="l00776"></a>00776         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(offset &amp; 0xF000);
<a name="l00777"></a>00777         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(<span class="keywordtype">id</span> &amp; 0xF0);
<a name="l00778"></a>00778         *stackptr = offset;
<a name="l00779"></a>00779         *stackptr |= ((u32) <span class="keywordtype">id</span>) &lt;&lt; 12;
<a name="l00780"></a>00780         *stackptr |= ((u32) value) &lt;&lt; 16;
<a name="l00781"></a>00781         (*stackidx)++;
<a name="l00782"></a>00782         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(*stackidx &gt;= <a class="code" href="phy__g_8h.html#a1683f24701af0a502c1d07813e17a895">B43_INTERFSTACK_SIZE</a>);
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00785"></a><a class="code" href="phy__g_8c.html#a7b659c33bcd2ba44d4b716d13067c665">00785</a> <span class="keyword">static</span> u16 <a class="code" href="phy__g_8c.html#a7b659c33bcd2ba44d4b716d13067c665">_stack_restore</a>(u32 *stackptr, u8 <span class="keywordtype">id</span>, u16 offset)
<a name="l00786"></a>00786 {
<a name="l00787"></a>00787         <span class="keywordtype">size_t</span> i;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(offset &amp; 0xF000);
<a name="l00790"></a>00790         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(<span class="keywordtype">id</span> &amp; 0xF0);
<a name="l00791"></a>00791         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="phy__g_8h.html#a1683f24701af0a502c1d07813e17a895">B43_INTERFSTACK_SIZE</a>; i++, stackptr++) {
<a name="l00792"></a>00792                 <span class="keywordflow">if</span> ((*stackptr &amp; 0x00000FFF) != offset)
<a name="l00793"></a>00793                         <span class="keywordflow">continue</span>;
<a name="l00794"></a>00794                 <span class="keywordflow">if</span> (((*stackptr &amp; 0x0000F000) &gt;&gt; 12) != <span class="keywordtype">id</span>)
<a name="l00795"></a>00795                         <span class="keywordflow">continue</span>;
<a name="l00796"></a>00796                 <span class="keywordflow">return</span> ((*stackptr &amp; 0xFFFF0000) &gt;&gt; 16);
<a name="l00797"></a>00797         }
<a name="l00798"></a>00798         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         <span class="keywordflow">return</span> 0;
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a><a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">00803</a> <span class="preprocessor">#define phy_stacksave(offset)                                   \</span>
<a name="l00804"></a>00804 <span class="preprocessor">        do {                                                    \</span>
<a name="l00805"></a>00805 <span class="preprocessor">                _stack_save(stack, &amp;stackidx, 0x1, (offset),    \</span>
<a name="l00806"></a>00806 <span class="preprocessor">                            b43_phy_read(dev, (offset)));       \</span>
<a name="l00807"></a>00807 <span class="preprocessor">        } while (0)</span>
<a name="l00808"></a><a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">00808</a> <span class="preprocessor"></span><span class="preprocessor">#define phy_stackrestore(offset)                                \</span>
<a name="l00809"></a>00809 <span class="preprocessor">        do {                                                    \</span>
<a name="l00810"></a>00810 <span class="preprocessor">                b43_phy_write(dev, (offset),            \</span>
<a name="l00811"></a>00811 <span class="preprocessor">                                  _stack_restore(stack, 0x1,    \</span>
<a name="l00812"></a>00812 <span class="preprocessor">                                                 (offset)));    \</span>
<a name="l00813"></a>00813 <span class="preprocessor">        } while (0)</span>
<a name="l00814"></a><a class="code" href="phy__g_8c.html#a7d3c9cb7790e14061a52c6223a1fc961">00814</a> <span class="preprocessor"></span><span class="preprocessor">#define radio_stacksave(offset)                                         \</span>
<a name="l00815"></a>00815 <span class="preprocessor">        do {                                                            \</span>
<a name="l00816"></a>00816 <span class="preprocessor">                _stack_save(stack, &amp;stackidx, 0x2, (offset),            \</span>
<a name="l00817"></a>00817 <span class="preprocessor">                            b43_radio_read16(dev, (offset)));   \</span>
<a name="l00818"></a>00818 <span class="preprocessor">        } while (0)</span>
<a name="l00819"></a><a class="code" href="phy__g_8c.html#a7b834eedefcb74ea4e9145b994c17c3d">00819</a> <span class="preprocessor"></span><span class="preprocessor">#define radio_stackrestore(offset)                                      \</span>
<a name="l00820"></a>00820 <span class="preprocessor">        do {                                                            \</span>
<a name="l00821"></a>00821 <span class="preprocessor">                b43_radio_write16(dev, (offset),                        \</span>
<a name="l00822"></a>00822 <span class="preprocessor">                                      _stack_restore(stack, 0x2,        \</span>
<a name="l00823"></a>00823 <span class="preprocessor">                                                     (offset)));        \</span>
<a name="l00824"></a>00824 <span class="preprocessor">        } while (0)</span>
<a name="l00825"></a><a class="code" href="phy__g_8c.html#a9e6f4d455ef1595506c588ff62e7559f">00825</a> <span class="preprocessor"></span><span class="preprocessor">#define ofdmtab_stacksave(table, offset)                        \</span>
<a name="l00826"></a>00826 <span class="preprocessor">        do {                                                    \</span>
<a name="l00827"></a>00827 <span class="preprocessor">                _stack_save(stack, &amp;stackidx, 0x3, (offset)|(table),    \</span>
<a name="l00828"></a>00828 <span class="preprocessor">                            b43_ofdmtab_read16(dev, (table), (offset)));        \</span>
<a name="l00829"></a>00829 <span class="preprocessor">        } while (0)</span>
<a name="l00830"></a><a class="code" href="phy__g_8c.html#a827edfb11cbda5ed222bf996bf01e32b">00830</a> <span class="preprocessor"></span><span class="preprocessor">#define ofdmtab_stackrestore(table, offset)                     \</span>
<a name="l00831"></a>00831 <span class="preprocessor">        do {                                                    \</span>
<a name="l00832"></a>00832 <span class="preprocessor">                b43_ofdmtab_write16(dev, (table),       (offset),       \</span>
<a name="l00833"></a>00833 <span class="preprocessor">                                  _stack_restore(stack, 0x3,    \</span>
<a name="l00834"></a>00834 <span class="preprocessor">                                                 (offset)|(table)));    \</span>
<a name="l00835"></a>00835 <span class="preprocessor">        } while (0)</span>
<a name="l00836"></a>00836 <span class="preprocessor"></span>
<a name="l00837"></a>00837 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00838"></a><a class="code" href="phy__g_8c.html#a1909155954c9987a88091fe7e6d3a033">00838</a> <a class="code" href="phy__g_8c.html#a1909155954c9987a88091fe7e6d3a033">b43_radio_interference_mitigation_enable</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, <span class="keywordtype">int</span> mode)
<a name="l00839"></a>00839 {
<a name="l00840"></a>00840         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l00841"></a>00841         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l00842"></a>00842         u16 tmp, flipped;
<a name="l00843"></a>00843         <span class="keywordtype">size_t</span> stackidx = 0;
<a name="l00844"></a>00844         u32 *stack = gphy-&gt;<a class="code" href="structb43__phy__g.html#a608b1d9e03356a4a783e5f3725f055d8">interfstack</a>;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846         <span class="keywordflow">switch</span> (mode) {
<a name="l00847"></a>00847         <span class="keywordflow">case</span> <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a013300a08f3e3e4f4cc335ec14e62b9f">B43_INTERFMODE_NONWLAN</a>:
<a name="l00848"></a>00848                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {
<a name="l00849"></a>00849                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x042B, 0x0800);
<a name="l00850"></a>00850                         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>, ~0x4000);
<a name="l00851"></a>00851                         <span class="keywordflow">break</span>;
<a name="l00852"></a>00852                 }
<a name="l00853"></a>00853                 <a class="code" href="phy__g_8c.html#a7d3c9cb7790e14061a52c6223a1fc961">radio_stacksave</a>(0x0078);
<a name="l00854"></a>00854                 tmp = (<a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x0078) &amp; 0x001E);
<a name="l00855"></a>00855                 <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(tmp &gt; 15);
<a name="l00856"></a>00856                 flipped = <a class="code" href="phy__g_8c.html#a6e2516a2956f95f7b875c1ecd009a215">bitrev4</a>(tmp);
<a name="l00857"></a>00857                 <span class="keywordflow">if</span> (flipped &lt; 10 &amp;&amp; flipped &gt;= 8)
<a name="l00858"></a>00858                         flipped = 7;
<a name="l00859"></a>00859                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flipped &gt;= 10)
<a name="l00860"></a>00860                         flipped -= 3;
<a name="l00861"></a>00861                 flipped = (<a class="code" href="phy__g_8c.html#a6e2516a2956f95f7b875c1ecd009a215">bitrev4</a>(flipped) &lt;&lt; 1) | 0x0020;
<a name="l00862"></a>00862                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0078, flipped);
<a name="l00863"></a>00863 
<a name="l00864"></a>00864                 <a class="code" href="phy__g_8c.html#a0c473583d8f3c46e081b1bb3834fa909">b43_calc_nrssi_threshold</a>(dev);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x0406);
<a name="l00867"></a>00867                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0406, 0x7E28);
<a name="l00868"></a>00868 
<a name="l00869"></a>00869                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x042B, 0x0800);
<a name="l00870"></a>00870                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="b43_8h.html#af635b5c82d121755f480afc25339dc7e">B43_PHY_RADIO_BITFIELD</a>, 0x1000);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A0);
<a name="l00873"></a>00873                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A0, 0xC0C0, 0x0008);
<a name="l00874"></a>00874                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A1);
<a name="l00875"></a>00875                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A1, 0xC0C0, 0x0605);
<a name="l00876"></a>00876                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A2);
<a name="l00877"></a>00877                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A2, 0xC0C0, 0x0204);
<a name="l00878"></a>00878                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A8);
<a name="l00879"></a>00879                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A8, 0xC0C0, 0x0803);
<a name="l00880"></a>00880                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04AB);
<a name="l00881"></a>00881                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04AB, 0xC0C0, 0x0605);
<a name="l00882"></a>00882 
<a name="l00883"></a>00883                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A7);
<a name="l00884"></a>00884                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04A7, 0x0002);
<a name="l00885"></a>00885                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A3);
<a name="l00886"></a>00886                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04A3, 0x287A);
<a name="l00887"></a>00887                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A9);
<a name="l00888"></a>00888                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04A9, 0x2027);
<a name="l00889"></a>00889                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x0493);
<a name="l00890"></a>00890                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0493, 0x32F5);
<a name="l00891"></a>00891                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04AA);
<a name="l00892"></a>00892                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04AA, 0x2027);
<a name="l00893"></a>00893                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04AC);
<a name="l00894"></a>00894                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04AC, 0x32F5);
<a name="l00895"></a>00895                 <span class="keywordflow">break</span>;
<a name="l00896"></a>00896         <span class="keywordflow">case</span> <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a5d10454bcf2964e8914f360b4c11d9bc">B43_INTERFMODE_MANUALWLAN</a>:
<a name="l00897"></a>00897                 <span class="keywordflow">if</span> (<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0033) &amp; 0x0800)
<a name="l00898"></a>00898                         <span class="keywordflow">break</span>;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900                 gphy-&gt;<a class="code" href="structb43__phy__g.html#a716086bdb0a4e341090388e3d92e2e0b">aci_enable</a> = 1;
<a name="l00901"></a>00901 
<a name="l00902"></a>00902                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(<a class="code" href="b43_8h.html#af635b5c82d121755f480afc25339dc7e">B43_PHY_RADIO_BITFIELD</a>);
<a name="l00903"></a>00903                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(<a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>);
<a name="l00904"></a>00904                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt; 2) {
<a name="l00905"></a>00905                         <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x0406);
<a name="l00906"></a>00906                 } <span class="keywordflow">else</span> {
<a name="l00907"></a>00907                         <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04C0);
<a name="l00908"></a>00908                         <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04C1);
<a name="l00909"></a>00909                 }
<a name="l00910"></a>00910                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x0033);
<a name="l00911"></a>00911                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A7);
<a name="l00912"></a>00912                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A3);
<a name="l00913"></a>00913                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A9);
<a name="l00914"></a>00914                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04AA);
<a name="l00915"></a>00915                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04AC);
<a name="l00916"></a>00916                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x0493);
<a name="l00917"></a>00917                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A1);
<a name="l00918"></a>00918                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A0);
<a name="l00919"></a>00919                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A2);
<a name="l00920"></a>00920                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x048A);
<a name="l00921"></a>00921                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04A8);
<a name="l00922"></a>00922                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04AB);
<a name="l00923"></a>00923                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 2) {
<a name="l00924"></a>00924                         <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04AD);
<a name="l00925"></a>00925                         <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04AE);
<a name="l00926"></a>00926                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 3) {
<a name="l00927"></a>00927                         <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x04AD);
<a name="l00928"></a>00928                         <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x0415);
<a name="l00929"></a>00929                         <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x0416);
<a name="l00930"></a>00930                         <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x0417);
<a name="l00931"></a>00931                         <a class="code" href="phy__g_8c.html#a9e6f4d455ef1595506c588ff62e7559f">ofdmtab_stacksave</a>(0x1A00, 0x2);
<a name="l00932"></a>00932                         <a class="code" href="phy__g_8c.html#a9e6f4d455ef1595506c588ff62e7559f">ofdmtab_stacksave</a>(0x1A00, 0x3);
<a name="l00933"></a>00933                 }
<a name="l00934"></a>00934                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x042B);
<a name="l00935"></a>00935                 <a class="code" href="phy__g_8c.html#adea0b7f146fbf9b78ceacea9898e7284">phy_stacksave</a>(0x048C);
<a name="l00936"></a>00936 
<a name="l00937"></a>00937                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="b43_8h.html#af635b5c82d121755f480afc25339dc7e">B43_PHY_RADIO_BITFIELD</a>, ~0x1000);
<a name="l00938"></a>00938                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>, 0xFFFC, 0x0002);
<a name="l00939"></a>00939 
<a name="l00940"></a>00940                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0033, 0x0800);
<a name="l00941"></a>00941                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04A3, 0x2027);
<a name="l00942"></a>00942                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04A9, 0x1CA8);
<a name="l00943"></a>00943                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0493, 0x287A);
<a name="l00944"></a>00944                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04AA, 0x1CA8);
<a name="l00945"></a>00945                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04AC, 0x287A);
<a name="l00946"></a>00946 
<a name="l00947"></a>00947                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A0, 0xFFC0, 0x001A);
<a name="l00948"></a>00948                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04A7, 0x000D);
<a name="l00949"></a>00949 
<a name="l00950"></a>00950                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt; 2) {
<a name="l00951"></a>00951                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0406, 0xFF0D);
<a name="l00952"></a>00952                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 2) {
<a name="l00953"></a>00953                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04C0, 0xFFFF);
<a name="l00954"></a>00954                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04C1, 0x00A9);
<a name="l00955"></a>00955                 } <span class="keywordflow">else</span> {
<a name="l00956"></a>00956                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04C0, 0x00C1);
<a name="l00957"></a>00957                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x04C1, 0x0059);
<a name="l00958"></a>00958                 }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A1, 0xC0FF, 0x1800);
<a name="l00961"></a>00961                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A1, 0xFFC0, 0x0015);
<a name="l00962"></a>00962                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A8, 0xCFFF, 0x1000);
<a name="l00963"></a>00963                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A8, 0xF0FF, 0x0A00);
<a name="l00964"></a>00964                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04AB, 0xCFFF, 0x1000);
<a name="l00965"></a>00965                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04AB, 0xF0FF, 0x0800);
<a name="l00966"></a>00966                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04AB, 0xFFCF, 0x0010);
<a name="l00967"></a>00967                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04AB, 0xFFF0, 0x0005);
<a name="l00968"></a>00968                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A8, 0xFFCF, 0x0010);
<a name="l00969"></a>00969                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A8, 0xFFF0, 0x0006);
<a name="l00970"></a>00970                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A2, 0xF0FF, 0x0800);
<a name="l00971"></a>00971                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A0, 0xF0FF, 0x0500);
<a name="l00972"></a>00972                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04A2, 0xFFF0, 0x000B);
<a name="l00973"></a>00973 
<a name="l00974"></a>00974                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 3) {
<a name="l00975"></a>00975                         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x048A, 0x7FFF);
<a name="l00976"></a>00976                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0415, 0x8000, 0x36D8);
<a name="l00977"></a>00977                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0416, 0x8000, 0x36D8);
<a name="l00978"></a>00978                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0417, 0xFE00, 0x016D);
<a name="l00979"></a>00979                 } <span class="keywordflow">else</span> {
<a name="l00980"></a>00980                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x048A, 0x1000);
<a name="l00981"></a>00981                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x048A, 0x9FFF, 0x2000);
<a name="l00982"></a>00982                         <a class="code" href="main_8c.html#abbb7dc97d3d48c3504e1c35b366407ad">b43_hf_write</a>(dev, <a class="code" href="main_8c.html#a3f3a1d36e1882927e495fa890efbbe97">b43_hf_read</a>(dev) | <a class="code" href="b43_8h.html#a083dcd345070c3d20000a0594d9e38a7">B43_HF_ACIW</a>);
<a name="l00983"></a>00983                 }
<a name="l00984"></a>00984                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l00985"></a>00985                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x042B, 0x0800);
<a name="l00986"></a>00986                 }
<a name="l00987"></a>00987                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x048C, 0xF0FF, 0x0200);
<a name="l00988"></a>00988                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 2) {
<a name="l00989"></a>00989                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04AE, 0xFF00, 0x007F);
<a name="l00990"></a>00990                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x04AD, 0x00FF, 0x1300);
<a name="l00991"></a>00991                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 6) {
<a name="l00992"></a>00992                         <a class="code" href="phy__a_8h.html#a53b0f35cb22775c784e911c203b52482">b43_ofdmtab_write16</a>(dev, 0x1A00, 0x3, 0x007F);
<a name="l00993"></a>00993                         <a class="code" href="phy__a_8h.html#a53b0f35cb22775c784e911c203b52482">b43_ofdmtab_write16</a>(dev, 0x1A00, 0x2, 0x007F);
<a name="l00994"></a>00994                         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x04AD, 0x00FF);
<a name="l00995"></a>00995                 }
<a name="l00996"></a>00996                 <a class="code" href="phy__g_8c.html#ae11eeb69eea9f510730039dd9a623140">b43_calc_nrssi_slope</a>(dev);
<a name="l00997"></a>00997                 <span class="keywordflow">break</span>;
<a name="l00998"></a>00998         <span class="keywordflow">default</span>:
<a name="l00999"></a>00999                 <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01000"></a>01000         }
<a name="l01001"></a>01001 }
<a name="l01002"></a>01002 
<a name="l01003"></a>01003 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01004"></a><a class="code" href="phy__g_8c.html#a75396509b918588c68c1c712d2e8d57c">01004</a> <a class="code" href="phy__g_8c.html#a75396509b918588c68c1c712d2e8d57c">b43_radio_interference_mitigation_disable</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, <span class="keywordtype">int</span> mode)
<a name="l01005"></a>01005 {
<a name="l01006"></a>01006         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01007"></a>01007         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l01008"></a>01008         u32 *stack = gphy-&gt;<a class="code" href="structb43__phy__g.html#a608b1d9e03356a4a783e5f3725f055d8">interfstack</a>;
<a name="l01009"></a>01009 
<a name="l01010"></a>01010         <span class="keywordflow">switch</span> (mode) {
<a name="l01011"></a>01011         <span class="keywordflow">case</span> <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a013300a08f3e3e4f4cc335ec14e62b9f">B43_INTERFMODE_NONWLAN</a>:
<a name="l01012"></a>01012                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {
<a name="l01013"></a>01013                         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x042B, ~0x0800);
<a name="l01014"></a>01014                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>, 0x4000);
<a name="l01015"></a>01015                         <span class="keywordflow">break</span>;
<a name="l01016"></a>01016                 }
<a name="l01017"></a>01017                 <a class="code" href="phy__g_8c.html#a7b834eedefcb74ea4e9145b994c17c3d">radio_stackrestore</a>(0x0078);
<a name="l01018"></a>01018                 <a class="code" href="phy__g_8c.html#a0c473583d8f3c46e081b1bb3834fa909">b43_calc_nrssi_threshold</a>(dev);
<a name="l01019"></a>01019                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x0406);
<a name="l01020"></a>01020                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x042B, ~0x0800);
<a name="l01021"></a>01021                 <span class="keywordflow">if</span> (!dev-&gt;<a class="code" href="structb43__wldev.html#a2c26ad0ae99a136ef7bdd5e8d6e94ea9">bad_frames_preempt</a>) {
<a name="l01022"></a>01022                         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="b43_8h.html#af635b5c82d121755f480afc25339dc7e">B43_PHY_RADIO_BITFIELD</a>, ~(1 &lt;&lt; 11));
<a name="l01023"></a>01023                 }
<a name="l01024"></a>01024                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>, 0x4000);
<a name="l01025"></a>01025                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A0);
<a name="l01026"></a>01026                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A1);
<a name="l01027"></a>01027                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A2);
<a name="l01028"></a>01028                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A8);
<a name="l01029"></a>01029                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04AB);
<a name="l01030"></a>01030                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A7);
<a name="l01031"></a>01031                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A3);
<a name="l01032"></a>01032                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A9);
<a name="l01033"></a>01033                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x0493);
<a name="l01034"></a>01034                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04AA);
<a name="l01035"></a>01035                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04AC);
<a name="l01036"></a>01036                 <span class="keywordflow">break</span>;
<a name="l01037"></a>01037         <span class="keywordflow">case</span> <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a5d10454bcf2964e8914f360b4c11d9bc">B43_INTERFMODE_MANUALWLAN</a>:
<a name="l01038"></a>01038                 <span class="keywordflow">if</span> (!(<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0033) &amp; 0x0800))
<a name="l01039"></a>01039                         <span class="keywordflow">break</span>;
<a name="l01040"></a>01040 
<a name="l01041"></a>01041                 gphy-&gt;<a class="code" href="structb43__phy__g.html#a716086bdb0a4e341090388e3d92e2e0b">aci_enable</a> = 0;
<a name="l01042"></a>01042 
<a name="l01043"></a>01043                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(<a class="code" href="b43_8h.html#af635b5c82d121755f480afc25339dc7e">B43_PHY_RADIO_BITFIELD</a>);
<a name="l01044"></a>01044                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(<a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>);
<a name="l01045"></a>01045                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x0033);
<a name="l01046"></a>01046                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A3);
<a name="l01047"></a>01047                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A9);
<a name="l01048"></a>01048                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x0493);
<a name="l01049"></a>01049                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04AA);
<a name="l01050"></a>01050                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04AC);
<a name="l01051"></a>01051                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A0);
<a name="l01052"></a>01052                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A7);
<a name="l01053"></a>01053                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01054"></a>01054                         <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04C0);
<a name="l01055"></a>01055                         <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04C1);
<a name="l01056"></a>01056                 } <span class="keywordflow">else</span>
<a name="l01057"></a>01057                         <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x0406);
<a name="l01058"></a>01058                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A1);
<a name="l01059"></a>01059                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04AB);
<a name="l01060"></a>01060                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A8);
<a name="l01061"></a>01061                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 2) {
<a name="l01062"></a>01062                         <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04AD);
<a name="l01063"></a>01063                         <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04AE);
<a name="l01064"></a>01064                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 3) {
<a name="l01065"></a>01065                         <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04AD);
<a name="l01066"></a>01066                         <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x0415);
<a name="l01067"></a>01067                         <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x0416);
<a name="l01068"></a>01068                         <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x0417);
<a name="l01069"></a>01069                         <a class="code" href="phy__g_8c.html#a827edfb11cbda5ed222bf996bf01e32b">ofdmtab_stackrestore</a>(0x1A00, 0x2);
<a name="l01070"></a>01070                         <a class="code" href="phy__g_8c.html#a827edfb11cbda5ed222bf996bf01e32b">ofdmtab_stackrestore</a>(0x1A00, 0x3);
<a name="l01071"></a>01071                 }
<a name="l01072"></a>01072                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x04A2);
<a name="l01073"></a>01073                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x048A);
<a name="l01074"></a>01074                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x042B);
<a name="l01075"></a>01075                 <a class="code" href="phy__g_8c.html#a8027d2e92ca7087024cbe515d9bf656f">phy_stackrestore</a>(0x048C);
<a name="l01076"></a>01076                 <a class="code" href="main_8c.html#abbb7dc97d3d48c3504e1c35b366407ad">b43_hf_write</a>(dev, <a class="code" href="main_8c.html#a3f3a1d36e1882927e495fa890efbbe97">b43_hf_read</a>(dev) &amp; ~<a class="code" href="b43_8h.html#a083dcd345070c3d20000a0594d9e38a7">B43_HF_ACIW</a>);
<a name="l01077"></a>01077                 <a class="code" href="phy__g_8c.html#ae11eeb69eea9f510730039dd9a623140">b43_calc_nrssi_slope</a>(dev);
<a name="l01078"></a>01078                 <span class="keywordflow">break</span>;
<a name="l01079"></a>01079         <span class="keywordflow">default</span>:
<a name="l01080"></a>01080                 <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01081"></a>01081         }
<a name="l01082"></a>01082 }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084 <span class="preprocessor">#undef phy_stacksave</span>
<a name="l01085"></a>01085 <span class="preprocessor"></span><span class="preprocessor">#undef phy_stackrestore</span>
<a name="l01086"></a>01086 <span class="preprocessor"></span><span class="preprocessor">#undef radio_stacksave</span>
<a name="l01087"></a>01087 <span class="preprocessor"></span><span class="preprocessor">#undef radio_stackrestore</span>
<a name="l01088"></a>01088 <span class="preprocessor"></span><span class="preprocessor">#undef ofdmtab_stacksave</span>
<a name="l01089"></a>01089 <span class="preprocessor"></span><span class="preprocessor">#undef ofdmtab_stackrestore</span>
<a name="l01090"></a>01090 <span class="preprocessor"></span>
<a name="l01091"></a><a class="code" href="phy__g_8c.html#aead51b98172258d1e1331adfbb4d15ad">01091</a> <span class="keyword">static</span> u16 <a class="code" href="phy__g_8c.html#aead51b98172258d1e1331adfbb4d15ad">b43_radio_core_calibration_value</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l01092"></a>01092 {
<a name="l01093"></a>01093         u16 reg, index, ret;
<a name="l01094"></a>01094 
<a name="l01095"></a>01095         <span class="keyword">static</span> <span class="keyword">const</span> u8 rcc_table[] = {
<a name="l01096"></a>01096                 0x02, 0x03, 0x01, 0x0F,
<a name="l01097"></a>01097                 0x06, 0x07, 0x05, 0x0F,
<a name="l01098"></a>01098                 0x0A, 0x0B, 0x09, 0x0F,
<a name="l01099"></a>01099                 0x0E, 0x0F, 0x0D, 0x0F,
<a name="l01100"></a>01100         };
<a name="l01101"></a>01101 
<a name="l01102"></a>01102         reg = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x60);
<a name="l01103"></a>01103         index = (reg &amp; 0x001E) &gt;&gt; 1;
<a name="l01104"></a>01104         ret = rcc_table[index] &lt;&lt; 1;
<a name="l01105"></a>01105         ret |= (reg &amp; 0x0001);
<a name="l01106"></a>01106         ret |= 0x0020;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108         <span class="keywordflow">return</span> ret;
<a name="l01109"></a>01109 }
<a name="l01110"></a>01110 
<a name="l01111"></a><a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">01111</a> <span class="preprocessor">#define LPD(L, P, D)    (((L) &lt;&lt; 2) | ((P) &lt;&lt; 1) | ((D) &lt;&lt; 0))</span>
<a name="l01112"></a><a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">01112</a> <span class="preprocessor"></span><span class="keyword">static</span> u16 <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l01113"></a>01113                                 u16 phy_register, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lpd)
<a name="l01114"></a>01114 {
<a name="l01115"></a>01115         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01116"></a>01116         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l01117"></a>01117         <span class="keyword">struct </span>ssb_sprom *sprom = dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>;
<a name="l01118"></a>01118 
<a name="l01119"></a>01119         <span class="keywordflow">if</span> (!phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a>)
<a name="l01120"></a>01120                 <span class="keywordflow">return</span> 0;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122         <span class="keywordflow">if</span> (<a class="code" href="phy__g_8h.html#ab859737bd92d2e1ccc98b8039310df06">has_loopback_gain</a>(phy)) {
<a name="l01123"></a>01123                 <span class="keywordtype">int</span> max_lb_gain = gphy-&gt;<a class="code" href="structb43__phy__g.html#a8db005657d3a8bd375ca88a1d73df5c8">max_lb_gain</a>;
<a name="l01124"></a>01124                 u16 extlna;
<a name="l01125"></a>01125                 u16 i;
<a name="l01126"></a>01126 
<a name="l01127"></a>01127                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8)
<a name="l01128"></a>01128                         max_lb_gain += 0x3E;
<a name="l01129"></a>01129                 <span class="keywordflow">else</span>
<a name="l01130"></a>01130                         max_lb_gain += 0x26;
<a name="l01131"></a>01131                 <span class="keywordflow">if</span> (max_lb_gain &gt;= 0x46) {
<a name="l01132"></a>01132                         extlna = 0x3000;
<a name="l01133"></a>01133                         max_lb_gain -= 0x46;
<a name="l01134"></a>01134                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (max_lb_gain &gt;= 0x3A) {
<a name="l01135"></a>01135                         extlna = 0x1000;
<a name="l01136"></a>01136                         max_lb_gain -= 0x3A;
<a name="l01137"></a>01137                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (max_lb_gain &gt;= 0x2E) {
<a name="l01138"></a>01138                         extlna = 0x2000;
<a name="l01139"></a>01139                         max_lb_gain -= 0x2E;
<a name="l01140"></a>01140                 } <span class="keywordflow">else</span> {
<a name="l01141"></a>01141                         extlna = 0;
<a name="l01142"></a>01142                         max_lb_gain -= 0x10;
<a name="l01143"></a>01143                 }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145                 <span class="keywordflow">for</span> (i = 0; i &lt; 16; i++) {
<a name="l01146"></a>01146                         max_lb_gain -= (i * 6);
<a name="l01147"></a>01147                         <span class="keywordflow">if</span> (max_lb_gain &lt; 6)
<a name="l01148"></a>01148                                 <span class="keywordflow">break</span>;
<a name="l01149"></a>01149                 }
<a name="l01150"></a>01150 
<a name="l01151"></a>01151                 <span class="keywordflow">if</span> ((phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt; 7) ||
<a name="l01152"></a>01152                     !(sprom-&gt;boardflags_lo &amp; <a class="code" href="b43_8h.html#a0d9d8affb2af07eb01d6097c34c56eee">B43_BFL_EXTLNA</a>)) {
<a name="l01153"></a>01153                         <span class="keywordflow">if</span> (phy_register == <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>) {
<a name="l01154"></a>01154                                 <span class="keywordflow">return</span> 0x1B3;
<a name="l01155"></a>01155                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy_register == <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>) {
<a name="l01156"></a>01156                                 extlna |= (i &lt;&lt; 8);
<a name="l01157"></a>01157                                 <span class="keywordflow">switch</span> (lpd) {
<a name="l01158"></a>01158                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 1, 1):
<a name="l01159"></a>01159                                         <span class="keywordflow">return</span> 0x0F92;
<a name="l01160"></a>01160                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 0, 1):
<a name="l01161"></a>01161                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 1):
<a name="l01162"></a>01162                                         <span class="keywordflow">return</span> (0x0092 | extlna);
<a name="l01163"></a>01163                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 0):
<a name="l01164"></a>01164                                         <span class="keywordflow">return</span> (0x0093 | extlna);
<a name="l01165"></a>01165                                 }
<a name="l01166"></a>01166                                 <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01167"></a>01167                         }
<a name="l01168"></a>01168                         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01169"></a>01169                 } <span class="keywordflow">else</span> {
<a name="l01170"></a>01170                         <span class="keywordflow">if</span> (phy_register == <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>) {
<a name="l01171"></a>01171                                 <span class="keywordflow">return</span> 0x9B3;
<a name="l01172"></a>01172                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy_register == <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>) {
<a name="l01173"></a>01173                                 <span class="keywordflow">if</span> (extlna)
<a name="l01174"></a>01174                                         extlna |= 0x8000;
<a name="l01175"></a>01175                                 extlna |= (i &lt;&lt; 8);
<a name="l01176"></a>01176                                 <span class="keywordflow">switch</span> (lpd) {
<a name="l01177"></a>01177                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 1, 1):
<a name="l01178"></a>01178                                         <span class="keywordflow">return</span> 0x8F92;
<a name="l01179"></a>01179                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 0, 1):
<a name="l01180"></a>01180                                         <span class="keywordflow">return</span> (0x8092 | extlna);
<a name="l01181"></a>01181                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 1):
<a name="l01182"></a>01182                                         <span class="keywordflow">return</span> (0x2092 | extlna);
<a name="l01183"></a>01183                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 0):
<a name="l01184"></a>01184                                         <span class="keywordflow">return</span> (0x2093 | extlna);
<a name="l01185"></a>01185                                 }
<a name="l01186"></a>01186                                 <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01187"></a>01187                         }
<a name="l01188"></a>01188                         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01189"></a>01189                 }
<a name="l01190"></a>01190         } <span class="keywordflow">else</span> {
<a name="l01191"></a>01191                 <span class="keywordflow">if</span> ((phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt; 7) ||
<a name="l01192"></a>01192                     !(sprom-&gt;boardflags_lo &amp; <a class="code" href="b43_8h.html#a0d9d8affb2af07eb01d6097c34c56eee">B43_BFL_EXTLNA</a>)) {
<a name="l01193"></a>01193                         <span class="keywordflow">if</span> (phy_register == <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>) {
<a name="l01194"></a>01194                                 <span class="keywordflow">return</span> 0x1B3;
<a name="l01195"></a>01195                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy_register == <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>) {
<a name="l01196"></a>01196                                 <span class="keywordflow">switch</span> (lpd) {
<a name="l01197"></a>01197                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 1, 1):
<a name="l01198"></a>01198                                         <span class="keywordflow">return</span> 0x0FB2;
<a name="l01199"></a>01199                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 0, 1):
<a name="l01200"></a>01200                                         <span class="keywordflow">return</span> 0x00B2;
<a name="l01201"></a>01201                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 1):
<a name="l01202"></a>01202                                         <span class="keywordflow">return</span> 0x30B2;
<a name="l01203"></a>01203                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 0):
<a name="l01204"></a>01204                                         <span class="keywordflow">return</span> 0x30B3;
<a name="l01205"></a>01205                                 }
<a name="l01206"></a>01206                                 <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01207"></a>01207                         }
<a name="l01208"></a>01208                         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01209"></a>01209                 } <span class="keywordflow">else</span> {
<a name="l01210"></a>01210                         <span class="keywordflow">if</span> (phy_register == <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>) {
<a name="l01211"></a>01211                                 <span class="keywordflow">return</span> 0x9B3;
<a name="l01212"></a>01212                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy_register == <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>) {
<a name="l01213"></a>01213                                 <span class="keywordflow">switch</span> (lpd) {
<a name="l01214"></a>01214                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 1, 1):
<a name="l01215"></a>01215                                         <span class="keywordflow">return</span> 0x8FB2;
<a name="l01216"></a>01216                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 0, 1):
<a name="l01217"></a>01217                                         <span class="keywordflow">return</span> 0x80B2;
<a name="l01218"></a>01218                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 1):
<a name="l01219"></a>01219                                         <span class="keywordflow">return</span> 0x20B2;
<a name="l01220"></a>01220                                 <span class="keywordflow">case</span> <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 0):
<a name="l01221"></a>01221                                         <span class="keywordflow">return</span> 0x20B3;
<a name="l01222"></a>01222                                 }
<a name="l01223"></a>01223                                 <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01224"></a>01224                         }
<a name="l01225"></a>01225                         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01226"></a>01226                 }
<a name="l01227"></a>01227         }
<a name="l01228"></a>01228         <span class="keywordflow">return</span> 0;
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a><a class="code" href="structinit2050__saved__values.html">01231</a> <span class="keyword">struct </span><a class="code" href="structinit2050__saved__values.html">init2050_saved_values</a> {
<a name="l01232"></a>01232         <span class="comment">/* Core registers */</span>
<a name="l01233"></a><a class="code" href="structinit2050__saved__values.html#ac553f48c3a06f401d35a258a302dd6a5">01233</a>         u16 <a class="code" href="structinit2050__saved__values.html#ac553f48c3a06f401d35a258a302dd6a5">reg_3EC</a>;
<a name="l01234"></a><a class="code" href="structinit2050__saved__values.html#a645c734e19452025dfba14d902705a8d">01234</a>         u16 <a class="code" href="structinit2050__saved__values.html#a645c734e19452025dfba14d902705a8d">reg_3E6</a>;
<a name="l01235"></a><a class="code" href="structinit2050__saved__values.html#a6b01c28df43b59204b18c0445aa6f6ab">01235</a>         u16 <a class="code" href="structinit2050__saved__values.html#a6b01c28df43b59204b18c0445aa6f6ab">reg_3F4</a>;
<a name="l01236"></a>01236         <span class="comment">/* Radio registers */</span>
<a name="l01237"></a><a class="code" href="structinit2050__saved__values.html#a3aed1c45169c1ddd1ac1615c73f41f29">01237</a>         u16 <a class="code" href="structinit2050__saved__values.html#a3aed1c45169c1ddd1ac1615c73f41f29">radio_43</a>;
<a name="l01238"></a><a class="code" href="structinit2050__saved__values.html#aa5d6437b25eafa70619bed5fd51805aa">01238</a>         u16 <a class="code" href="structinit2050__saved__values.html#aa5d6437b25eafa70619bed5fd51805aa">radio_51</a>;
<a name="l01239"></a><a class="code" href="structinit2050__saved__values.html#ab40680b36ab60622f6482a8878875745">01239</a>         u16 <a class="code" href="structinit2050__saved__values.html#ab40680b36ab60622f6482a8878875745">radio_52</a>;
<a name="l01240"></a>01240         <span class="comment">/* PHY registers */</span>
<a name="l01241"></a><a class="code" href="structinit2050__saved__values.html#a07f065dd30b501f962fb0b4c5354fe6e">01241</a>         u16 <a class="code" href="structinit2050__saved__values.html#a07f065dd30b501f962fb0b4c5354fe6e">phy_pgactl</a>;
<a name="l01242"></a><a class="code" href="structinit2050__saved__values.html#a7abf4a1402f86c1cc612f8e06ae3ef00">01242</a>         u16 <a class="code" href="structinit2050__saved__values.html#a7abf4a1402f86c1cc612f8e06ae3ef00">phy_cck_5A</a>;
<a name="l01243"></a><a class="code" href="structinit2050__saved__values.html#a57a9825d42573317f8310a40b4150742">01243</a>         u16 <a class="code" href="structinit2050__saved__values.html#a57a9825d42573317f8310a40b4150742">phy_cck_59</a>;
<a name="l01244"></a><a class="code" href="structinit2050__saved__values.html#a8af5876bc0d244607b04a6741dc2785d">01244</a>         u16 <a class="code" href="structinit2050__saved__values.html#a8af5876bc0d244607b04a6741dc2785d">phy_cck_58</a>;
<a name="l01245"></a><a class="code" href="structinit2050__saved__values.html#af1373a2bc1e2fd046d634f7f07788506">01245</a>         u16 <a class="code" href="structinit2050__saved__values.html#af1373a2bc1e2fd046d634f7f07788506">phy_cck_30</a>;
<a name="l01246"></a><a class="code" href="structinit2050__saved__values.html#ac63be03f343541101c7e1fdb8ba33e9f">01246</a>         u16 <a class="code" href="structinit2050__saved__values.html#ac63be03f343541101c7e1fdb8ba33e9f">phy_rfover</a>;
<a name="l01247"></a><a class="code" href="structinit2050__saved__values.html#a28847c5e7de01c52dfa90122b2e0bac7">01247</a>         u16 <a class="code" href="structinit2050__saved__values.html#a28847c5e7de01c52dfa90122b2e0bac7">phy_rfoverval</a>;
<a name="l01248"></a><a class="code" href="structinit2050__saved__values.html#ae72e66b13ac7a76a3c656bd4cae56979">01248</a>         u16 <a class="code" href="structinit2050__saved__values.html#ae72e66b13ac7a76a3c656bd4cae56979">phy_analogover</a>;
<a name="l01249"></a><a class="code" href="structinit2050__saved__values.html#a895372c499f8d2d0df875266d235e84b">01249</a>         u16 <a class="code" href="structinit2050__saved__values.html#a895372c499f8d2d0df875266d235e84b">phy_analogoverval</a>;
<a name="l01250"></a><a class="code" href="structinit2050__saved__values.html#af5b49b614e7bbe623e8b0abdbfc65db4">01250</a>         u16 <a class="code" href="structinit2050__saved__values.html#af5b49b614e7bbe623e8b0abdbfc65db4">phy_crs0</a>;
<a name="l01251"></a><a class="code" href="structinit2050__saved__values.html#acf8e7222ae3b050a4e4ee6c6535c7f6b">01251</a>         u16 <a class="code" href="structinit2050__saved__values.html#acf8e7222ae3b050a4e4ee6c6535c7f6b">phy_classctl</a>;
<a name="l01252"></a><a class="code" href="structinit2050__saved__values.html#aafcbdd15ea5d15c08f92bb27e1f18c56">01252</a>         u16 <a class="code" href="structinit2050__saved__values.html#aafcbdd15ea5d15c08f92bb27e1f18c56">phy_lo_mask</a>;
<a name="l01253"></a><a class="code" href="structinit2050__saved__values.html#aed607bee2a6f350d540666ff3e394351">01253</a>         u16 <a class="code" href="structinit2050__saved__values.html#aed607bee2a6f350d540666ff3e394351">phy_lo_ctl</a>;
<a name="l01254"></a><a class="code" href="structinit2050__saved__values.html#ae216dc760c0a34303b25b1581e706f91">01254</a>         u16 <a class="code" href="structinit2050__saved__values.html#ae216dc760c0a34303b25b1581e706f91">phy_syncctl</a>;
<a name="l01255"></a>01255 };
<a name="l01256"></a>01256 
<a name="l01257"></a><a class="code" href="phy__g_8c.html#abc1442fb27ab7e91f48f427ea05bdebc">01257</a> <span class="keyword">static</span> u16 <a class="code" href="phy__g_8c.html#abc1442fb27ab7e91f48f427ea05bdebc">b43_radio_init2050</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l01258"></a>01258 {
<a name="l01259"></a>01259         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01260"></a>01260         <span class="keyword">struct </span><a class="code" href="structinit2050__saved__values.html">init2050_saved_values</a> sav;
<a name="l01261"></a>01261         u16 rcc;
<a name="l01262"></a>01262         u16 radio78;
<a name="l01263"></a>01263         u16 ret;
<a name="l01264"></a>01264         u16 i, j;
<a name="l01265"></a>01265         u32 tmp1 = 0, tmp2 = 0;
<a name="l01266"></a>01266 
<a name="l01267"></a>01267         memset(&amp;sav, 0, <span class="keyword">sizeof</span>(sav));   <span class="comment">/* get rid of &quot;may be used uninitialized...&quot; */</span>
<a name="l01268"></a>01268 
<a name="l01269"></a>01269         sav.<a class="code" href="structinit2050__saved__values.html#a3aed1c45169c1ddd1ac1615c73f41f29">radio_43</a> = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x43);
<a name="l01270"></a>01270         sav.<a class="code" href="structinit2050__saved__values.html#aa5d6437b25eafa70619bed5fd51805aa">radio_51</a> = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x51);
<a name="l01271"></a>01271         sav.<a class="code" href="structinit2050__saved__values.html#ab40680b36ab60622f6482a8878875745">radio_52</a> = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x52);
<a name="l01272"></a>01272         sav.<a class="code" href="structinit2050__saved__values.html#a07f065dd30b501f962fb0b4c5354fe6e">phy_pgactl</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>);
<a name="l01273"></a>01273         sav.<a class="code" href="structinit2050__saved__values.html#a7abf4a1402f86c1cc612f8e06ae3ef00">phy_cck_5A</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x5A));
<a name="l01274"></a>01274         sav.<a class="code" href="structinit2050__saved__values.html#a57a9825d42573317f8310a40b4150742">phy_cck_59</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x59));
<a name="l01275"></a>01275         sav.<a class="code" href="structinit2050__saved__values.html#a8af5876bc0d244607b04a6741dc2785d">phy_cck_58</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58));
<a name="l01276"></a>01276 
<a name="l01277"></a>01277         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#ae6fb3c6c5a205544eb5f7fa167c508ca">B43_PHYTYPE_B</a>) {
<a name="l01278"></a>01278                 sav.<a class="code" href="structinit2050__saved__values.html#af1373a2bc1e2fd046d634f7f07788506">phy_cck_30</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x30));
<a name="l01279"></a>01279                 sav.<a class="code" href="structinit2050__saved__values.html#ac553f48c3a06f401d35a258a302dd6a5">reg_3EC</a> = <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, 0x3EC);
<a name="l01280"></a>01280 
<a name="l01281"></a>01281                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x30), 0xFF);
<a name="l01282"></a>01282                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x3EC, 0x3F3F);
<a name="l01283"></a>01283         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01284"></a>01284                 sav.<a class="code" href="structinit2050__saved__values.html#ac63be03f343541101c7e1fdb8ba33e9f">phy_rfover</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>);
<a name="l01285"></a>01285                 sav.<a class="code" href="structinit2050__saved__values.html#a28847c5e7de01c52dfa90122b2e0bac7">phy_rfoverval</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>);
<a name="l01286"></a>01286                 sav.<a class="code" href="structinit2050__saved__values.html#ae72e66b13ac7a76a3c656bd4cae56979">phy_analogover</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#aa4175032f0875ab8ee0fbb32d9c9c855">B43_PHY_ANALOGOVER</a>);
<a name="l01287"></a>01287                 sav.<a class="code" href="structinit2050__saved__values.html#a895372c499f8d2d0df875266d235e84b">phy_analogoverval</a> =
<a name="l01288"></a>01288                     <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#ab2a59a9c96fa0eb33d3285f0fb7ae4af">B43_PHY_ANALOGOVERVAL</a>);
<a name="l01289"></a>01289                 sav.<a class="code" href="structinit2050__saved__values.html#af5b49b614e7bbe623e8b0abdbfc65db4">phy_crs0</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__a_8h.html#aaa442f04ce83f557d193d1f18d003c4a">B43_PHY_CRS0</a>);
<a name="l01290"></a>01290                 sav.<a class="code" href="structinit2050__saved__values.html#acf8e7222ae3b050a4e4ee6c6535c7f6b">phy_classctl</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#ab923cd1cbd1b3e38d632df0fe4aeee5e">B43_PHY_CLASSCTL</a>);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#aa4175032f0875ab8ee0fbb32d9c9c855">B43_PHY_ANALOGOVER</a>, 0x0003);
<a name="l01293"></a>01293                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__g_8h.html#ab2a59a9c96fa0eb33d3285f0fb7ae4af">B43_PHY_ANALOGOVERVAL</a>, 0xFFFC);
<a name="l01294"></a>01294                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__a_8h.html#aaa442f04ce83f557d193d1f18d003c4a">B43_PHY_CRS0</a>, 0x7FFF);
<a name="l01295"></a>01295                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__g_8h.html#ab923cd1cbd1b3e38d632df0fe4aeee5e">B43_PHY_CLASSCTL</a>, 0xFFFC);
<a name="l01296"></a>01296                 <span class="keywordflow">if</span> (<a class="code" href="phy__g_8h.html#ab859737bd92d2e1ccc98b8039310df06">has_loopback_gain</a>(phy)) {
<a name="l01297"></a>01297                         sav.<a class="code" href="structinit2050__saved__values.html#aafcbdd15ea5d15c08f92bb27e1f18c56">phy_lo_mask</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#ad6a8817e21e5c59887a73091e876304c">B43_PHY_LO_MASK</a>);
<a name="l01298"></a>01298                         sav.<a class="code" href="structinit2050__saved__values.html#aed607bee2a6f350d540666ff3e394351">phy_lo_ctl</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#ad802cb5dcb2b953c742717eb62c0df32">B43_PHY_LO_CTL</a>);
<a name="l01299"></a>01299 
<a name="l01300"></a>01300                         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 3)
<a name="l01301"></a>01301                                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad6a8817e21e5c59887a73091e876304c">B43_PHY_LO_MASK</a>, 0xC020);
<a name="l01302"></a>01302                         <span class="keywordflow">else</span>
<a name="l01303"></a>01303                                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad6a8817e21e5c59887a73091e876304c">B43_PHY_LO_MASK</a>, 0x8020);
<a name="l01304"></a>01304                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad802cb5dcb2b953c742717eb62c0df32">B43_PHY_LO_CTL</a>, 0);
<a name="l01305"></a>01305                 }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01308"></a>01308                               <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01309"></a>01309                                                    <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 1, 1)));
<a name="l01310"></a>01310                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>,
<a name="l01311"></a>01311                               <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, 0));
<a name="l01312"></a>01312         }
<a name="l01313"></a>01313         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x3E2, <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, 0x3E2) | 0x8000);
<a name="l01314"></a>01314 
<a name="l01315"></a>01315         sav.<a class="code" href="structinit2050__saved__values.html#ae216dc760c0a34303b25b1581e706f91">phy_syncctl</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#ac289073dd817b50ab1a9f76681dc90db">B43_PHY_SYNCCTL</a>);
<a name="l01316"></a>01316         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__g_8h.html#ac289073dd817b50ab1a9f76681dc90db">B43_PHY_SYNCCTL</a>, 0xFF7F);
<a name="l01317"></a>01317         sav.<a class="code" href="structinit2050__saved__values.html#a645c734e19452025dfba14d902705a8d">reg_3E6</a> = <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, 0x3E6);
<a name="l01318"></a>01318         sav.<a class="code" href="structinit2050__saved__values.html#a6b01c28df43b59204b18c0445aa6f6ab">reg_3F4</a> = <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, 0x3F4);
<a name="l01319"></a>01319 
<a name="l01320"></a>01320         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> == 0) {
<a name="l01321"></a>01321                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x03E6, 0x0122);
<a name="l01322"></a>01322         } <span class="keywordflow">else</span> {
<a name="l01323"></a>01323                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> &gt;= 2) {
<a name="l01324"></a>01324                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x03), 0xFFBF, 0x40);
<a name="l01325"></a>01325                 }
<a name="l01326"></a>01326                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>,
<a name="l01327"></a>01327                             (<a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>) | 0x2000));
<a name="l01328"></a>01328         }
<a name="l01329"></a>01329 
<a name="l01330"></a>01330         rcc = <a class="code" href="phy__g_8c.html#aead51b98172258d1e1331adfbb4d15ad">b43_radio_core_calibration_value</a>(dev);
<a name="l01331"></a>01331 
<a name="l01332"></a>01332         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#ae6fb3c6c5a205544eb5f7fa167c508ca">B43_PHYTYPE_B</a>)
<a name="l01333"></a>01333                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x78, 0x26);
<a name="l01334"></a>01334         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01335"></a>01335                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01336"></a>01336                               <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01337"></a>01337                                                    <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 1, 1)));
<a name="l01338"></a>01338         }
<a name="l01339"></a>01339         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xBFAF);
<a name="l01340"></a>01340         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x2B), 0x1403);
<a name="l01341"></a>01341         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01342"></a>01342                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01343"></a>01343                               <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01344"></a>01344                                                    <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(0, 0, 1)));
<a name="l01345"></a>01345         }
<a name="l01346"></a>01346         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xBFA0);
<a name="l01347"></a>01347         <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x51, 0x0004);
<a name="l01348"></a>01348         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l01349"></a>01349                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x43, 0x1F);
<a name="l01350"></a>01350         } <span class="keywordflow">else</span> {
<a name="l01351"></a>01351                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x52, 0);
<a name="l01352"></a>01352                 <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(dev, 0x43, 0xFFF0, 0x0009);
<a name="l01353"></a>01353         }
<a name="l01354"></a>01354         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58), 0);
<a name="l01355"></a>01355 
<a name="l01356"></a>01356         <span class="keywordflow">for</span> (i = 0; i &lt; 16; i++) {
<a name="l01357"></a>01357                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x5A), 0x0480);
<a name="l01358"></a>01358                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x59), 0xC810);
<a name="l01359"></a>01359                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58), 0x000D);
<a name="l01360"></a>01360                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01361"></a>01361                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01362"></a>01362                                       <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev,
<a name="l01363"></a>01363                                                            <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01364"></a>01364                                                            <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 1)));
<a name="l01365"></a>01365                 }
<a name="l01366"></a>01366                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xAFB0);
<a name="l01367"></a>01367                 udelay(10);
<a name="l01368"></a>01368                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01369"></a>01369                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01370"></a>01370                                       <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev,
<a name="l01371"></a>01371                                                            <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01372"></a>01372                                                            <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 1)));
<a name="l01373"></a>01373                 }
<a name="l01374"></a>01374                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xEFB0);
<a name="l01375"></a>01375                 udelay(10);
<a name="l01376"></a>01376                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01377"></a>01377                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01378"></a>01378                                       <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev,
<a name="l01379"></a>01379                                                            <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01380"></a>01380                                                            <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 0)));
<a name="l01381"></a>01381                 }
<a name="l01382"></a>01382                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xFFF0);
<a name="l01383"></a>01383                 udelay(20);
<a name="l01384"></a>01384                 tmp1 += <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a658b1c5cb5303b91d06411a39789ac46">B43_PHY_LO_LEAKAGE</a>);
<a name="l01385"></a>01385                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58), 0);
<a name="l01386"></a>01386                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01387"></a>01387                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01388"></a>01388                                       <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev,
<a name="l01389"></a>01389                                                            <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01390"></a>01390                                                            <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0, 1)));
<a name="l01391"></a>01391                 }
<a name="l01392"></a>01392                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xAFB0);
<a name="l01393"></a>01393         }
<a name="l01394"></a>01394         udelay(10);
<a name="l01395"></a>01395 
<a name="l01396"></a>01396         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58), 0);
<a name="l01397"></a>01397         tmp1++;
<a name="l01398"></a>01398         tmp1 &gt;&gt;= 9;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400         <span class="keywordflow">for</span> (i = 0; i &lt; 16; i++) {
<a name="l01401"></a>01401                 radio78 = (<a class="code" href="phy__g_8c.html#a6e2516a2956f95f7b875c1ecd009a215">bitrev4</a>(i) &lt;&lt; 1) | 0x0020;
<a name="l01402"></a>01402                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x78, radio78);
<a name="l01403"></a>01403                 udelay(10);
<a name="l01404"></a>01404                 <span class="keywordflow">for</span> (j = 0; j &lt; 16; j++) {
<a name="l01405"></a>01405                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x5A), 0x0D80);
<a name="l01406"></a>01406                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x59), 0xC810);
<a name="l01407"></a>01407                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58), 0x000D);
<a name="l01408"></a>01408                         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01409"></a>01409                                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01410"></a>01410                                               <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev,
<a name="l01411"></a>01411                                                                    <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01412"></a>01412                                                                    <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0,
<a name="l01413"></a>01413                                                                        1)));
<a name="l01414"></a>01414                         }
<a name="l01415"></a>01415                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xAFB0);
<a name="l01416"></a>01416                         udelay(10);
<a name="l01417"></a>01417                         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01418"></a>01418                                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01419"></a>01419                                               <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev,
<a name="l01420"></a>01420                                                                    <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01421"></a>01421                                                                    <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0,
<a name="l01422"></a>01422                                                                        1)));
<a name="l01423"></a>01423                         }
<a name="l01424"></a>01424                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xEFB0);
<a name="l01425"></a>01425                         udelay(10);
<a name="l01426"></a>01426                         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01427"></a>01427                                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01428"></a>01428                                               <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev,
<a name="l01429"></a>01429                                                                    <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01430"></a>01430                                                                    <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0,
<a name="l01431"></a>01431                                                                        0)));
<a name="l01432"></a>01432                         }
<a name="l01433"></a>01433                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xFFF0);
<a name="l01434"></a>01434                         udelay(10);
<a name="l01435"></a>01435                         tmp2 += <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a658b1c5cb5303b91d06411a39789ac46">B43_PHY_LO_LEAKAGE</a>);
<a name="l01436"></a>01436                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58), 0);
<a name="l01437"></a>01437                         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01438"></a>01438                                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01439"></a>01439                                               <a class="code" href="phy__g_8c.html#a654b09574cc82cc107f55a7253d6ffd2">radio2050_rfover_val</a>(dev,
<a name="l01440"></a>01440                                                                    <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l01441"></a>01441                                                                    <a class="code" href="phy__g_8c.html#ae51ef217f111c103e81e3428f62f7ec3">LPD</a>(1, 0,
<a name="l01442"></a>01442                                                                        1)));
<a name="l01443"></a>01443                         }
<a name="l01444"></a>01444                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xAFB0);
<a name="l01445"></a>01445                 }
<a name="l01446"></a>01446                 tmp2++;
<a name="l01447"></a>01447                 tmp2 &gt;&gt;= 8;
<a name="l01448"></a>01448                 <span class="keywordflow">if</span> (tmp1 &lt; tmp2)
<a name="l01449"></a>01449                         <span class="keywordflow">break</span>;
<a name="l01450"></a>01450         }
<a name="l01451"></a>01451 
<a name="l01452"></a>01452         <span class="comment">/* Restore the registers */</span>
<a name="l01453"></a>01453         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, sav.<a class="code" href="structinit2050__saved__values.html#a07f065dd30b501f962fb0b4c5354fe6e">phy_pgactl</a>);
<a name="l01454"></a>01454         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x51, sav.<a class="code" href="structinit2050__saved__values.html#aa5d6437b25eafa70619bed5fd51805aa">radio_51</a>);
<a name="l01455"></a>01455         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x52, sav.<a class="code" href="structinit2050__saved__values.html#ab40680b36ab60622f6482a8878875745">radio_52</a>);
<a name="l01456"></a>01456         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x43, sav.<a class="code" href="structinit2050__saved__values.html#a3aed1c45169c1ddd1ac1615c73f41f29">radio_43</a>);
<a name="l01457"></a>01457         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x5A), sav.<a class="code" href="structinit2050__saved__values.html#a7abf4a1402f86c1cc612f8e06ae3ef00">phy_cck_5A</a>);
<a name="l01458"></a>01458         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x59), sav.<a class="code" href="structinit2050__saved__values.html#a57a9825d42573317f8310a40b4150742">phy_cck_59</a>);
<a name="l01459"></a>01459         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58), sav.<a class="code" href="structinit2050__saved__values.html#a8af5876bc0d244607b04a6741dc2785d">phy_cck_58</a>);
<a name="l01460"></a>01460         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x3E6, sav.<a class="code" href="structinit2050__saved__values.html#a645c734e19452025dfba14d902705a8d">reg_3E6</a>);
<a name="l01461"></a>01461         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> != 0)
<a name="l01462"></a>01462                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x3F4, sav.<a class="code" href="structinit2050__saved__values.html#a6b01c28df43b59204b18c0445aa6f6ab">reg_3F4</a>);
<a name="l01463"></a>01463         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ac289073dd817b50ab1a9f76681dc90db">B43_PHY_SYNCCTL</a>, sav.<a class="code" href="structinit2050__saved__values.html#ae216dc760c0a34303b25b1581e706f91">phy_syncctl</a>);
<a name="l01464"></a>01464         <a class="code" href="phy__g_8c.html#a070256ea5337a006d3db2c1b097bd364">b43_synth_pu_workaround</a>(dev, phy-&gt;<a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a>);
<a name="l01465"></a>01465         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#ae6fb3c6c5a205544eb5f7fa167c508ca">B43_PHYTYPE_B</a>) {
<a name="l01466"></a>01466                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x30), sav.<a class="code" href="structinit2050__saved__values.html#af1373a2bc1e2fd046d634f7f07788506">phy_cck_30</a>);
<a name="l01467"></a>01467                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x3EC, sav.<a class="code" href="structinit2050__saved__values.html#ac553f48c3a06f401d35a258a302dd6a5">reg_3EC</a>);
<a name="l01468"></a>01468         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a>) {
<a name="l01469"></a>01469                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a49adf940af3a9315320ba1fff6737503">B43_MMIO_PHY_RADIO</a>,
<a name="l01470"></a>01470                             <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a49adf940af3a9315320ba1fff6737503">B43_MMIO_PHY_RADIO</a>)
<a name="l01471"></a>01471                             &amp; 0x7FFF);
<a name="l01472"></a>01472                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, sav.<a class="code" href="structinit2050__saved__values.html#ac63be03f343541101c7e1fdb8ba33e9f">phy_rfover</a>);
<a name="l01473"></a>01473                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, sav.<a class="code" href="structinit2050__saved__values.html#a28847c5e7de01c52dfa90122b2e0bac7">phy_rfoverval</a>);
<a name="l01474"></a>01474                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#aa4175032f0875ab8ee0fbb32d9c9c855">B43_PHY_ANALOGOVER</a>, sav.<a class="code" href="structinit2050__saved__values.html#ae72e66b13ac7a76a3c656bd4cae56979">phy_analogover</a>);
<a name="l01475"></a>01475                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ab2a59a9c96fa0eb33d3285f0fb7ae4af">B43_PHY_ANALOGOVERVAL</a>,
<a name="l01476"></a>01476                               sav.<a class="code" href="structinit2050__saved__values.html#a895372c499f8d2d0df875266d235e84b">phy_analogoverval</a>);
<a name="l01477"></a>01477                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__a_8h.html#aaa442f04ce83f557d193d1f18d003c4a">B43_PHY_CRS0</a>, sav.<a class="code" href="structinit2050__saved__values.html#af5b49b614e7bbe623e8b0abdbfc65db4">phy_crs0</a>);
<a name="l01478"></a>01478                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ab923cd1cbd1b3e38d632df0fe4aeee5e">B43_PHY_CLASSCTL</a>, sav.<a class="code" href="structinit2050__saved__values.html#acf8e7222ae3b050a4e4ee6c6535c7f6b">phy_classctl</a>);
<a name="l01479"></a>01479                 <span class="keywordflow">if</span> (<a class="code" href="phy__g_8h.html#ab859737bd92d2e1ccc98b8039310df06">has_loopback_gain</a>(phy)) {
<a name="l01480"></a>01480                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad6a8817e21e5c59887a73091e876304c">B43_PHY_LO_MASK</a>, sav.<a class="code" href="structinit2050__saved__values.html#aafcbdd15ea5d15c08f92bb27e1f18c56">phy_lo_mask</a>);
<a name="l01481"></a>01481                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad802cb5dcb2b953c742717eb62c0df32">B43_PHY_LO_CTL</a>, sav.<a class="code" href="structinit2050__saved__values.html#aed607bee2a6f350d540666ff3e394351">phy_lo_ctl</a>);
<a name="l01482"></a>01482                 }
<a name="l01483"></a>01483         }
<a name="l01484"></a>01484         <span class="keywordflow">if</span> (i &gt; 15)
<a name="l01485"></a>01485                 ret = radio78;
<a name="l01486"></a>01486         <span class="keywordflow">else</span>
<a name="l01487"></a>01487                 ret = rcc;
<a name="l01488"></a>01488 
<a name="l01489"></a>01489         <span class="keywordflow">return</span> ret;
<a name="l01490"></a>01490 }
<a name="l01491"></a>01491 
<a name="l01492"></a><a class="code" href="phy__g_8c.html#a6d6d6b12da6b75d5b931f547223477f0">01492</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a6d6d6b12da6b75d5b931f547223477f0">b43_phy_initb5</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l01493"></a>01493 {
<a name="l01494"></a>01494         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01495"></a>01495         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l01496"></a>01496         u16 offset, value;
<a name="l01497"></a>01497         u8 old_channel;
<a name="l01498"></a>01498 
<a name="l01499"></a>01499         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> == 1) {
<a name="l01500"></a>01500                 <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x0050);
<a name="l01501"></a>01501         }
<a name="l01502"></a>01502         <span class="keywordflow">if</span> ((dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a7b61688d8f77fe253308150f344eb259">board_vendor</a> != SSB_BOARDVENDOR_BCM) &amp;&amp;
<a name="l01503"></a>01503             (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a8225eee827fd5a0c40849625fbf88330">board_type</a> != SSB_BOARD_BU4306)) {
<a name="l01504"></a>01504                 value = 0x2120;
<a name="l01505"></a>01505                 <span class="keywordflow">for</span> (offset = 0x00A8; offset &lt; 0x00C7; offset++) {
<a name="l01506"></a>01506                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, offset, value);
<a name="l01507"></a>01507                         value += 0x202;
<a name="l01508"></a>01508                 }
<a name="l01509"></a>01509         }
<a name="l01510"></a>01510         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0035, 0xF0FF, 0x0700);
<a name="l01511"></a>01511         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050)
<a name="l01512"></a>01512                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0038, 0x0667);
<a name="l01513"></a>01513 
<a name="l01514"></a>01514         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l01515"></a>01515                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050) {
<a name="l01516"></a>01516                         <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x0020);
<a name="l01517"></a>01517                         <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x0051, 0x0004);
<a name="l01518"></a>01518                 }
<a name="l01519"></a>01519                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a49adf940af3a9315320ba1fff6737503">B43_MMIO_PHY_RADIO</a>, 0x0000);
<a name="l01520"></a>01520 
<a name="l01521"></a>01521                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0802, 0x0100);
<a name="l01522"></a>01522                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x042B, 0x2000);
<a name="l01523"></a>01523 
<a name="l01524"></a>01524                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x001C, 0x186A);
<a name="l01525"></a>01525 
<a name="l01526"></a>01526                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0013, 0x00FF, 0x1900);
<a name="l01527"></a>01527                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0035, 0xFFC0, 0x0064);
<a name="l01528"></a>01528                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x005D, 0xFF80, 0x000A);
<a name="l01529"></a>01529         }
<a name="l01530"></a>01530 
<a name="l01531"></a>01531         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#a2c26ad0ae99a136ef7bdd5e8d6e94ea9">bad_frames_preempt</a>) {
<a name="l01532"></a>01532                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="b43_8h.html#af635b5c82d121755f480afc25339dc7e">B43_PHY_RADIO_BITFIELD</a>, (1 &lt;&lt; 11));
<a name="l01533"></a>01533         }
<a name="l01534"></a>01534 
<a name="l01535"></a>01535         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> == 1) {
<a name="l01536"></a>01536                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0026, 0xCE00);
<a name="l01537"></a>01537                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0021, 0x3763);
<a name="l01538"></a>01538                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0022, 0x1BC3);
<a name="l01539"></a>01539                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0023, 0x06F9);
<a name="l01540"></a>01540                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0024, 0x037E);
<a name="l01541"></a>01541         } <span class="keywordflow">else</span>
<a name="l01542"></a>01542                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0026, 0xCC00);
<a name="l01543"></a>01543         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0030, 0x00C6);
<a name="l01544"></a>01544         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x03EC, 0x3F22);
<a name="l01545"></a>01545 
<a name="l01546"></a>01546         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> == 1)
<a name="l01547"></a>01547                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0020, 0x3E1C);
<a name="l01548"></a>01548         <span class="keywordflow">else</span>
<a name="l01549"></a>01549                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0020, 0x301C);
<a name="l01550"></a>01550 
<a name="l01551"></a>01551         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> == 0)
<a name="l01552"></a>01552                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x03E4, 0x3000);
<a name="l01553"></a>01553 
<a name="l01554"></a>01554         old_channel = phy-&gt;<a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a>;
<a name="l01555"></a>01555         <span class="comment">/* Force to channel 7, even if not supported. */</span>
<a name="l01556"></a>01556         <a class="code" href="phy__g_8c.html#a4e931bb71fda25ccefc366105e9f6e8f">b43_gphy_channel_switch</a>(dev, 7, 0);
<a name="l01557"></a>01557 
<a name="l01558"></a>01558         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> != 0x2050) {
<a name="l01559"></a>01559                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0075, 0x0080);
<a name="l01560"></a>01560                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0079, 0x0081);
<a name="l01561"></a>01561         }
<a name="l01562"></a>01562 
<a name="l01563"></a>01563         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0050, 0x0020);
<a name="l01564"></a>01564         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0050, 0x0023);
<a name="l01565"></a>01565 
<a name="l01566"></a>01566         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050) {
<a name="l01567"></a>01567                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0050, 0x0020);
<a name="l01568"></a>01568                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x005A, 0x0070);
<a name="l01569"></a>01569         }
<a name="l01570"></a>01570 
<a name="l01571"></a>01571         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x005B, 0x007B);
<a name="l01572"></a>01572         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x005C, 0x00B0);
<a name="l01573"></a>01573 
<a name="l01574"></a>01574         <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x0007);
<a name="l01575"></a>01575 
<a name="l01576"></a>01576         <a class="code" href="phy__g_8c.html#a4e931bb71fda25ccefc366105e9f6e8f">b43_gphy_channel_switch</a>(dev, old_channel, 0);
<a name="l01577"></a>01577 
<a name="l01578"></a>01578         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0014, 0x0080);
<a name="l01579"></a>01579         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0032, 0x00CA);
<a name="l01580"></a>01580         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002A, 0x88A3);
<a name="l01581"></a>01581 
<a name="l01582"></a>01582         <a class="code" href="phy__g_8c.html#a0e0f5052d0931d6fb44784874cc9235a">b43_set_txpower_g</a>(dev, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>, gphy-&gt;<a class="code" href="structb43__phy__g.html#a517345f9708b14fe2280a1fe5fe69b2a">tx_control</a>);
<a name="l01583"></a>01583 
<a name="l01584"></a>01584         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050)
<a name="l01585"></a>01585                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x005D, 0x000D);
<a name="l01586"></a>01586 
<a name="l01587"></a>01587         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x03E4, (<a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, 0x03E4) &amp; 0xFFC0) | 0x0004);
<a name="l01588"></a>01588 }
<a name="l01589"></a>01589 
<a name="l01590"></a><a class="code" href="phy__g_8c.html#a7685c1485966df2ffd99a2941933cca4">01590</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a7685c1485966df2ffd99a2941933cca4">b43_phy_initb6</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l01591"></a>01591 {
<a name="l01592"></a>01592         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01593"></a>01593         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l01594"></a>01594         u16 offset, val;
<a name="l01595"></a>01595         u8 old_channel;
<a name="l01596"></a>01596 
<a name="l01597"></a>01597         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x003E, 0x817A);
<a name="l01598"></a>01598         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x007A,
<a name="l01599"></a>01599                           (<a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x007A) | 0x0058));
<a name="l01600"></a>01600         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 4 || phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 5) {
<a name="l01601"></a>01601                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x51, 0x37);
<a name="l01602"></a>01602                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x52, 0x70);
<a name="l01603"></a>01603                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x53, 0xB3);
<a name="l01604"></a>01604                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x54, 0x9B);
<a name="l01605"></a>01605                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5A, 0x88);
<a name="l01606"></a>01606                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5B, 0x88);
<a name="l01607"></a>01607                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5D, 0x88);
<a name="l01608"></a>01608                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5E, 0x88);
<a name="l01609"></a>01609                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x7D, 0x88);
<a name="l01610"></a>01610                 <a class="code" href="main_8c.html#abbb7dc97d3d48c3504e1c35b366407ad">b43_hf_write</a>(dev, <a class="code" href="main_8c.html#a3f3a1d36e1882927e495fa890efbbe97">b43_hf_read</a>(dev)
<a name="l01611"></a>01611                              | <a class="code" href="b43_8h.html#a1c1437bf08622f44b08f28f77d487338">B43_HF_TSSIRPSMW</a>);
<a name="l01612"></a>01612         }
<a name="l01613"></a>01613         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 6 || phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 7);        <span class="comment">/* We had code for these revs here... */</span>
<a name="l01614"></a>01614         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l01615"></a>01615                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x51, 0);
<a name="l01616"></a>01616                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x52, 0x40);
<a name="l01617"></a>01617                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x53, 0xB7);
<a name="l01618"></a>01618                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x54, 0x98);
<a name="l01619"></a>01619                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5A, 0x88);
<a name="l01620"></a>01620                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5B, 0x6B);
<a name="l01621"></a>01621                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5C, 0x0F);
<a name="l01622"></a>01622                 <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;boardflags_lo &amp; <a class="code" href="b43_8h.html#ad57df1b381919a93316c3a509fda9a46">B43_BFL_ALTIQ</a>) {
<a name="l01623"></a>01623                         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5D, 0xFA);
<a name="l01624"></a>01624                         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5E, 0xD8);
<a name="l01625"></a>01625                 } <span class="keywordflow">else</span> {
<a name="l01626"></a>01626                         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5D, 0xF5);
<a name="l01627"></a>01627                         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5E, 0xB8);
<a name="l01628"></a>01628                 }
<a name="l01629"></a>01629                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0073, 0x0003);
<a name="l01630"></a>01630                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x007D, 0x00A8);
<a name="l01631"></a>01631                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x007C, 0x0001);
<a name="l01632"></a>01632                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x007E, 0x0008);
<a name="l01633"></a>01633         }
<a name="l01634"></a>01634         val = 0x1E1F;
<a name="l01635"></a>01635         <span class="keywordflow">for</span> (offset = 0x0088; offset &lt; 0x0098; offset++) {
<a name="l01636"></a>01636                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, offset, val);
<a name="l01637"></a>01637                 val -= 0x0202;
<a name="l01638"></a>01638         }
<a name="l01639"></a>01639         val = 0x3E3F;
<a name="l01640"></a>01640         <span class="keywordflow">for</span> (offset = 0x0098; offset &lt; 0x00A8; offset++) {
<a name="l01641"></a>01641                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, offset, val);
<a name="l01642"></a>01642                 val -= 0x0202;
<a name="l01643"></a>01643         }
<a name="l01644"></a>01644         val = 0x2120;
<a name="l01645"></a>01645         <span class="keywordflow">for</span> (offset = 0x00A8; offset &lt; 0x00C8; offset++) {
<a name="l01646"></a>01646                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, offset, (val &amp; 0x3F3F));
<a name="l01647"></a>01647                 val += 0x0202;
<a name="l01648"></a>01648         }
<a name="l01649"></a>01649         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>) {
<a name="l01650"></a>01650                 <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x007A, 0x0020);
<a name="l01651"></a>01651                 <a class="code" href="phy__common_8c.html#a2d71a0cd69c04c73275668125a89651e">b43_radio_set</a>(dev, 0x0051, 0x0004);
<a name="l01652"></a>01652                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0802, 0x0100);
<a name="l01653"></a>01653                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x042B, 0x2000);
<a name="l01654"></a>01654                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x5B, 0);
<a name="l01655"></a>01655                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x5C, 0);
<a name="l01656"></a>01656         }
<a name="l01657"></a>01657 
<a name="l01658"></a>01658         old_channel = phy-&gt;<a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a>;
<a name="l01659"></a>01659         <span class="keywordflow">if</span> (old_channel &gt;= 8)
<a name="l01660"></a>01660                 <a class="code" href="phy__g_8c.html#a4e931bb71fda25ccefc366105e9f6e8f">b43_gphy_channel_switch</a>(dev, 1, 0);
<a name="l01661"></a>01661         <span class="keywordflow">else</span>
<a name="l01662"></a>01662                 <a class="code" href="phy__g_8c.html#a4e931bb71fda25ccefc366105e9f6e8f">b43_gphy_channel_switch</a>(dev, 13, 0);
<a name="l01663"></a>01663 
<a name="l01664"></a>01664         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0050, 0x0020);
<a name="l01665"></a>01665         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0050, 0x0023);
<a name="l01666"></a>01666         udelay(40);
<a name="l01667"></a>01667         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> &lt; 6 || phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l01668"></a>01668                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x7C, (<a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x7C)
<a name="l01669"></a>01669                                               | 0x0002));
<a name="l01670"></a>01670                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x50, 0x20);
<a name="l01671"></a>01671         }
<a name="l01672"></a>01672         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> &lt;= 2) {
<a name="l01673"></a>01673                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x7C, 0x20);
<a name="l01674"></a>01674                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5A, 0x70);
<a name="l01675"></a>01675                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5B, 0x7B);
<a name="l01676"></a>01676                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x5C, 0xB0);
<a name="l01677"></a>01677         }
<a name="l01678"></a>01678         <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(dev, 0x007A, 0x00F8, 0x0007);
<a name="l01679"></a>01679 
<a name="l01680"></a>01680         <a class="code" href="phy__g_8c.html#a4e931bb71fda25ccefc366105e9f6e8f">b43_gphy_channel_switch</a>(dev, old_channel, 0);
<a name="l01681"></a>01681 
<a name="l01682"></a>01682         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0014, 0x0200);
<a name="l01683"></a>01683         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> &gt;= 6)
<a name="l01684"></a>01684                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x2A, 0x88C2);
<a name="l01685"></a>01685         <span class="keywordflow">else</span>
<a name="l01686"></a>01686                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x2A, 0x8AC0);
<a name="l01687"></a>01687         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0038, 0x0668);
<a name="l01688"></a>01688         <a class="code" href="phy__g_8c.html#a0e0f5052d0931d6fb44784874cc9235a">b43_set_txpower_g</a>(dev, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>, gphy-&gt;<a class="code" href="structb43__phy__g.html#a517345f9708b14fe2280a1fe5fe69b2a">tx_control</a>);
<a name="l01689"></a>01689         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> &lt;= 5) {
<a name="l01690"></a>01690                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x5D, 0xFF80, 0x0003);
<a name="l01691"></a>01691         }
<a name="l01692"></a>01692         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> &lt;= 2)
<a name="l01693"></a>01693                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x005D, 0x000D);
<a name="l01694"></a>01694 
<a name="l01695"></a>01695         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> == 4) {
<a name="l01696"></a>01696                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x3E4, 9);
<a name="l01697"></a>01697                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x61, 0x0FFF);
<a name="l01698"></a>01698         } <span class="keywordflow">else</span> {
<a name="l01699"></a>01699                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0002, 0xFFC0, 0x0004);
<a name="l01700"></a>01700         }
<a name="l01701"></a>01701         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#ae6fb3c6c5a205544eb5f7fa167c508ca">B43_PHYTYPE_B</a>)
<a name="l01702"></a>01702                 <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(1);
<a name="l01703"></a>01703         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>)
<a name="l01704"></a>01704                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, 0x03E6, 0x0);
<a name="l01705"></a>01705 }
<a name="l01706"></a>01706 
<a name="l01707"></a><a class="code" href="phy__g_8c.html#a7de7642c12bf37d081511ea1ec73252f">01707</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a7de7642c12bf37d081511ea1ec73252f">b43_calc_loopback_gain</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l01708"></a>01708 {
<a name="l01709"></a>01709         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01710"></a>01710         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l01711"></a>01711         u16 backup_phy[16] = { 0 };
<a name="l01712"></a>01712         u16 backup_radio[3];
<a name="l01713"></a>01713         u16 backup_bband;
<a name="l01714"></a>01714         u16 i, j, loop_i_max;
<a name="l01715"></a>01715         u16 trsw_rx;
<a name="l01716"></a>01716         u16 loop1_outer_done, loop1_inner_done;
<a name="l01717"></a>01717 
<a name="l01718"></a>01718         backup_phy[0] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__a_8h.html#aaa442f04ce83f557d193d1f18d003c4a">B43_PHY_CRS0</a>);
<a name="l01719"></a>01719         backup_phy[1] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a9312f3dccee5b550c0bd588d64722fe0">B43_PHY_CCKBBANDCFG</a>);
<a name="l01720"></a>01720         backup_phy[2] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>);
<a name="l01721"></a>01721         backup_phy[3] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>);
<a name="l01722"></a>01722         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {    <span class="comment">/* Not in specs, but needed to prevent PPC machine check */</span>
<a name="l01723"></a>01723                 backup_phy[4] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#aa4175032f0875ab8ee0fbb32d9c9c855">B43_PHY_ANALOGOVER</a>);
<a name="l01724"></a>01724                 backup_phy[5] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#ab2a59a9c96fa0eb33d3285f0fb7ae4af">B43_PHY_ANALOGOVERVAL</a>);
<a name="l01725"></a>01725         }
<a name="l01726"></a>01726         backup_phy[6] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x5A));
<a name="l01727"></a>01727         backup_phy[7] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x59));
<a name="l01728"></a>01728         backup_phy[8] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58));
<a name="l01729"></a>01729         backup_phy[9] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x0A));
<a name="l01730"></a>01730         backup_phy[10] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x03));
<a name="l01731"></a>01731         backup_phy[11] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#ad6a8817e21e5c59887a73091e876304c">B43_PHY_LO_MASK</a>);
<a name="l01732"></a>01732         backup_phy[12] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#ad802cb5dcb2b953c742717eb62c0df32">B43_PHY_LO_CTL</a>);
<a name="l01733"></a>01733         backup_phy[13] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x2B));
<a name="l01734"></a>01734         backup_phy[14] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>);
<a name="l01735"></a>01735         backup_phy[15] = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a658b1c5cb5303b91d06411a39789ac46">B43_PHY_LO_LEAKAGE</a>);
<a name="l01736"></a>01736         backup_bband = gphy-&gt;<a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>.<a class="code" href="structb43__bbatt.html#afb22eb36d414900b27a1cea58718e822">att</a>;
<a name="l01737"></a>01737         backup_radio[0] = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x52);
<a name="l01738"></a>01738         backup_radio[1] = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x43);
<a name="l01739"></a>01739         backup_radio[2] = <a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x7A);
<a name="l01740"></a>01740 
<a name="l01741"></a>01741         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__a_8h.html#aaa442f04ce83f557d193d1f18d003c4a">B43_PHY_CRS0</a>, 0x3FFF);
<a name="l01742"></a>01742         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a9312f3dccee5b550c0bd588d64722fe0">B43_PHY_CCKBBANDCFG</a>, 0x8000);
<a name="l01743"></a>01743         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, 0x0002);
<a name="l01744"></a>01744         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, 0xFFFD);
<a name="l01745"></a>01745         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, 0x0001);
<a name="l01746"></a>01746         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, 0xFFFE);
<a name="l01747"></a>01747         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {    <span class="comment">/* Not in specs, but needed to prevent PPC machine check */</span>
<a name="l01748"></a>01748                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#aa4175032f0875ab8ee0fbb32d9c9c855">B43_PHY_ANALOGOVER</a>, 0x0001);
<a name="l01749"></a>01749                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__g_8h.html#ab2a59a9c96fa0eb33d3285f0fb7ae4af">B43_PHY_ANALOGOVERVAL</a>, 0xFFFE);
<a name="l01750"></a>01750                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#aa4175032f0875ab8ee0fbb32d9c9c855">B43_PHY_ANALOGOVER</a>, 0x0002);
<a name="l01751"></a>01751                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__g_8h.html#ab2a59a9c96fa0eb33d3285f0fb7ae4af">B43_PHY_ANALOGOVERVAL</a>, 0xFFFD);
<a name="l01752"></a>01752         }
<a name="l01753"></a>01753         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, 0x000C);
<a name="l01754"></a>01754         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, 0x000C);
<a name="l01755"></a>01755         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, 0x0030);
<a name="l01756"></a>01756         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, 0xFFCF, 0x10);
<a name="l01757"></a>01757 
<a name="l01758"></a>01758         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x5A), 0x0780);
<a name="l01759"></a>01759         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x59), 0xC810);
<a name="l01760"></a>01760         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58), 0x000D);
<a name="l01761"></a>01761 
<a name="l01762"></a>01762         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x0A), 0x2000);
<a name="l01763"></a>01763         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {    <span class="comment">/* Not in specs, but needed to prevent PPC machine check */</span>
<a name="l01764"></a>01764                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#aa4175032f0875ab8ee0fbb32d9c9c855">B43_PHY_ANALOGOVER</a>, 0x0004);
<a name="l01765"></a>01765                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__g_8h.html#ab2a59a9c96fa0eb33d3285f0fb7ae4af">B43_PHY_ANALOGOVERVAL</a>, 0xFFFB);
<a name="l01766"></a>01766         }
<a name="l01767"></a>01767         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x03), 0xFF9F, 0x40);
<a name="l01768"></a>01768 
<a name="l01769"></a>01769         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l01770"></a>01770                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x43, 0x000F);
<a name="l01771"></a>01771         } <span class="keywordflow">else</span> {
<a name="l01772"></a>01772                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x52, 0);
<a name="l01773"></a>01773                 <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(dev, 0x43, 0xFFF0, 0x9);
<a name="l01774"></a>01774         }
<a name="l01775"></a>01775         <a class="code" href="phy__g_8c.html#a07f4d4a279fc43639adf2fe3e9e993d9">b43_gphy_set_baseband_attenuation</a>(dev, 11);
<a name="l01776"></a>01776 
<a name="l01777"></a>01777         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 3)
<a name="l01778"></a>01778                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad6a8817e21e5c59887a73091e876304c">B43_PHY_LO_MASK</a>, 0xC020);
<a name="l01779"></a>01779         <span class="keywordflow">else</span>
<a name="l01780"></a>01780                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad6a8817e21e5c59887a73091e876304c">B43_PHY_LO_MASK</a>, 0x8020);
<a name="l01781"></a>01781         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad802cb5dcb2b953c742717eb62c0df32">B43_PHY_LO_CTL</a>, 0);
<a name="l01782"></a>01782 
<a name="l01783"></a>01783         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x2B), 0xFFC0, 0x01);
<a name="l01784"></a>01784         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x2B), 0xC0FF, 0x800);
<a name="l01785"></a>01785 
<a name="l01786"></a>01786         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, 0x0100);
<a name="l01787"></a>01787         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, 0xCFFF);
<a name="l01788"></a>01788 
<a name="l01789"></a>01789         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;boardflags_lo &amp; <a class="code" href="b43_8h.html#a0d9d8affb2af07eb01d6097c34c56eee">B43_BFL_EXTLNA</a>) {
<a name="l01790"></a>01790                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 7) {
<a name="l01791"></a>01791                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, 0x0800);
<a name="l01792"></a>01792                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, 0x8000);
<a name="l01793"></a>01793                 }
<a name="l01794"></a>01794         }
<a name="l01795"></a>01795         <a class="code" href="phy__common_8c.html#aa0d4025c0760e0d0bd1529c62d1fff87">b43_radio_mask</a>(dev, 0x7A, 0x00F7);
<a name="l01796"></a>01796 
<a name="l01797"></a>01797         j = 0;
<a name="l01798"></a>01798         loop_i_max = (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) ? 15 : 9;
<a name="l01799"></a>01799         <span class="keywordflow">for</span> (i = 0; i &lt; loop_i_max; i++) {
<a name="l01800"></a>01800                 <span class="keywordflow">for</span> (j = 0; j &lt; 16; j++) {
<a name="l01801"></a>01801                         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x43, i);
<a name="l01802"></a>01802                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, 0xF0FF, (j &lt;&lt; 8));
<a name="l01803"></a>01803                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0x0FFF, 0xA000);
<a name="l01804"></a>01804                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xF000);
<a name="l01805"></a>01805                         udelay(20);
<a name="l01806"></a>01806                         <span class="keywordflow">if</span> (<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a658b1c5cb5303b91d06411a39789ac46">B43_PHY_LO_LEAKAGE</a>) &gt;= 0xDFC)
<a name="l01807"></a>01807                                 <span class="keywordflow">goto</span> exit_loop1;
<a name="l01808"></a>01808                 }
<a name="l01809"></a>01809         }
<a name="l01810"></a>01810       exit_loop1:
<a name="l01811"></a>01811         loop1_outer_done = i;
<a name="l01812"></a>01812         loop1_inner_done = j;
<a name="l01813"></a>01813         <span class="keywordflow">if</span> (j &gt;= 8) {
<a name="l01814"></a>01814                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, 0x30);
<a name="l01815"></a>01815                 trsw_rx = 0x1B;
<a name="l01816"></a>01816                 <span class="keywordflow">for</span> (j = j - 8; j &lt; 16; j++) {
<a name="l01817"></a>01817                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, 0xF0FF, (j &lt;&lt; 8));
<a name="l01818"></a>01818                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0x0FFF, 0xA000);
<a name="l01819"></a>01819                         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xF000);
<a name="l01820"></a>01820                         udelay(20);
<a name="l01821"></a>01821                         trsw_rx -= 3;
<a name="l01822"></a>01822                         <span class="keywordflow">if</span> (<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a658b1c5cb5303b91d06411a39789ac46">B43_PHY_LO_LEAKAGE</a>) &gt;= 0xDFC)
<a name="l01823"></a>01823                                 <span class="keywordflow">goto</span> exit_loop2;
<a name="l01824"></a>01824                 }
<a name="l01825"></a>01825         } <span class="keywordflow">else</span>
<a name="l01826"></a>01826                 trsw_rx = 0x18;
<a name="l01827"></a>01827       exit_loop2:
<a name="l01828"></a>01828 
<a name="l01829"></a>01829         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> != 1) {    <span class="comment">/* Not in specs, but needed to prevent PPC machine check */</span>
<a name="l01830"></a>01830                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#aa4175032f0875ab8ee0fbb32d9c9c855">B43_PHY_ANALOGOVER</a>, backup_phy[4]);
<a name="l01831"></a>01831                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ab2a59a9c96fa0eb33d3285f0fb7ae4af">B43_PHY_ANALOGOVERVAL</a>, backup_phy[5]);
<a name="l01832"></a>01832         }
<a name="l01833"></a>01833         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x5A), backup_phy[6]);
<a name="l01834"></a>01834         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x59), backup_phy[7]);
<a name="l01835"></a>01835         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x58), backup_phy[8]);
<a name="l01836"></a>01836         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x0A), backup_phy[9]);
<a name="l01837"></a>01837         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x03), backup_phy[10]);
<a name="l01838"></a>01838         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad6a8817e21e5c59887a73091e876304c">B43_PHY_LO_MASK</a>, backup_phy[11]);
<a name="l01839"></a>01839         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad802cb5dcb2b953c742717eb62c0df32">B43_PHY_LO_CTL</a>, backup_phy[12]);
<a name="l01840"></a>01840         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x2B), backup_phy[13]);
<a name="l01841"></a>01841         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, backup_phy[14]);
<a name="l01842"></a>01842 
<a name="l01843"></a>01843         <a class="code" href="phy__g_8c.html#a07f4d4a279fc43639adf2fe3e9e993d9">b43_gphy_set_baseband_attenuation</a>(dev, backup_bband);
<a name="l01844"></a>01844 
<a name="l01845"></a>01845         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x52, backup_radio[0]);
<a name="l01846"></a>01846         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x43, backup_radio[1]);
<a name="l01847"></a>01847         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x7A, backup_radio[2]);
<a name="l01848"></a>01848 
<a name="l01849"></a>01849         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, backup_phy[2] | 0x0003);
<a name="l01850"></a>01850         udelay(10);
<a name="l01851"></a>01851         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, backup_phy[2]);
<a name="l01852"></a>01852         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, backup_phy[3]);
<a name="l01853"></a>01853         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__a_8h.html#aaa442f04ce83f557d193d1f18d003c4a">B43_PHY_CRS0</a>, backup_phy[0]);
<a name="l01854"></a>01854         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a9312f3dccee5b550c0bd588d64722fe0">B43_PHY_CCKBBANDCFG</a>, backup_phy[1]);
<a name="l01855"></a>01855 
<a name="l01856"></a>01856         gphy-&gt;<a class="code" href="structb43__phy__g.html#a8db005657d3a8bd375ca88a1d73df5c8">max_lb_gain</a> =
<a name="l01857"></a>01857             ((loop1_inner_done * 6) - (loop1_outer_done * 4)) - 11;
<a name="l01858"></a>01858         gphy-&gt;<a class="code" href="structb43__phy__g.html#a30b2034a16220137d3d9dd224d859d19">trsw_rx_gain</a> = trsw_rx * 2;
<a name="l01859"></a>01859 }
<a name="l01860"></a>01860 
<a name="l01861"></a><a class="code" href="phy__g_8c.html#a105e36e329d7693afa7c31a1658e44ba">01861</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a105e36e329d7693afa7c31a1658e44ba">b43_hardware_pctl_early_init</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l01862"></a>01862 {
<a name="l01863"></a>01863         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01864"></a>01864 
<a name="l01865"></a>01865         <span class="keywordflow">if</span> (!<a class="code" href="phy__common_8c.html#afa362e73009d656f7574adbbfa0de0e2">b43_has_hardware_pctl</a>(dev)) {
<a name="l01866"></a>01866                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x047A, 0xC111);
<a name="l01867"></a>01867                 <span class="keywordflow">return</span>;
<a name="l01868"></a>01868         }
<a name="l01869"></a>01869 
<a name="l01870"></a>01870         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0036, 0xFEFF);
<a name="l01871"></a>01871         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002F, 0x0202);
<a name="l01872"></a>01872         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x047C, 0x0002);
<a name="l01873"></a>01873         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x047A, 0xF000);
<a name="l01874"></a>01874         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050 &amp;&amp; phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l01875"></a>01875                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x047A, 0xFF0F, 0x0010);
<a name="l01876"></a>01876                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x005D, 0x8000);
<a name="l01877"></a>01877                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x004E, 0xFFC0, 0x0010);
<a name="l01878"></a>01878                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002E, 0xC07F);
<a name="l01879"></a>01879                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0036, 0x0400);
<a name="l01880"></a>01880         } <span class="keywordflow">else</span> {
<a name="l01881"></a>01881                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0036, 0x0200);
<a name="l01882"></a>01882                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0036, 0x0400);
<a name="l01883"></a>01883                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x005D, 0x7FFF);
<a name="l01884"></a>01884                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x004F, 0xFFFE);
<a name="l01885"></a>01885                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x004E, 0xFFC0, 0x0010);
<a name="l01886"></a>01886                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x002E, 0xC07F);
<a name="l01887"></a>01887                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x047A, 0xFF0F, 0x0010);
<a name="l01888"></a>01888         }
<a name="l01889"></a>01889 }
<a name="l01890"></a>01890 
<a name="l01891"></a>01891 <span class="comment">/* Hardware power control for G-PHY */</span>
<a name="l01892"></a><a class="code" href="phy__g_8c.html#a70c2a59dd3fafeb94d93cfcd5f9adf52">01892</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a70c2a59dd3fafeb94d93cfcd5f9adf52">b43_hardware_pctl_init_gphy</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l01893"></a>01893 {
<a name="l01894"></a>01894         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01895"></a>01895         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l01896"></a>01896 
<a name="l01897"></a>01897         <span class="keywordflow">if</span> (!<a class="code" href="phy__common_8c.html#afa362e73009d656f7574adbbfa0de0e2">b43_has_hardware_pctl</a>(dev)) {
<a name="l01898"></a>01898                 <span class="comment">/* No hardware power control */</span>
<a name="l01899"></a>01899                 <a class="code" href="main_8c.html#abbb7dc97d3d48c3504e1c35b366407ad">b43_hf_write</a>(dev, <a class="code" href="main_8c.html#a3f3a1d36e1882927e495fa890efbbe97">b43_hf_read</a>(dev) &amp; ~<a class="code" href="b43_8h.html#ac49e1ee26966c4909796c4b36331dc9c">B43_HF_HWPCTL</a>);
<a name="l01900"></a>01900                 <span class="keywordflow">return</span>;
<a name="l01901"></a>01901         }
<a name="l01902"></a>01902 
<a name="l01903"></a>01903         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0036, 0xFFC0, (gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a> - gphy-&gt;<a class="code" href="structb43__phy__g.html#a55ded5b2fbe96f905cf19a1d9a6ecc37">cur_idle_tssi</a>));
<a name="l01904"></a>01904         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0478, 0xFF00, (gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a> - gphy-&gt;<a class="code" href="structb43__phy__g.html#a55ded5b2fbe96f905cf19a1d9a6ecc37">cur_idle_tssi</a>));
<a name="l01905"></a>01905         <a class="code" href="phy__g_8c.html#a3ff11c8c6d436ed712638390c7fa3009">b43_gphy_tssi_power_lt_init</a>(dev);
<a name="l01906"></a>01906         <a class="code" href="phy__g_8c.html#a655d85bd98fb83256f526345b6532032">b43_gphy_gain_lt_init</a>(dev);
<a name="l01907"></a>01907         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0060, 0xFFBF);
<a name="l01908"></a>01908         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0014, 0x0000);
<a name="l01909"></a>01909 
<a name="l01910"></a>01910         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt; 6);
<a name="l01911"></a>01911         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, 0x0478, 0x0800);
<a name="l01912"></a>01912         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0478, 0xFEFF);
<a name="l01913"></a>01913         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0801, 0xFFBF);
<a name="l01914"></a>01914 
<a name="l01915"></a>01915         <a class="code" href="lo_8c.html#ad01d93ae0114d300507af290d3bd1c3c">b43_gphy_dc_lt_init</a>(dev, 1);
<a name="l01916"></a>01916 
<a name="l01917"></a>01917         <span class="comment">/* Enable hardware pctl in firmware. */</span>
<a name="l01918"></a>01918         <a class="code" href="main_8c.html#abbb7dc97d3d48c3504e1c35b366407ad">b43_hf_write</a>(dev, <a class="code" href="main_8c.html#a3f3a1d36e1882927e495fa890efbbe97">b43_hf_read</a>(dev) | <a class="code" href="b43_8h.html#ac49e1ee26966c4909796c4b36331dc9c">B43_HF_HWPCTL</a>);
<a name="l01919"></a>01919 }
<a name="l01920"></a>01920 
<a name="l01921"></a>01921 <span class="comment">/* Initialize B/G PHY power control */</span>
<a name="l01922"></a><a class="code" href="phy__g_8c.html#a6a8dba67bfb712dcb6d04475b3f3b933">01922</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a6a8dba67bfb712dcb6d04475b3f3b933">b43_phy_init_pctl</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l01923"></a>01923 {
<a name="l01924"></a>01924         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01925"></a>01925         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l01926"></a>01926         <span class="keyword">struct </span><a class="code" href="structb43__rfatt.html">b43_rfatt</a> old_rfatt;
<a name="l01927"></a>01927         <span class="keyword">struct </span><a class="code" href="structb43__bbatt.html">b43_bbatt</a> old_bbatt;
<a name="l01928"></a>01928         u8 old_tx_control = 0;
<a name="l01929"></a>01929 
<a name="l01930"></a>01930         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> != <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>);
<a name="l01931"></a>01931 
<a name="l01932"></a>01932         <span class="keywordflow">if</span> ((dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a7b61688d8f77fe253308150f344eb259">board_vendor</a> == SSB_BOARDVENDOR_BCM) &amp;&amp;
<a name="l01933"></a>01933             (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a8225eee827fd5a0c40849625fbf88330">board_type</a> == SSB_BOARD_BU4306))
<a name="l01934"></a>01934                 <span class="keywordflow">return</span>;
<a name="l01935"></a>01935 
<a name="l01936"></a>01936         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0028, 0x8018);
<a name="l01937"></a>01937 
<a name="l01938"></a>01938         <span class="comment">/* This does something with the Analog... */</span>
<a name="l01939"></a>01939         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a1c562314febbe4c4477d45c7ee89521e">B43_MMIO_PHY0</a>, <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a1c562314febbe4c4477d45c7ee89521e">B43_MMIO_PHY0</a>)
<a name="l01940"></a>01940                     &amp; 0xFFDF);
<a name="l01941"></a>01941 
<a name="l01942"></a>01942         <span class="keywordflow">if</span> (!phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a>)
<a name="l01943"></a>01943                 <span class="keywordflow">return</span>;
<a name="l01944"></a>01944         <a class="code" href="phy__g_8c.html#a105e36e329d7693afa7c31a1658e44ba">b43_hardware_pctl_early_init</a>(dev);
<a name="l01945"></a>01945         <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#a55ded5b2fbe96f905cf19a1d9a6ecc37">cur_idle_tssi</a> == 0) {
<a name="l01946"></a>01946                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050 &amp;&amp; phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> == 0) {
<a name="l01947"></a>01947                         <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(dev, 0x0076, 0x00F7, 0x0084);
<a name="l01948"></a>01948                 } <span class="keywordflow">else</span> {
<a name="l01949"></a>01949                         <span class="keyword">struct </span><a class="code" href="structb43__rfatt.html">b43_rfatt</a> rfatt;
<a name="l01950"></a>01950                         <span class="keyword">struct </span><a class="code" href="structb43__bbatt.html">b43_bbatt</a> bbatt;
<a name="l01951"></a>01951 
<a name="l01952"></a>01952                         memcpy(&amp;old_rfatt, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>, <span class="keyword">sizeof</span>(old_rfatt));
<a name="l01953"></a>01953                         memcpy(&amp;old_bbatt, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>, <span class="keyword">sizeof</span>(old_bbatt));
<a name="l01954"></a>01954                         old_tx_control = gphy-&gt;<a class="code" href="structb43__phy__g.html#a517345f9708b14fe2280a1fe5fe69b2a">tx_control</a>;
<a name="l01955"></a>01955 
<a name="l01956"></a>01956                         bbatt.<a class="code" href="structb43__bbatt.html#afb22eb36d414900b27a1cea58718e822">att</a> = 11;
<a name="l01957"></a>01957                         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l01958"></a>01958                                 rfatt.<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 15;
<a name="l01959"></a>01959                                 rfatt.<a class="code" href="structb43__rfatt.html#a247ff931a7f936bed5cfb990f3d8ab89">with_padmix</a> = 1;
<a name="l01960"></a>01960                         } <span class="keywordflow">else</span> {
<a name="l01961"></a>01961                                 rfatt.<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 9;
<a name="l01962"></a>01962                                 rfatt.<a class="code" href="structb43__rfatt.html#a247ff931a7f936bed5cfb990f3d8ab89">with_padmix</a> = 0;
<a name="l01963"></a>01963                         }
<a name="l01964"></a>01964                         <a class="code" href="phy__g_8c.html#a0e0f5052d0931d6fb44784874cc9235a">b43_set_txpower_g</a>(dev, &amp;bbatt, &amp;rfatt, 0);
<a name="l01965"></a>01965                 }
<a name="l01966"></a>01966                 <a class="code" href="main_8c.html#a81f3a88ca0158a67ecadf6f38d9f6c4c">b43_dummy_transmission</a>(dev, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l01967"></a>01967                 gphy-&gt;<a class="code" href="structb43__phy__g.html#a55ded5b2fbe96f905cf19a1d9a6ecc37">cur_idle_tssi</a> = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a8c7c52a9c23feb63e81154c92ddecb7b">B43_PHY_ITSSI</a>);
<a name="l01968"></a>01968                 <span class="keywordflow">if</span> (<a class="code" href="b43_8h.html#a3e75683a6a0279e3277985c124a5dee0">B43_DEBUG</a>) {
<a name="l01969"></a>01969                         <span class="comment">/* Current-Idle-TSSI sanity check. */</span>
<a name="l01970"></a>01970                         <span class="keywordflow">if</span> (abs(gphy-&gt;<a class="code" href="structb43__phy__g.html#a55ded5b2fbe96f905cf19a1d9a6ecc37">cur_idle_tssi</a> - gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a>) &gt;= 20) {
<a name="l01971"></a>01971                                 <a class="code" href="main_8c.html#ac3164e7d1ba2fbd05fce755cdb232382">b43dbg</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>,
<a name="l01972"></a>01972                                        <span class="stringliteral">&quot;!WARNING! Idle-TSSI phy-&gt;cur_idle_tssi &quot;</span>
<a name="l01973"></a>01973                                        <span class="stringliteral">&quot;measuring failed. (cur=%d, tgt=%d). Disabling TX power &quot;</span>
<a name="l01974"></a>01974                                        <span class="stringliteral">&quot;adjustment.\n&quot;</span>, gphy-&gt;<a class="code" href="structb43__phy__g.html#a55ded5b2fbe96f905cf19a1d9a6ecc37">cur_idle_tssi</a>,
<a name="l01975"></a>01975                                        gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a>);
<a name="l01976"></a>01976                                 gphy-&gt;<a class="code" href="structb43__phy__g.html#a55ded5b2fbe96f905cf19a1d9a6ecc37">cur_idle_tssi</a> = 0;
<a name="l01977"></a>01977                         }
<a name="l01978"></a>01978                 }
<a name="l01979"></a>01979                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050 &amp;&amp; phy-&gt;<a class="code" href="structb43__phy.html#a923de05a46ccf74480374549f5111e94">analog</a> == 0) {
<a name="l01980"></a>01980                         <a class="code" href="phy__common_8c.html#aa0d4025c0760e0d0bd1529c62d1fff87">b43_radio_mask</a>(dev, 0x0076, 0xFF7B);
<a name="l01981"></a>01981                 } <span class="keywordflow">else</span> {
<a name="l01982"></a>01982                         <a class="code" href="phy__g_8c.html#a0e0f5052d0931d6fb44784874cc9235a">b43_set_txpower_g</a>(dev, &amp;old_bbatt,
<a name="l01983"></a>01983                                           &amp;old_rfatt, old_tx_control);
<a name="l01984"></a>01984                 }
<a name="l01985"></a>01985         }
<a name="l01986"></a>01986         <a class="code" href="phy__g_8c.html#a70c2a59dd3fafeb94d93cfcd5f9adf52">b43_hardware_pctl_init_gphy</a>(dev);
<a name="l01987"></a>01987         <a class="code" href="phy__g_8c.html#ac449cc1efdbb2780d326da08903dbb93">b43_shm_clear_tssi</a>(dev);
<a name="l01988"></a>01988 }
<a name="l01989"></a>01989 
<a name="l01990"></a><a class="code" href="phy__g_8c.html#a42f9ffc8234338b37e4b9cbef4431ef9">01990</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a42f9ffc8234338b37e4b9cbef4431ef9">b43_phy_initg</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l01991"></a>01991 {
<a name="l01992"></a>01992         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l01993"></a>01993         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l01994"></a>01994         u16 tmp;
<a name="l01995"></a>01995 
<a name="l01996"></a>01996         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 1)
<a name="l01997"></a>01997                 <a class="code" href="phy__g_8c.html#a6d6d6b12da6b75d5b931f547223477f0">b43_phy_initb5</a>(dev);
<a name="l01998"></a>01998         <span class="keywordflow">else</span>
<a name="l01999"></a>01999                 <a class="code" href="phy__g_8c.html#a7685c1485966df2ffd99a2941933cca4">b43_phy_initb6</a>(dev);
<a name="l02000"></a>02000 
<a name="l02001"></a>02001         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2 || phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a>)
<a name="l02002"></a>02002                 <a class="code" href="phy__a_8c.html#a472b16325b2baa5da716aa9af1484ff5">b43_phy_inita</a>(dev);
<a name="l02003"></a>02003 
<a name="l02004"></a>02004         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l02005"></a>02005                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#aa4175032f0875ab8ee0fbb32d9c9c855">B43_PHY_ANALOGOVER</a>, 0);
<a name="l02006"></a>02006                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ab2a59a9c96fa0eb33d3285f0fb7ae4af">B43_PHY_ANALOGOVERVAL</a>, 0);
<a name="l02007"></a>02007         }
<a name="l02008"></a>02008         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 2) {
<a name="l02009"></a>02009                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, 0);
<a name="l02010"></a>02010                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xC0);
<a name="l02011"></a>02011         }
<a name="l02012"></a>02012         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt; 5) {
<a name="l02013"></a>02013                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, 0x400);
<a name="l02014"></a>02014                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a6722a3a2e382c3dc392f9026bea94494">B43_PHY_PGACTL</a>, 0xC0);
<a name="l02015"></a>02015         }
<a name="l02016"></a>02016         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l02017"></a>02017                 tmp = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__a_8h.html#a83f619ca86c764b5251a515471f3ab71">B43_PHY_VERSION_OFDM</a>);
<a name="l02018"></a>02018                 tmp &amp;= <a class="code" href="phy__common_8h.html#a0ae2282888b1d4174378ca9f390c97da">B43_PHYVER_VERSION</a>;
<a name="l02019"></a>02019                 <span class="keywordflow">if</span> (tmp == 3 || tmp == 5) {
<a name="l02020"></a>02020                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#aa78dbabac223e0ea84f02dbf2c15d2b6">B43_PHY_OFDM</a>(0xC2), 0x1816);
<a name="l02021"></a>02021                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#aa78dbabac223e0ea84f02dbf2c15d2b6">B43_PHY_OFDM</a>(0xC3), 0x8006);
<a name="l02022"></a>02022                 }
<a name="l02023"></a>02023                 <span class="keywordflow">if</span> (tmp == 5) {
<a name="l02024"></a>02024                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__common_8h.html#aa78dbabac223e0ea84f02dbf2c15d2b6">B43_PHY_OFDM</a>(0xCC), 0x00FF, 0x1F00);
<a name="l02025"></a>02025                 }
<a name="l02026"></a>02026         }
<a name="l02027"></a>02027         <span class="keywordflow">if</span> ((phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt;= 2 &amp;&amp; phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a>) || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2)
<a name="l02028"></a>02028                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#aa78dbabac223e0ea84f02dbf2c15d2b6">B43_PHY_OFDM</a>(0x7E), 0x78);
<a name="l02029"></a>02029         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8) {
<a name="l02030"></a>02030                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__common_8h.html#a69020655dfd053bd1b7a3175b7fb52ee">B43_PHY_EXTG</a>(0x01), 0x80);
<a name="l02031"></a>02031                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__common_8h.html#aa78dbabac223e0ea84f02dbf2c15d2b6">B43_PHY_OFDM</a>(0x3E), 0x4);
<a name="l02032"></a>02032         }
<a name="l02033"></a>02033         <span class="keywordflow">if</span> (<a class="code" href="phy__g_8h.html#ab859737bd92d2e1ccc98b8039310df06">has_loopback_gain</a>(phy))
<a name="l02034"></a>02034                 <a class="code" href="phy__g_8c.html#a7de7642c12bf37d081511ea1ec73252f">b43_calc_loopback_gain</a>(dev);
<a name="l02035"></a>02035 
<a name="l02036"></a>02036         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> != 8) {
<a name="l02037"></a>02037                 <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#a4576ee5fb14c221f488540a7244ff621">initval</a> == 0xFFFF)
<a name="l02038"></a>02038                         gphy-&gt;<a class="code" href="structb43__phy__g.html#a4576ee5fb14c221f488540a7244ff621">initval</a> = <a class="code" href="phy__g_8c.html#abc1442fb27ab7e91f48f427ea05bdebc">b43_radio_init2050</a>(dev);
<a name="l02039"></a>02039                 <span class="keywordflow">else</span>
<a name="l02040"></a>02040                         <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x0078, gphy-&gt;<a class="code" href="structb43__phy__g.html#a4576ee5fb14c221f488540a7244ff621">initval</a>);
<a name="l02041"></a>02041         }
<a name="l02042"></a>02042         <a class="code" href="lo_8c.html#a701585eeace4289b5b4f88802e874f1f">b43_lo_g_init</a>(dev);
<a name="l02043"></a>02043         <span class="keywordflow">if</span> (<a class="code" href="phy__g_8h.html#a16f2a298c5abaa99472f056b83895b9a">has_tx_magnification</a>(phy)) {
<a name="l02044"></a>02044                 <a class="code" href="phy__common_8h.html#afb96ec591cb2ebd3580fb3074db0e3a0">b43_radio_write16</a>(dev, 0x52,
<a name="l02045"></a>02045                                   (<a class="code" href="phy__common_8h.html#a9a64ab2645598c7f0f5540311b76efbf">b43_radio_read16</a>(dev, 0x52) &amp; 0xFF00)
<a name="l02046"></a>02046                                   | gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>-&gt;<a class="code" href="structb43__txpower__lo__control.html#a4490f98b26e1acd94b828cd7c7ae9851">tx_bias</a> | gphy-&gt;
<a name="l02047"></a>02047                                   <a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>-&gt;<a class="code" href="structb43__txpower__lo__control.html#a749d31d68a3088e0fb913dbdfbc2cd76">tx_magn</a>);
<a name="l02048"></a>02048         } <span class="keywordflow">else</span> {
<a name="l02049"></a>02049                 <a class="code" href="phy__common_8c.html#a977aa8411429bf4468cff41f6020ea02">b43_radio_maskset</a>(dev, 0x52, 0xFFF0, gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>-&gt;<a class="code" href="structb43__txpower__lo__control.html#a4490f98b26e1acd94b828cd7c7ae9851">tx_bias</a>);
<a name="l02050"></a>02050         }
<a name="l02051"></a>02051         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 6) {
<a name="l02052"></a>02052                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x36), 0x0FFF, (gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>-&gt;<a class="code" href="structb43__txpower__lo__control.html#a4490f98b26e1acd94b828cd7c7ae9851">tx_bias</a> &lt;&lt; 12));
<a name="l02053"></a>02053         }
<a name="l02054"></a>02054         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;boardflags_lo &amp; <a class="code" href="b43_8h.html#a993dd426a8e8aaa54db354185804d762">B43_BFL_PACTRL</a>)
<a name="l02055"></a>02055                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x2E), 0x8075);
<a name="l02056"></a>02056         <span class="keywordflow">else</span>
<a name="l02057"></a>02057                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x2E), 0x807F);
<a name="l02058"></a>02058         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &lt; 2)
<a name="l02059"></a>02059                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x2F), 0x101);
<a name="l02060"></a>02060         <span class="keywordflow">else</span>
<a name="l02061"></a>02061                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a40dfff362352dccc49749badf7ad2bff">B43_PHY_CCK</a>(0x2F), 0x202);
<a name="l02062"></a>02062         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l02063"></a>02063                 <a class="code" href="lo_8c.html#a32522f98b89628f5b532cdb56c65b123">b43_lo_g_adjust</a>(dev);
<a name="l02064"></a>02064                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#ad6a8817e21e5c59887a73091e876304c">B43_PHY_LO_MASK</a>, 0x8078);
<a name="l02065"></a>02065         }
<a name="l02066"></a>02066 
<a name="l02067"></a>02067         <span class="keywordflow">if</span> (!(dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;boardflags_lo &amp; <a class="code" href="b43_8h.html#aa3662813d12e20a94f8af57b16cb45b5">B43_BFL_RSSI</a>)) {
<a name="l02068"></a>02068                 <span class="comment">/* The specs state to update the NRSSI LT with</span>
<a name="l02069"></a>02069 <span class="comment">                 * the value 0x7FFFFFFF here. I think that is some weird</span>
<a name="l02070"></a>02070 <span class="comment">                 * compiler optimization in the original driver.</span>
<a name="l02071"></a>02071 <span class="comment">                 * Essentially, what we do here is resetting all NRSSI LT</span>
<a name="l02072"></a>02072 <span class="comment">                 * entries to -32 (see the clamp_val() in nrssi_hw_update())</span>
<a name="l02073"></a>02073 <span class="comment">                 */</span>
<a name="l02074"></a>02074                 <a class="code" href="phy__g_8c.html#af288eaada6243d702227f01aa993d37e">b43_nrssi_hw_update</a>(dev, 0xFFFF);       <span class="comment">//FIXME?</span>
<a name="l02075"></a>02075                 <a class="code" href="phy__g_8c.html#a0c473583d8f3c46e081b1bb3834fa909">b43_calc_nrssi_threshold</a>(dev);
<a name="l02076"></a>02076         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> || phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l02077"></a>02077                 <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[0] == -1000) {
<a name="l02078"></a>02078                         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[1] != -1000);
<a name="l02079"></a>02079                         <a class="code" href="phy__g_8c.html#ae11eeb69eea9f510730039dd9a623140">b43_calc_nrssi_slope</a>(dev);
<a name="l02080"></a>02080                 } <span class="keywordflow">else</span>
<a name="l02081"></a>02081                         <a class="code" href="phy__g_8c.html#a0c473583d8f3c46e081b1bb3834fa909">b43_calc_nrssi_threshold</a>(dev);
<a name="l02082"></a>02082         }
<a name="l02083"></a>02083         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8)
<a name="l02084"></a>02084                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__common_8h.html#a69020655dfd053bd1b7a3175b7fb52ee">B43_PHY_EXTG</a>(0x05), 0x3230);
<a name="l02085"></a>02085         <a class="code" href="phy__g_8c.html#a6a8dba67bfb712dcb6d04475b3f3b933">b43_phy_init_pctl</a>(dev);
<a name="l02086"></a>02086         <span class="comment">/* FIXME: The spec says in the following if, the 0 should be replaced</span>
<a name="l02087"></a>02087 <span class="comment">           &#39;if OFDM may not be used in the current locale&#39;</span>
<a name="l02088"></a>02088 <span class="comment">           but OFDM is legal everywhere */</span>
<a name="l02089"></a>02089         <span class="keywordflow">if</span> ((dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#ae94b6ea704b3bbbc1a516badebe3d6b7">chip_id</a> == 0x4306
<a name="l02090"></a>02090              &amp;&amp; dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a314773125c4f88623863b065bf5f96d8">chip_pkg</a> == 2) || 0) {
<a name="l02091"></a>02091                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__a_8h.html#aaa442f04ce83f557d193d1f18d003c4a">B43_PHY_CRS0</a>, 0xBFFF);
<a name="l02092"></a>02092                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__common_8h.html#aa78dbabac223e0ea84f02dbf2c15d2b6">B43_PHY_OFDM</a>(0xC3), 0x7FFF);
<a name="l02093"></a>02093         }
<a name="l02094"></a>02094 }
<a name="l02095"></a>02095 
<a name="l02096"></a><a class="code" href="phy__g_8h.html#a4e931bb71fda25ccefc366105e9f6e8f">02096</a> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a4e931bb71fda25ccefc366105e9f6e8f">b43_gphy_channel_switch</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l02097"></a>02097                              <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> channel,
<a name="l02098"></a>02098                              <span class="keywordtype">bool</span> synthetic_pu_workaround)
<a name="l02099"></a>02099 {
<a name="l02100"></a>02100         <span class="keywordflow">if</span> (synthetic_pu_workaround)
<a name="l02101"></a>02101                 <a class="code" href="phy__g_8c.html#a070256ea5337a006d3db2c1b097bd364">b43_synth_pu_workaround</a>(dev, channel);
<a name="l02102"></a>02102 
<a name="l02103"></a>02103         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a881966bd6256b2cdcbdf5c76e2249456">B43_MMIO_CHANNEL</a>, <a class="code" href="phy__g_8c.html#acb3b7edd4a4c7aa7a635ee4812fd971b">channel2freq_bg</a>(channel));
<a name="l02104"></a>02104 
<a name="l02105"></a>02105         <span class="keywordflow">if</span> (channel == 14) {
<a name="l02106"></a>02106                 <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;country_code ==
<a name="l02107"></a>02107                     SSB_SPROM1CCODE_JAPAN)
<a name="l02108"></a>02108                         <a class="code" href="main_8c.html#abbb7dc97d3d48c3504e1c35b366407ad">b43_hf_write</a>(dev,
<a name="l02109"></a>02109                                      <a class="code" href="main_8c.html#a3f3a1d36e1882927e495fa890efbbe97">b43_hf_read</a>(dev) &amp; ~<a class="code" href="b43_8h.html#a33fe622a7c47370fed1274c4f71f7c36">B43_HF_ACPR</a>);
<a name="l02110"></a>02110                 <span class="keywordflow">else</span>
<a name="l02111"></a>02111                         <a class="code" href="main_8c.html#abbb7dc97d3d48c3504e1c35b366407ad">b43_hf_write</a>(dev,
<a name="l02112"></a>02112                                      <a class="code" href="main_8c.html#a3f3a1d36e1882927e495fa890efbbe97">b43_hf_read</a>(dev) | <a class="code" href="b43_8h.html#a33fe622a7c47370fed1274c4f71f7c36">B43_HF_ACPR</a>);
<a name="l02113"></a>02113                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>,
<a name="l02114"></a>02114                             <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>)
<a name="l02115"></a>02115                             | (1 &lt;&lt; 11));
<a name="l02116"></a>02116         } <span class="keywordflow">else</span> {
<a name="l02117"></a>02117                 <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>,
<a name="l02118"></a>02118                             <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a0acbc88c9e9e9da77987a51234d08879">B43_MMIO_CHANNEL_EXT</a>)
<a name="l02119"></a>02119                             &amp; 0xF7BF);
<a name="l02120"></a>02120         }
<a name="l02121"></a>02121 }
<a name="l02122"></a>02122 
<a name="l02123"></a><a class="code" href="phy__g_8c.html#a8283064707c4217deba43654c53ee31b">02123</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a8283064707c4217deba43654c53ee31b">default_baseband_attenuation</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l02124"></a>02124                                          <span class="keyword">struct</span> <a class="code" href="structb43__bbatt.html">b43_bbatt</a> *bb)
<a name="l02125"></a>02125 {
<a name="l02126"></a>02126         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02127"></a>02127 
<a name="l02128"></a>02128         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050 &amp;&amp; phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> &lt; 6)
<a name="l02129"></a>02129                 bb-&gt;<a class="code" href="structb43__bbatt.html#afb22eb36d414900b27a1cea58718e822">att</a> = 0;
<a name="l02130"></a>02130         <span class="keywordflow">else</span>
<a name="l02131"></a>02131                 bb-&gt;<a class="code" href="structb43__bbatt.html#afb22eb36d414900b27a1cea58718e822">att</a> = 2;
<a name="l02132"></a>02132 }
<a name="l02133"></a>02133 
<a name="l02134"></a><a class="code" href="phy__g_8c.html#aecbb9435ad1011e21a3e1b42c69e7553">02134</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#aecbb9435ad1011e21a3e1b42c69e7553">default_radio_attenuation</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l02135"></a>02135                                       <span class="keyword">struct</span> <a class="code" href="structb43__rfatt.html">b43_rfatt</a> *rf)
<a name="l02136"></a>02136 {
<a name="l02137"></a>02137         <span class="keyword">struct </span><a class="code" href="structb43__bus__dev.html">b43_bus_dev</a> *<a class="code" href="structb43__bus__dev.html#af89341f941e94abb2f8ac6e98dd5c101">bdev</a> = dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>;
<a name="l02138"></a>02138         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02139"></a>02139 
<a name="l02140"></a>02140         rf-&gt;<a class="code" href="structb43__rfatt.html#a247ff931a7f936bed5cfb990f3d8ab89">with_padmix</a> = 0;
<a name="l02141"></a>02141 
<a name="l02142"></a>02142         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a7b61688d8f77fe253308150f344eb259">board_vendor</a> == SSB_BOARDVENDOR_BCM &amp;&amp;
<a name="l02143"></a>02143             dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a8225eee827fd5a0c40849625fbf88330">board_type</a> == SSB_BOARD_BCM4309G) {
<a name="l02144"></a>02144                 <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a88860ae223915f56e0ab6eb933369046">board_rev</a> &lt; 0x43) {
<a name="l02145"></a>02145                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 2;
<a name="l02146"></a>02146                         <span class="keywordflow">return</span>;
<a name="l02147"></a>02147                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a88860ae223915f56e0ab6eb933369046">board_rev</a> &lt; 0x51) {
<a name="l02148"></a>02148                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 3;
<a name="l02149"></a>02149                         <span class="keywordflow">return</span>;
<a name="l02150"></a>02150                 }
<a name="l02151"></a>02151         }
<a name="l02152"></a>02152 
<a name="l02153"></a>02153         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#a625ec4d10755d18ef60ab7522c7a3e82">B43_PHYTYPE_A</a>) {
<a name="l02154"></a>02154                 rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 0x60;
<a name="l02155"></a>02155                 <span class="keywordflow">return</span>;
<a name="l02156"></a>02156         }
<a name="l02157"></a>02157 
<a name="l02158"></a>02158         <span class="keywordflow">switch</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a>) {
<a name="l02159"></a>02159         <span class="keywordflow">case</span> 0x2053:
<a name="l02160"></a>02160                 <span class="keywordflow">switch</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a>) {
<a name="l02161"></a>02161                 <span class="keywordflow">case</span> 1:
<a name="l02162"></a>02162                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 6;
<a name="l02163"></a>02163                         <span class="keywordflow">return</span>;
<a name="l02164"></a>02164                 }
<a name="l02165"></a>02165                 <span class="keywordflow">break</span>;
<a name="l02166"></a>02166         <span class="keywordflow">case</span> 0x2050:
<a name="l02167"></a>02167                 <span class="keywordflow">switch</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a>) {
<a name="l02168"></a>02168                 <span class="keywordflow">case</span> 0:
<a name="l02169"></a>02169                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 5;
<a name="l02170"></a>02170                         <span class="keywordflow">return</span>;
<a name="l02171"></a>02171                 <span class="keywordflow">case</span> 1:
<a name="l02172"></a>02172                         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>) {
<a name="l02173"></a>02173                                 <span class="keywordflow">if</span> (bdev-&gt;<a class="code" href="structb43__bus__dev.html#a7b61688d8f77fe253308150f344eb259">board_vendor</a> == SSB_BOARDVENDOR_BCM
<a name="l02174"></a>02174                                     &amp;&amp; bdev-&gt;<a class="code" href="structb43__bus__dev.html#a8225eee827fd5a0c40849625fbf88330">board_type</a> == SSB_BOARD_BCM4309G
<a name="l02175"></a>02175                                     &amp;&amp; bdev-&gt;<a class="code" href="structb43__bus__dev.html#a88860ae223915f56e0ab6eb933369046">board_rev</a> &gt;= 30)
<a name="l02176"></a>02176                                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 3;
<a name="l02177"></a>02177                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bdev-&gt;<a class="code" href="structb43__bus__dev.html#a7b61688d8f77fe253308150f344eb259">board_vendor</a> ==
<a name="l02178"></a>02178                                          SSB_BOARDVENDOR_BCM
<a name="l02179"></a>02179                                          &amp;&amp; bdev-&gt;<a class="code" href="structb43__bus__dev.html#a8225eee827fd5a0c40849625fbf88330">board_type</a> ==
<a name="l02180"></a>02180                                          SSB_BOARD_BU4306)
<a name="l02181"></a>02181                                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 3;
<a name="l02182"></a>02182                                 <span class="keywordflow">else</span>
<a name="l02183"></a>02183                                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 1;
<a name="l02184"></a>02184                         } <span class="keywordflow">else</span> {
<a name="l02185"></a>02185                                 <span class="keywordflow">if</span> (bdev-&gt;<a class="code" href="structb43__bus__dev.html#a7b61688d8f77fe253308150f344eb259">board_vendor</a> == SSB_BOARDVENDOR_BCM
<a name="l02186"></a>02186                                     &amp;&amp; bdev-&gt;<a class="code" href="structb43__bus__dev.html#a8225eee827fd5a0c40849625fbf88330">board_type</a> == SSB_BOARD_BCM4309G
<a name="l02187"></a>02187                                     &amp;&amp; bdev-&gt;<a class="code" href="structb43__bus__dev.html#a88860ae223915f56e0ab6eb933369046">board_rev</a> &gt;= 30)
<a name="l02188"></a>02188                                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 7;
<a name="l02189"></a>02189                                 <span class="keywordflow">else</span>
<a name="l02190"></a>02190                                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 6;
<a name="l02191"></a>02191                         }
<a name="l02192"></a>02192                         <span class="keywordflow">return</span>;
<a name="l02193"></a>02193                 <span class="keywordflow">case</span> 2:
<a name="l02194"></a>02194                         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>) {
<a name="l02195"></a>02195                                 <span class="keywordflow">if</span> (bdev-&gt;<a class="code" href="structb43__bus__dev.html#a7b61688d8f77fe253308150f344eb259">board_vendor</a> == SSB_BOARDVENDOR_BCM
<a name="l02196"></a>02196                                     &amp;&amp; bdev-&gt;<a class="code" href="structb43__bus__dev.html#a8225eee827fd5a0c40849625fbf88330">board_type</a> == SSB_BOARD_BCM4309G
<a name="l02197"></a>02197                                     &amp;&amp; bdev-&gt;<a class="code" href="structb43__bus__dev.html#a88860ae223915f56e0ab6eb933369046">board_rev</a> &gt;= 30)
<a name="l02198"></a>02198                                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 3;
<a name="l02199"></a>02199                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bdev-&gt;<a class="code" href="structb43__bus__dev.html#a7b61688d8f77fe253308150f344eb259">board_vendor</a> ==
<a name="l02200"></a>02200                                          SSB_BOARDVENDOR_BCM
<a name="l02201"></a>02201                                          &amp;&amp; bdev-&gt;<a class="code" href="structb43__bus__dev.html#a8225eee827fd5a0c40849625fbf88330">board_type</a> ==
<a name="l02202"></a>02202                                          SSB_BOARD_BU4306)
<a name="l02203"></a>02203                                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 5;
<a name="l02204"></a>02204                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bdev-&gt;<a class="code" href="structb43__bus__dev.html#ae94b6ea704b3bbbc1a516badebe3d6b7">chip_id</a> == 0x4320)
<a name="l02205"></a>02205                                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 4;
<a name="l02206"></a>02206                                 <span class="keywordflow">else</span>
<a name="l02207"></a>02207                                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 3;
<a name="l02208"></a>02208                         } <span class="keywordflow">else</span>
<a name="l02209"></a>02209                                 rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 6;
<a name="l02210"></a>02210                         <span class="keywordflow">return</span>;
<a name="l02211"></a>02211                 <span class="keywordflow">case</span> 3:
<a name="l02212"></a>02212                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 5;
<a name="l02213"></a>02213                         <span class="keywordflow">return</span>;
<a name="l02214"></a>02214                 <span class="keywordflow">case</span> 4:
<a name="l02215"></a>02215                 <span class="keywordflow">case</span> 5:
<a name="l02216"></a>02216                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 1;
<a name="l02217"></a>02217                         <span class="keywordflow">return</span>;
<a name="l02218"></a>02218                 <span class="keywordflow">case</span> 6:
<a name="l02219"></a>02219                 <span class="keywordflow">case</span> 7:
<a name="l02220"></a>02220                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 5;
<a name="l02221"></a>02221                         <span class="keywordflow">return</span>;
<a name="l02222"></a>02222                 <span class="keywordflow">case</span> 8:
<a name="l02223"></a>02223                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 0xA;
<a name="l02224"></a>02224                         rf-&gt;<a class="code" href="structb43__rfatt.html#a247ff931a7f936bed5cfb990f3d8ab89">with_padmix</a> = 1;
<a name="l02225"></a>02225                         <span class="keywordflow">return</span>;
<a name="l02226"></a>02226                 <span class="keywordflow">case</span> 9:
<a name="l02227"></a>02227                 <span class="keywordflow">default</span>:
<a name="l02228"></a>02228                         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 5;
<a name="l02229"></a>02229                         <span class="keywordflow">return</span>;
<a name="l02230"></a>02230                 }
<a name="l02231"></a>02231         }
<a name="l02232"></a>02232         rf-&gt;<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = 5;
<a name="l02233"></a>02233 }
<a name="l02234"></a>02234 
<a name="l02235"></a><a class="code" href="phy__g_8c.html#a3b4a331ba0b43dfe92c488d75784872a">02235</a> <span class="keyword">static</span> u16 <a class="code" href="phy__g_8c.html#a3b4a331ba0b43dfe92c488d75784872a">default_tx_control</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02236"></a>02236 {
<a name="l02237"></a>02237         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02238"></a>02238 
<a name="l02239"></a>02239         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> != 0x2050)
<a name="l02240"></a>02240                 <span class="keywordflow">return</span> 0;
<a name="l02241"></a>02241         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 1)
<a name="l02242"></a>02242                 <span class="keywordflow">return</span> <a class="code" href="phy__g_8h.html#a18559fa6d14f8bcafe2fb5138ec51e36">B43_TXCTL_PA2DB</a> | <a class="code" href="phy__g_8h.html#a8d9d46847cde6629e925371d02900e1c">B43_TXCTL_TXMIX</a>;
<a name="l02243"></a>02243         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> &lt; 6)
<a name="l02244"></a>02244                 <span class="keywordflow">return</span> <a class="code" href="phy__g_8h.html#a18559fa6d14f8bcafe2fb5138ec51e36">B43_TXCTL_PA2DB</a>;
<a name="l02245"></a>02245         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8)
<a name="l02246"></a>02246                 <span class="keywordflow">return</span> <a class="code" href="phy__g_8h.html#a8d9d46847cde6629e925371d02900e1c">B43_TXCTL_TXMIX</a>;
<a name="l02247"></a>02247         <span class="keywordflow">return</span> 0;
<a name="l02248"></a>02248 }
<a name="l02249"></a>02249 
<a name="l02250"></a><a class="code" href="phy__g_8c.html#ae8889197aeb95e3c670912be4e3e2523">02250</a> <span class="keyword">static</span> u8 <a class="code" href="phy__g_8c.html#ae8889197aeb95e3c670912be4e3e2523">b43_gphy_aci_detect</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u8 <a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a>)
<a name="l02251"></a>02251 {
<a name="l02252"></a>02252         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02253"></a>02253         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02254"></a>02254         u8 ret = 0;
<a name="l02255"></a>02255         u16 saved, rssi, temp;
<a name="l02256"></a>02256         <span class="keywordtype">int</span> i, j = 0;
<a name="l02257"></a>02257 
<a name="l02258"></a>02258         saved = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x0403);
<a name="l02259"></a>02259         <a class="code" href="phy__common_8c.html#a2efed98acfe2e35f6199b0e608e4a18c">b43_switch_channel</a>(dev, channel);
<a name="l02260"></a>02260         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0403, (saved &amp; 0xFFF8) | 5);
<a name="l02261"></a>02261         <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#af2c7dfaedff08187e616a71bcae3af20">aci_hw_rssi</a>)
<a name="l02262"></a>02262                 rssi = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x048A) &amp; 0x3F;
<a name="l02263"></a>02263         <span class="keywordflow">else</span>
<a name="l02264"></a>02264                 rssi = saved &amp; 0x3F;
<a name="l02265"></a>02265         <span class="comment">/* clamp temp to signed 5bit */</span>
<a name="l02266"></a>02266         <span class="keywordflow">if</span> (rssi &gt; 32)
<a name="l02267"></a>02267                 rssi -= 64;
<a name="l02268"></a>02268         <span class="keywordflow">for</span> (i = 0; i &lt; 100; i++) {
<a name="l02269"></a>02269                 temp = (<a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, 0x047F) &gt;&gt; 8) &amp; 0x3F;
<a name="l02270"></a>02270                 <span class="keywordflow">if</span> (temp &gt; 32)
<a name="l02271"></a>02271                         temp -= 64;
<a name="l02272"></a>02272                 <span class="keywordflow">if</span> (temp &lt; rssi)
<a name="l02273"></a>02273                         j++;
<a name="l02274"></a>02274                 <span class="keywordflow">if</span> (j &gt;= 20)
<a name="l02275"></a>02275                         ret = 1;
<a name="l02276"></a>02276         }
<a name="l02277"></a>02277         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0403, saved);
<a name="l02278"></a>02278 
<a name="l02279"></a>02279         <span class="keywordflow">return</span> ret;
<a name="l02280"></a>02280 }
<a name="l02281"></a>02281 
<a name="l02282"></a><a class="code" href="phy__g_8c.html#ae5b73dc14faa8b9f5971769251972ebb">02282</a> <span class="keyword">static</span> u8 <a class="code" href="phy__g_8c.html#ae5b73dc14faa8b9f5971769251972ebb">b43_gphy_aci_scan</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02283"></a>02283 {
<a name="l02284"></a>02284         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02285"></a>02285         u8 ret[13];
<a name="l02286"></a>02286         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a> = phy-&gt;<a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a>;
<a name="l02287"></a>02287         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, j, start, end;
<a name="l02288"></a>02288 
<a name="l02289"></a>02289         <span class="keywordflow">if</span> (!((phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> == <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>) &amp;&amp; (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt; 0)))
<a name="l02290"></a>02290                 <span class="keywordflow">return</span> 0;
<a name="l02291"></a>02291 
<a name="l02292"></a>02292         <a class="code" href="phy__common_8c.html#a91f8d6f96e8acab0a95ea26f5490eaa5">b43_phy_lock</a>(dev);
<a name="l02293"></a>02293         <a class="code" href="phy__common_8c.html#a00c24702245c80591279e889e287d79f">b43_radio_lock</a>(dev);
<a name="l02294"></a>02294         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0802, 0xFFFC);
<a name="l02295"></a>02295         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>, 0x7FFF);
<a name="l02296"></a>02296         <a class="code" href="phy__g_8c.html#ab57927fd6c0c7efa8408634ffb1baca1">b43_set_all_gains</a>(dev, 3, 8, 1);
<a name="l02297"></a>02297 
<a name="l02298"></a>02298         start = (channel - 5 &gt; 0) ? channel - 5 : 1;
<a name="l02299"></a>02299         end = (channel + 5 &lt; 14) ? channel + 5 : 13;
<a name="l02300"></a>02300 
<a name="l02301"></a>02301         <span class="keywordflow">for</span> (i = start; i &lt;= end; i++) {
<a name="l02302"></a>02302                 <span class="keywordflow">if</span> (abs(channel - i) &gt; 2)
<a name="l02303"></a>02303                         ret[i - 1] = <a class="code" href="phy__g_8c.html#ae8889197aeb95e3c670912be4e3e2523">b43_gphy_aci_detect</a>(dev, i);
<a name="l02304"></a>02304         }
<a name="l02305"></a>02305         <a class="code" href="phy__common_8c.html#a2efed98acfe2e35f6199b0e608e4a18c">b43_switch_channel</a>(dev, channel);
<a name="l02306"></a>02306         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, 0x0802, 0xFFFC, 0x0003);
<a name="l02307"></a>02307         <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, 0x0403, 0xFFF8);
<a name="l02308"></a>02308         <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="b43_8h.html#adc9a5c4ddc7d92707fe27a904431fdb4">B43_PHY_G_CRS</a>, 0x8000);
<a name="l02309"></a>02309         <a class="code" href="phy__g_8c.html#a0ae2d386ab09838d38248475ab50acf8">b43_set_original_gains</a>(dev);
<a name="l02310"></a>02310         <span class="keywordflow">for</span> (i = 0; i &lt; 13; i++) {
<a name="l02311"></a>02311                 <span class="keywordflow">if</span> (!ret[i])
<a name="l02312"></a>02312                         <span class="keywordflow">continue</span>;
<a name="l02313"></a>02313                 end = (i + 5 &lt; 13) ? i + 5 : 13;
<a name="l02314"></a>02314                 <span class="keywordflow">for</span> (j = i; j &lt; end; j++)
<a name="l02315"></a>02315                         ret[j] = 1;
<a name="l02316"></a>02316         }
<a name="l02317"></a>02317         <a class="code" href="phy__common_8c.html#afa073ccfcee4a29ec7e02a37c6995c30">b43_radio_unlock</a>(dev);
<a name="l02318"></a>02318         <a class="code" href="phy__common_8c.html#a7e20f7c7257bdf193df63ae1a3b2a26f">b43_phy_unlock</a>(dev);
<a name="l02319"></a>02319 
<a name="l02320"></a>02320         <span class="keywordflow">return</span> ret[channel - 1];
<a name="l02321"></a>02321 }
<a name="l02322"></a>02322 
<a name="l02323"></a><a class="code" href="phy__g_8c.html#a440742c10c83b413a9e0450ce3cfb484">02323</a> <span class="keyword">static</span> s32 <a class="code" href="phy__g_8c.html#a440742c10c83b413a9e0450ce3cfb484">b43_tssi2dbm_ad</a>(s32 num, s32 den)
<a name="l02324"></a>02324 {
<a name="l02325"></a>02325         <span class="keywordflow">if</span> (num &lt; 0)
<a name="l02326"></a>02326                 <span class="keywordflow">return</span> num / den;
<a name="l02327"></a>02327         <span class="keywordflow">else</span>
<a name="l02328"></a>02328                 <span class="keywordflow">return</span> (num + den / 2) / den;
<a name="l02329"></a>02329 }
<a name="l02330"></a>02330 
<a name="l02331"></a><a class="code" href="phy__g_8c.html#ad80db71c525bfff1a1724b3b9462e377">02331</a> <span class="keyword">static</span> s8 <a class="code" href="phy__g_8c.html#ad80db71c525bfff1a1724b3b9462e377">b43_tssi2dbm_entry</a>(s8 entry[], u8 index,
<a name="l02332"></a>02332                              s16 pab0, s16 pab1, s16 pab2)
<a name="l02333"></a>02333 {
<a name="l02334"></a>02334         s32 m1, m2, f = 256, q, delta;
<a name="l02335"></a>02335         s8 i = 0;
<a name="l02336"></a>02336 
<a name="l02337"></a>02337         m1 = <a class="code" href="phy__g_8c.html#a440742c10c83b413a9e0450ce3cfb484">b43_tssi2dbm_ad</a>(16 * pab0 + index * pab1, 32);
<a name="l02338"></a>02338         m2 = max(<a class="code" href="phy__g_8c.html#a440742c10c83b413a9e0450ce3cfb484">b43_tssi2dbm_ad</a>(32768 + index * pab2, 256), 1);
<a name="l02339"></a>02339         <span class="keywordflow">do</span> {
<a name="l02340"></a>02340                 <span class="keywordflow">if</span> (i &gt; 15)
<a name="l02341"></a>02341                         <span class="keywordflow">return</span> -EINVAL;
<a name="l02342"></a>02342                 q = <a class="code" href="phy__g_8c.html#a440742c10c83b413a9e0450ce3cfb484">b43_tssi2dbm_ad</a>(f * 4096 -
<a name="l02343"></a>02343                                     <a class="code" href="phy__g_8c.html#a440742c10c83b413a9e0450ce3cfb484">b43_tssi2dbm_ad</a>(m2 * f, 16) * f, 2048);
<a name="l02344"></a>02344                 delta = abs(q - f);
<a name="l02345"></a>02345                 f = q;
<a name="l02346"></a>02346                 i++;
<a name="l02347"></a>02347         } <span class="keywordflow">while</span> (delta &gt;= 2);
<a name="l02348"></a>02348         entry[index] = clamp_val(<a class="code" href="phy__g_8c.html#a440742c10c83b413a9e0450ce3cfb484">b43_tssi2dbm_ad</a>(m1 * f, 8192), -127, 128);
<a name="l02349"></a>02349         <span class="keywordflow">return</span> 0;
<a name="l02350"></a>02350 }
<a name="l02351"></a>02351 
<a name="l02352"></a><a class="code" href="phy__g_8h.html#aac6ff63c9375c1015e74dfa628893d6d">02352</a> u8 *<a class="code" href="phy__g_8c.html#aac6ff63c9375c1015e74dfa628893d6d">b43_generate_dyn_tssi2dbm_tab</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l02353"></a>02353                                   s16 pab0, s16 pab1, s16 pab2)
<a name="l02354"></a>02354 {
<a name="l02355"></a>02355         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l02356"></a>02356         u8 *tab;
<a name="l02357"></a>02357         <span class="keywordtype">int</span> err;
<a name="l02358"></a>02358 
<a name="l02359"></a>02359         tab = kmalloc(64, GFP_KERNEL);
<a name="l02360"></a>02360         <span class="keywordflow">if</span> (!tab) {
<a name="l02361"></a>02361                 <a class="code" href="main_8c.html#ae7d6323280005f3298ddcf79752f1e77">b43err</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>, <span class="stringliteral">&quot;Could not allocate memory &quot;</span>
<a name="l02362"></a>02362                        <span class="stringliteral">&quot;for tssi2dbm table\n&quot;</span>);
<a name="l02363"></a>02363                 <span class="keywordflow">return</span> NULL;
<a name="l02364"></a>02364         }
<a name="l02365"></a>02365         <span class="keywordflow">for</span> (i = 0; i &lt; 64; i++) {
<a name="l02366"></a>02366                 err = <a class="code" href="phy__g_8c.html#ad80db71c525bfff1a1724b3b9462e377">b43_tssi2dbm_entry</a>(tab, i, pab0, pab1, pab2);
<a name="l02367"></a>02367                 <span class="keywordflow">if</span> (err) {
<a name="l02368"></a>02368                         <a class="code" href="main_8c.html#ae7d6323280005f3298ddcf79752f1e77">b43err</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>, <span class="stringliteral">&quot;Could not generate &quot;</span>
<a name="l02369"></a>02369                                <span class="stringliteral">&quot;tssi2dBm table\n&quot;</span>);
<a name="l02370"></a>02370                         kfree(tab);
<a name="l02371"></a>02371                         <span class="keywordflow">return</span> NULL;
<a name="l02372"></a>02372                 }
<a name="l02373"></a>02373         }
<a name="l02374"></a>02374 
<a name="l02375"></a>02375         <span class="keywordflow">return</span> tab;
<a name="l02376"></a>02376 }
<a name="l02377"></a>02377 
<a name="l02378"></a>02378 <span class="comment">/* Initialise the TSSI-&gt;dBm lookup table */</span>
<a name="l02379"></a><a class="code" href="phy__g_8c.html#adab94a12234ece36ad29c18472700c9c">02379</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="phy__g_8c.html#adab94a12234ece36ad29c18472700c9c">b43_gphy_init_tssi2dbm_table</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02380"></a>02380 {
<a name="l02381"></a>02381         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02382"></a>02382         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02383"></a>02383         s16 pab0, pab1, pab2;
<a name="l02384"></a>02384 
<a name="l02385"></a>02385         pab0 = (s16) (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;pa0b0);
<a name="l02386"></a>02386         pab1 = (s16) (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;pa0b1);
<a name="l02387"></a>02387         pab2 = (s16) (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;pa0b2);
<a name="l02388"></a>02388 
<a name="l02389"></a>02389         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>((dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#ae94b6ea704b3bbbc1a516badebe3d6b7">chip_id</a> == 0x4301) &amp;&amp;
<a name="l02390"></a>02390                     (phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> != 0x2050)); <span class="comment">/* Not supported anymore */</span>
<a name="l02391"></a>02391 
<a name="l02392"></a>02392         gphy-&gt;<a class="code" href="structb43__phy__g.html#adfd23ca465fb039a4ff8a5fa7117081e">dyn_tssi_tbl</a> = 0;
<a name="l02393"></a>02393 
<a name="l02394"></a>02394         <span class="keywordflow">if</span> (pab0 != 0 &amp;&amp; pab1 != 0 &amp;&amp; pab2 != 0 &amp;&amp;
<a name="l02395"></a>02395             pab0 != -1 &amp;&amp; pab1 != -1 &amp;&amp; pab2 != -1) {
<a name="l02396"></a>02396                 <span class="comment">/* The pabX values are set in SPROM. Use them. */</span>
<a name="l02397"></a>02397                 <span class="keywordflow">if</span> ((s8) dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;itssi_bg != 0 &amp;&amp;
<a name="l02398"></a>02398                     (s8) dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;itssi_bg != -1) {
<a name="l02399"></a>02399                         gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a> =
<a name="l02400"></a>02400                                 (s8) (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;itssi_bg);
<a name="l02401"></a>02401                 } <span class="keywordflow">else</span>
<a name="l02402"></a>02402                         gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a> = 62;
<a name="l02403"></a>02403                 gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a> = <a class="code" href="phy__g_8c.html#aac6ff63c9375c1015e74dfa628893d6d">b43_generate_dyn_tssi2dbm_tab</a>(dev, pab0,
<a name="l02404"></a>02404                                                                pab1, pab2);
<a name="l02405"></a>02405                 <span class="keywordflow">if</span> (!gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a>)
<a name="l02406"></a>02406                         <span class="keywordflow">return</span> -ENOMEM;
<a name="l02407"></a>02407                 gphy-&gt;<a class="code" href="structb43__phy__g.html#adfd23ca465fb039a4ff8a5fa7117081e">dyn_tssi_tbl</a> = 1;
<a name="l02408"></a>02408         } <span class="keywordflow">else</span> {
<a name="l02409"></a>02409                 <span class="comment">/* pabX values not set in SPROM. */</span>
<a name="l02410"></a>02410                 gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a> = 52;
<a name="l02411"></a>02411                 gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a> = <a class="code" href="phy__g_8c.html#aeefb762fad7b17aca2d2df8a69f43c02">b43_tssi2dbm_g_table</a>;
<a name="l02412"></a>02412         }
<a name="l02413"></a>02413 
<a name="l02414"></a>02414         <span class="keywordflow">return</span> 0;
<a name="l02415"></a>02415 }
<a name="l02416"></a>02416 
<a name="l02417"></a><a class="code" href="phy__g_8c.html#ad51e5e5a9c9afc0e0998d944efb4f981">02417</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="phy__g_8c.html#ad51e5e5a9c9afc0e0998d944efb4f981">b43_gphy_op_allocate</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02418"></a>02418 {
<a name="l02419"></a>02419         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy;
<a name="l02420"></a>02420         <span class="keyword">struct </span><a class="code" href="structb43__txpower__lo__control.html">b43_txpower_lo_control</a> *lo;
<a name="l02421"></a>02421         <span class="keywordtype">int</span> err;
<a name="l02422"></a>02422 
<a name="l02423"></a>02423         gphy = kzalloc(<span class="keyword">sizeof</span>(*gphy), GFP_KERNEL);
<a name="l02424"></a>02424         <span class="keywordflow">if</span> (!gphy) {
<a name="l02425"></a>02425                 err = -ENOMEM;
<a name="l02426"></a>02426                 <span class="keywordflow">goto</span> error;
<a name="l02427"></a>02427         }
<a name="l02428"></a>02428         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a> = gphy;
<a name="l02429"></a>02429 
<a name="l02430"></a>02430         lo = kzalloc(<span class="keyword">sizeof</span>(*lo), GFP_KERNEL);
<a name="l02431"></a>02431         <span class="keywordflow">if</span> (!lo) {
<a name="l02432"></a>02432                 err = -ENOMEM;
<a name="l02433"></a>02433                 <span class="keywordflow">goto</span> err_free_gphy;
<a name="l02434"></a>02434         }
<a name="l02435"></a>02435         gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a> = lo;
<a name="l02436"></a>02436 
<a name="l02437"></a>02437         err = <a class="code" href="phy__g_8c.html#adab94a12234ece36ad29c18472700c9c">b43_gphy_init_tssi2dbm_table</a>(dev);
<a name="l02438"></a>02438         <span class="keywordflow">if</span> (err)
<a name="l02439"></a>02439                 <span class="keywordflow">goto</span> err_free_lo;
<a name="l02440"></a>02440 
<a name="l02441"></a>02441         <span class="keywordflow">return</span> 0;
<a name="l02442"></a>02442 
<a name="l02443"></a>02443 err_free_lo:
<a name="l02444"></a>02444         kfree(lo);
<a name="l02445"></a>02445 err_free_gphy:
<a name="l02446"></a>02446         kfree(gphy);
<a name="l02447"></a>02447 error:
<a name="l02448"></a>02448         <span class="keywordflow">return</span> err;
<a name="l02449"></a>02449 }
<a name="l02450"></a>02450 
<a name="l02451"></a><a class="code" href="phy__g_8c.html#a6662c45225cebd487bf1f9d6f543f1f6">02451</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a6662c45225cebd487bf1f9d6f543f1f6">b43_gphy_op_prepare_structs</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02452"></a>02452 {
<a name="l02453"></a>02453         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02454"></a>02454         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02455"></a>02455         <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a>;
<a name="l02456"></a>02456         <span class="keywordtype">int</span> <a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a>;
<a name="l02457"></a>02457         <span class="keyword">struct </span><a class="code" href="structb43__txpower__lo__control.html">b43_txpower_lo_control</a> *lo;
<a name="l02458"></a>02458         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l02459"></a>02459 
<a name="l02460"></a>02460         <span class="comment">/* tssi2dbm table is constant, so it is initialized at alloc time.</span>
<a name="l02461"></a>02461 <span class="comment">         * Save a copy of the pointer. */</span>
<a name="l02462"></a>02462         tssi2dbm = gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a>;
<a name="l02463"></a>02463         tgt_idle_tssi = gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a>;
<a name="l02464"></a>02464         <span class="comment">/* Save the LO pointer. */</span>
<a name="l02465"></a>02465         lo = gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>;
<a name="l02466"></a>02466 
<a name="l02467"></a>02467         <span class="comment">/* Zero out the whole PHY structure. */</span>
<a name="l02468"></a>02468         memset(gphy, 0, <span class="keyword">sizeof</span>(*gphy));
<a name="l02469"></a>02469 
<a name="l02470"></a>02470         <span class="comment">/* Restore pointers. */</span>
<a name="l02471"></a>02471         gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a> = tssi2dbm;
<a name="l02472"></a>02472         gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a> = tgt_idle_tssi;
<a name="l02473"></a>02473         gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a> = lo;
<a name="l02474"></a>02474 
<a name="l02475"></a>02475         memset(gphy-&gt;<a class="code" href="structb43__phy__g.html#ac613357f8deb042f87426458b76a0063">minlowsig</a>, 0xFF, <span class="keyword">sizeof</span>(gphy-&gt;<a class="code" href="structb43__phy__g.html#ac613357f8deb042f87426458b76a0063">minlowsig</a>));
<a name="l02476"></a>02476 
<a name="l02477"></a>02477         <span class="comment">/* NRSSI */</span>
<a name="l02478"></a>02478         <span class="keywordflow">for</span> (i = 0; i &lt; ARRAY_SIZE(gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>); i++)
<a name="l02479"></a>02479                 gphy-&gt;<a class="code" href="structb43__phy__g.html#afde22ded38fac83b6c8f2548c90caae9">nrssi</a>[i] = -1000;
<a name="l02480"></a>02480         for (i = 0; i &lt; ARRAY_SIZE(gphy-&gt;<a class="code" href="structb43__phy__g.html#aa646acd32e5858c3977a27719f82b1a4">nrssi_lt</a>); i++)
<a name="l02481"></a>02481                 gphy-&gt;<a class="code" href="structb43__phy__g.html#aa646acd32e5858c3977a27719f82b1a4">nrssi_lt</a>[i] = i;
<a name="l02482"></a>02482 
<a name="l02483"></a>02483         gphy-&gt;<a class="code" href="structb43__phy__g.html#aaff7284be0a79f40d8343650f1242f82">lofcal</a> = 0xFFFF;
<a name="l02484"></a>02484         gphy-&gt;<a class="code" href="structb43__phy__g.html#a4576ee5fb14c221f488540a7244ff621">initval</a> = 0xFFFF;
<a name="l02485"></a>02485 
<a name="l02486"></a>02486         gphy-&gt;<a class="code" href="structb43__phy__g.html#a8b5ca25c5979421db8a60d97d26d6716">interfmode</a> = <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a6f5b040d7a985ba576bb855fa8db53b2">B43_INTERFMODE_NONE</a>;
<a name="l02487"></a>02487 
<a name="l02488"></a>02488         <span class="comment">/* OFDM-table address caching. */</span>
<a name="l02489"></a>02489         gphy-&gt;<a class="code" href="structb43__phy__g.html#a6dfc132adab2c6b5990af6d01b9b5e16">ofdmtab_addr_direction</a> = B43_OFDMTAB_DIRECTION_UNKNOWN;
<a name="l02490"></a>02490 
<a name="l02491"></a>02491         gphy-&gt;<a class="code" href="structb43__phy__g.html#a97f6e21a554091585f89ae0cd7496868">average_tssi</a> = 0xFF;
<a name="l02492"></a>02492 
<a name="l02493"></a>02493         <span class="comment">/* Local Osciallator structure */</span>
<a name="l02494"></a>02494         lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#a4490f98b26e1acd94b828cd7c7ae9851">tx_bias</a> = 0xFF;
<a name="l02495"></a>02495         INIT_LIST_HEAD(&amp;lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#a03c7b11fd123a2df35e228461c3905b4">calib_list</a>);
<a name="l02496"></a>02496 }
<a name="l02497"></a>02497 
<a name="l02498"></a><a class="code" href="phy__g_8c.html#a83490e37c9c939cd46af48482bef62c9">02498</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a83490e37c9c939cd46af48482bef62c9">b43_gphy_op_free</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02499"></a>02499 {
<a name="l02500"></a>02500         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02501"></a>02501         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02502"></a>02502 
<a name="l02503"></a>02503         kfree(gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>);
<a name="l02504"></a>02504 
<a name="l02505"></a>02505         <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#adfd23ca465fb039a4ff8a5fa7117081e">dyn_tssi_tbl</a>)
<a name="l02506"></a>02506                 kfree(gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a>);
<a name="l02507"></a>02507         gphy-&gt;<a class="code" href="structb43__phy__g.html#adfd23ca465fb039a4ff8a5fa7117081e">dyn_tssi_tbl</a> = 0;
<a name="l02508"></a>02508         gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a> = NULL;
<a name="l02509"></a>02509 
<a name="l02510"></a>02510         kfree(gphy);
<a name="l02511"></a>02511         dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a> = NULL;
<a name="l02512"></a>02512 }
<a name="l02513"></a>02513 
<a name="l02514"></a><a class="code" href="phy__g_8c.html#ac58f8e6b052606297bcfaa397f018db1">02514</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="phy__g_8c.html#ac58f8e6b052606297bcfaa397f018db1">b43_gphy_op_prepare_hardware</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02515"></a>02515 {
<a name="l02516"></a>02516         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02517"></a>02517         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02518"></a>02518         <span class="keyword">struct </span><a class="code" href="structb43__txpower__lo__control.html">b43_txpower_lo_control</a> *lo = gphy-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>;
<a name="l02519"></a>02519 
<a name="l02520"></a>02520         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> != <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>);
<a name="l02521"></a>02521 
<a name="l02522"></a>02522         <a class="code" href="phy__g_8c.html#a8283064707c4217deba43654c53ee31b">default_baseband_attenuation</a>(dev, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>);
<a name="l02523"></a>02523         <a class="code" href="phy__g_8c.html#aecbb9435ad1011e21a3e1b42c69e7553">default_radio_attenuation</a>(dev, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>);
<a name="l02524"></a>02524         gphy-&gt;<a class="code" href="structb43__phy__g.html#a517345f9708b14fe2280a1fe5fe69b2a">tx_control</a> = (<a class="code" href="phy__g_8c.html#a3b4a331ba0b43dfe92c488d75784872a">default_tx_control</a>(dev) &lt;&lt; 4);
<a name="l02525"></a>02525         <a class="code" href="phy__g_8c.html#a806b0a27f3323b0746382944c69fa0b7">generate_rfatt_list</a>(dev, &amp;lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#a5a18a32a9ba71f3860873d3a3a9855fd">rfatt_list</a>);
<a name="l02526"></a>02526         <a class="code" href="phy__g_8c.html#a350bf328dac1cf65d45255b036a84686">generate_bbatt_list</a>(dev, &amp;lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#ac465063ced589ab08a38ebd3343d1cca">bbatt_list</a>);
<a name="l02527"></a>02527 
<a name="l02528"></a>02528         <span class="comment">/* Commit previous writes */</span>
<a name="l02529"></a>02529         <a class="code" href="b43_8h.html#adfd04e75bffd22461c0c7a3eab648ea1">b43_read32</a>(dev, <a class="code" href="b43_8h.html#ae49bbdbfd9ea55e3f0b21578d9e35ec7">B43_MMIO_MACCTL</a>);
<a name="l02530"></a>02530 
<a name="l02531"></a>02531         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 1) {
<a name="l02532"></a>02532                 <span class="comment">/* Workaround: Temporarly disable gmode through the early init</span>
<a name="l02533"></a>02533 <span class="comment">                 * phase, as the gmode stuff is not needed for phy rev 1 */</span>
<a name="l02534"></a>02534                 phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> = 0;
<a name="l02535"></a>02535                 <a class="code" href="main_8c.html#a51d1babcbda96b3c1091d09594c74697">b43_wireless_core_reset</a>(dev, 0);
<a name="l02536"></a>02536                 <a class="code" href="phy__g_8c.html#a42f9ffc8234338b37e4b9cbef4431ef9">b43_phy_initg</a>(dev);
<a name="l02537"></a>02537                 phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> = 1;
<a name="l02538"></a>02538                 <a class="code" href="main_8c.html#a51d1babcbda96b3c1091d09594c74697">b43_wireless_core_reset</a>(dev, 1);
<a name="l02539"></a>02539         }
<a name="l02540"></a>02540 
<a name="l02541"></a>02541         <span class="keywordflow">return</span> 0;
<a name="l02542"></a>02542 }
<a name="l02543"></a>02543 
<a name="l02544"></a><a class="code" href="phy__g_8c.html#a72e65ff21cc5ab8a308938a006c667b7">02544</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="phy__g_8c.html#a72e65ff21cc5ab8a308938a006c667b7">b43_gphy_op_init</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02545"></a>02545 {
<a name="l02546"></a>02546         <a class="code" href="phy__g_8c.html#a42f9ffc8234338b37e4b9cbef4431ef9">b43_phy_initg</a>(dev);
<a name="l02547"></a>02547 
<a name="l02548"></a>02548         <span class="keywordflow">return</span> 0;
<a name="l02549"></a>02549 }
<a name="l02550"></a>02550 
<a name="l02551"></a><a class="code" href="phy__g_8c.html#ac193d34b4888efa73100bf513a72e759">02551</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#ac193d34b4888efa73100bf513a72e759">b43_gphy_op_exit</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02552"></a>02552 {
<a name="l02553"></a>02553         <a class="code" href="lo_8c.html#a0aedff1a393d77d4ad9044cf69adc3eb">b43_lo_g_cleanup</a>(dev);
<a name="l02554"></a>02554 }
<a name="l02555"></a>02555 
<a name="l02556"></a><a class="code" href="phy__g_8c.html#a5d2663a34d1da3d618f153b3b11ca190">02556</a> <span class="keyword">static</span> u16 <a class="code" href="phy__g_8c.html#a5d2663a34d1da3d618f153b3b11ca190">b43_gphy_op_read</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 reg)
<a name="l02557"></a>02557 {
<a name="l02558"></a>02558         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#ad805fb3c087c3f1c1b6cf172abd82294">B43_MMIO_PHY_CONTROL</a>, reg);
<a name="l02559"></a>02559         <span class="keywordflow">return</span> <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#a8d03499ec93eea6e77034e1eb793790f">B43_MMIO_PHY_DATA</a>);
<a name="l02560"></a>02560 }
<a name="l02561"></a>02561 
<a name="l02562"></a><a class="code" href="phy__g_8c.html#ad3e9bb5c5e09ec981e41cbf09f0af52d">02562</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#ad3e9bb5c5e09ec981e41cbf09f0af52d">b43_gphy_op_write</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 reg, u16 value)
<a name="l02563"></a>02563 {
<a name="l02564"></a>02564         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#ad805fb3c087c3f1c1b6cf172abd82294">B43_MMIO_PHY_CONTROL</a>, reg);
<a name="l02565"></a>02565         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a8d03499ec93eea6e77034e1eb793790f">B43_MMIO_PHY_DATA</a>, value);
<a name="l02566"></a>02566 }
<a name="l02567"></a>02567 
<a name="l02568"></a><a class="code" href="phy__g_8c.html#a36deacb70c4d80e7864179de49d78c6d">02568</a> <span class="keyword">static</span> u16 <a class="code" href="phy__g_8c.html#a36deacb70c4d80e7864179de49d78c6d">b43_gphy_op_radio_read</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 reg)
<a name="l02569"></a>02569 {
<a name="l02570"></a>02570         <span class="comment">/* Register 1 is a 32-bit register. */</span>
<a name="l02571"></a>02571         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(reg == 1);
<a name="l02572"></a>02572         <span class="comment">/* G-PHY needs 0x80 for read access. */</span>
<a name="l02573"></a>02573         reg |= 0x80;
<a name="l02574"></a>02574 
<a name="l02575"></a>02575         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a4b3e516476d04840cae0ff9c6f34f84f">B43_MMIO_RADIO_CONTROL</a>, reg);
<a name="l02576"></a>02576         <span class="keywordflow">return</span> <a class="code" href="b43_8h.html#aa2589a579b35b2c67a04ce6c6673e241">b43_read16</a>(dev, <a class="code" href="b43_8h.html#aacf09bc03be57d21f37a11d22cca4861">B43_MMIO_RADIO_DATA_LOW</a>);
<a name="l02577"></a>02577 }
<a name="l02578"></a>02578 
<a name="l02579"></a><a class="code" href="phy__g_8c.html#a11fdf0d7b0a413caec893736fb32eca3">02579</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a11fdf0d7b0a413caec893736fb32eca3">b43_gphy_op_radio_write</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, u16 reg, u16 value)
<a name="l02580"></a>02580 {
<a name="l02581"></a>02581         <span class="comment">/* Register 1 is a 32-bit register. */</span>
<a name="l02582"></a>02582         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(reg == 1);
<a name="l02583"></a>02583 
<a name="l02584"></a>02584         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#a4b3e516476d04840cae0ff9c6f34f84f">B43_MMIO_RADIO_CONTROL</a>, reg);
<a name="l02585"></a>02585         <a class="code" href="b43_8h.html#a0c967641dd56d28ccd302efe6751e037">b43_write16</a>(dev, <a class="code" href="b43_8h.html#aacf09bc03be57d21f37a11d22cca4861">B43_MMIO_RADIO_DATA_LOW</a>, value);
<a name="l02586"></a>02586 }
<a name="l02587"></a>02587 
<a name="l02588"></a><a class="code" href="phy__g_8c.html#af5681505be9818f6281ad6e01ff2924a">02588</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="phy__g_8c.html#af5681505be9818f6281ad6e01ff2924a">b43_gphy_op_supports_hwpctl</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02589"></a>02589 {
<a name="l02590"></a>02590         <span class="keywordflow">return</span> (dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 6);
<a name="l02591"></a>02591 }
<a name="l02592"></a>02592 
<a name="l02593"></a><a class="code" href="phy__g_8c.html#a7f37961fe4c82652096c062e7b68453f">02593</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a7f37961fe4c82652096c062e7b68453f">b43_gphy_op_software_rfkill</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l02594"></a>02594                                         <span class="keywordtype">bool</span> blocked)
<a name="l02595"></a>02595 {
<a name="l02596"></a>02596         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02597"></a>02597         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02598"></a>02598         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> channel;
<a name="l02599"></a>02599 
<a name="l02600"></a>02600         might_sleep();
<a name="l02601"></a>02601 
<a name="l02602"></a>02602         <span class="keywordflow">if</span> (!blocked) {
<a name="l02603"></a>02603                 <span class="comment">/* Turn radio ON */</span>
<a name="l02604"></a>02604                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a3c8e49aec6d085527c4a0589271970ec">radio_on</a>)
<a name="l02605"></a>02605                         <span class="keywordflow">return</span>;
<a name="l02606"></a>02606 
<a name="l02607"></a>02607                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0015, 0x8000);
<a name="l02608"></a>02608                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0015, 0xCC00);
<a name="l02609"></a>02609                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, 0x0015, (phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a> ? 0x00C0 : 0x0000));
<a name="l02610"></a>02610                 <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#a0d84ac383a36a551d3836078d596f993">radio_off_context</a>.<a class="code" href="structb43__phy__g.html#a14c8faa9d02559530417c600cb8d6e30">valid</a>) {
<a name="l02611"></a>02611                         <span class="comment">/* Restore the RFover values. */</span>
<a name="l02612"></a>02612                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>,
<a name="l02613"></a>02613                                       gphy-&gt;<a class="code" href="structb43__phy__g.html#a0d84ac383a36a551d3836078d596f993">radio_off_context</a>.<a class="code" href="structb43__phy__g.html#aa5c5b12a65ce48f4c8412f14b0ae0ce1">rfover</a>);
<a name="l02614"></a>02614                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>,
<a name="l02615"></a>02615                                       gphy-&gt;<a class="code" href="structb43__phy__g.html#a0d84ac383a36a551d3836078d596f993">radio_off_context</a>.<a class="code" href="structb43__phy__g.html#adb6d5490a60ef9def7794ed6f8045235">rfoverval</a>);
<a name="l02616"></a>02616                         gphy-&gt;<a class="code" href="structb43__phy__g.html#a0d84ac383a36a551d3836078d596f993">radio_off_context</a>.<a class="code" href="structb43__phy__g.html#a14c8faa9d02559530417c600cb8d6e30">valid</a> = 0;
<a name="l02617"></a>02617                 }
<a name="l02618"></a>02618                 channel = phy-&gt;<a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a>;
<a name="l02619"></a>02619                 <a class="code" href="phy__g_8c.html#a4e931bb71fda25ccefc366105e9f6e8f">b43_gphy_channel_switch</a>(dev, 6, 1);
<a name="l02620"></a>02620                 <a class="code" href="phy__g_8c.html#a4e931bb71fda25ccefc366105e9f6e8f">b43_gphy_channel_switch</a>(dev, channel, 0);
<a name="l02621"></a>02621         } <span class="keywordflow">else</span> {
<a name="l02622"></a>02622                 <span class="comment">/* Turn radio OFF */</span>
<a name="l02623"></a>02623                 u16 <a class="code" href="structb43__phy__g.html#aa5c5b12a65ce48f4c8412f14b0ae0ce1">rfover</a>, <a class="code" href="structb43__phy__g.html#adb6d5490a60ef9def7794ed6f8045235">rfoverval</a>;
<a name="l02624"></a>02624 
<a name="l02625"></a>02625                 rfover = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>);
<a name="l02626"></a>02626                 rfoverval = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>);
<a name="l02627"></a>02627                 gphy-&gt;<a class="code" href="structb43__phy__g.html#a0d84ac383a36a551d3836078d596f993">radio_off_context</a>.<a class="code" href="structb43__phy__g.html#aa5c5b12a65ce48f4c8412f14b0ae0ce1">rfover</a> = rfover;
<a name="l02628"></a>02628                 gphy-&gt;<a class="code" href="structb43__phy__g.html#a0d84ac383a36a551d3836078d596f993">radio_off_context</a>.<a class="code" href="structb43__phy__g.html#adb6d5490a60ef9def7794ed6f8045235">rfoverval</a> = rfoverval;
<a name="l02629"></a>02629                 gphy-&gt;<a class="code" href="structb43__phy__g.html#a0d84ac383a36a551d3836078d596f993">radio_off_context</a>.<a class="code" href="structb43__phy__g.html#a14c8faa9d02559530417c600cb8d6e30">valid</a> = 1;
<a name="l02630"></a>02630                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a8dc6ae3db0ee7ee81ffbc072866fc129">B43_PHY_RFOVER</a>, rfover | 0x008C);
<a name="l02631"></a>02631                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__g_8h.html#a40e73b65aa4462dc02b18e160e993042">B43_PHY_RFOVERVAL</a>, rfoverval &amp; 0xFF73);
<a name="l02632"></a>02632         }
<a name="l02633"></a>02633 }
<a name="l02634"></a>02634 
<a name="l02635"></a><a class="code" href="phy__g_8c.html#a052fa7b1db8b365f179b27dbe1f93537">02635</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="phy__g_8c.html#a052fa7b1db8b365f179b27dbe1f93537">b43_gphy_op_switch_channel</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l02636"></a>02636                                       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> new_channel)
<a name="l02637"></a>02637 {
<a name="l02638"></a>02638         <span class="keywordflow">if</span> ((new_channel &lt; 1) || (new_channel &gt; 14))
<a name="l02639"></a>02639                 <span class="keywordflow">return</span> -EINVAL;
<a name="l02640"></a>02640         <a class="code" href="phy__g_8c.html#a4e931bb71fda25ccefc366105e9f6e8f">b43_gphy_channel_switch</a>(dev, new_channel, 0);
<a name="l02641"></a>02641 
<a name="l02642"></a>02642         <span class="keywordflow">return</span> 0;
<a name="l02643"></a>02643 }
<a name="l02644"></a>02644 
<a name="l02645"></a><a class="code" href="phy__g_8c.html#a61adbcc76893c27c0e32ed1dfa2a1c66">02645</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="phy__g_8c.html#a61adbcc76893c27c0e32ed1dfa2a1c66">b43_gphy_op_get_default_chan</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02646"></a>02646 {
<a name="l02647"></a>02647         <span class="keywordflow">return</span> 1; <span class="comment">/* Default to channel 1 */</span>
<a name="l02648"></a>02648 }
<a name="l02649"></a>02649 
<a name="l02650"></a><a class="code" href="phy__g_8c.html#afe70b48d80854e476af85a0c8b5013c0">02650</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#afe70b48d80854e476af85a0c8b5013c0">b43_gphy_op_set_rx_antenna</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, <span class="keywordtype">int</span> antenna)
<a name="l02651"></a>02651 {
<a name="l02652"></a>02652         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02653"></a>02653         u16 tmp;
<a name="l02654"></a>02654         <span class="keywordtype">int</span> autodiv = 0;
<a name="l02655"></a>02655 
<a name="l02656"></a>02656         <span class="keywordflow">if</span> (antenna == <a class="code" href="phy__common_8h.html#a385c44f6fb256e5716a2302a5b940388ab23e502914a2a168111843c50eefeb9e">B43_ANTENNA_AUTO0</a> || antenna == <a class="code" href="phy__common_8h.html#a385c44f6fb256e5716a2302a5b940388a8589abedca2bbccd414664343e7e07e4">B43_ANTENNA_AUTO1</a>)
<a name="l02657"></a>02657                 autodiv = 1;
<a name="l02658"></a>02658 
<a name="l02659"></a>02659         <a class="code" href="main_8c.html#abbb7dc97d3d48c3504e1c35b366407ad">b43_hf_write</a>(dev, <a class="code" href="main_8c.html#a3f3a1d36e1882927e495fa890efbbe97">b43_hf_read</a>(dev) &amp; ~<a class="code" href="b43_8h.html#a641194b823a700dea1d991ccf3cb1e28">B43_HF_ANTDIVHELP</a>);
<a name="l02660"></a>02660 
<a name="l02661"></a>02661         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__a_8h.html#a3aff4a3a88cb49a646b98fb519aed1eb">B43_PHY_BBANDCFG</a>, ~<a class="code" href="phy__a_8h.html#ae32ea6b7a05a159f1dab80b5b90f6aee">B43_PHY_BBANDCFG_RXANT</a>,
<a name="l02662"></a>02662                         (autodiv ? <a class="code" href="phy__common_8h.html#a385c44f6fb256e5716a2302a5b940388a8589abedca2bbccd414664343e7e07e4">B43_ANTENNA_AUTO1</a> : antenna) &lt;&lt;
<a name="l02663"></a>02663                         <a class="code" href="phy__a_8h.html#a2fef543d95baf65a7628e57ecba40204">B43_PHY_BBANDCFG_RXANT_SHIFT</a>);
<a name="l02664"></a>02664 
<a name="l02665"></a>02665         <span class="keywordflow">if</span> (autodiv) {
<a name="l02666"></a>02666                 tmp = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__a_8h.html#ada83f50f516b1695f0dbd4631a1c8c4a">B43_PHY_ANTDWELL</a>);
<a name="l02667"></a>02667                 <span class="keywordflow">if</span> (antenna == <a class="code" href="phy__common_8h.html#a385c44f6fb256e5716a2302a5b940388a8589abedca2bbccd414664343e7e07e4">B43_ANTENNA_AUTO1</a>)
<a name="l02668"></a>02668                         tmp &amp;= ~<a class="code" href="phy__a_8h.html#a71bc7c93e4489d0edadd8c2c73a8d751">B43_PHY_ANTDWELL_AUTODIV1</a>;
<a name="l02669"></a>02669                 <span class="keywordflow">else</span>
<a name="l02670"></a>02670                         tmp |= <a class="code" href="phy__a_8h.html#a71bc7c93e4489d0edadd8c2c73a8d751">B43_PHY_ANTDWELL_AUTODIV1</a>;
<a name="l02671"></a>02671                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__a_8h.html#ada83f50f516b1695f0dbd4631a1c8c4a">B43_PHY_ANTDWELL</a>, tmp);
<a name="l02672"></a>02672         }
<a name="l02673"></a>02673 
<a name="l02674"></a>02674         tmp = <a class="code" href="phy__common_8c.html#a03304a9babb3f6bd671e7675168c6f06">b43_phy_read</a>(dev, <a class="code" href="phy__a_8h.html#a8b6742083eaf6f3cd168f85a167cee09">B43_PHY_ANTWRSETT</a>);
<a name="l02675"></a>02675         <span class="keywordflow">if</span> (autodiv)
<a name="l02676"></a>02676                 tmp |= <a class="code" href="phy__a_8h.html#ab3deaa97e98da5cc2f05197c7323df6b">B43_PHY_ANTWRSETT_ARXDIV</a>;
<a name="l02677"></a>02677         <span class="keywordflow">else</span>
<a name="l02678"></a>02678                 tmp &amp;= ~<a class="code" href="phy__a_8h.html#ab3deaa97e98da5cc2f05197c7323df6b">B43_PHY_ANTWRSETT_ARXDIV</a>;
<a name="l02679"></a>02679         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__a_8h.html#a8b6742083eaf6f3cd168f85a167cee09">B43_PHY_ANTWRSETT</a>, tmp);
<a name="l02680"></a>02680 
<a name="l02681"></a>02681         <span class="keywordflow">if</span> (autodiv)
<a name="l02682"></a>02682                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__a_8h.html#a8b6742083eaf6f3cd168f85a167cee09">B43_PHY_ANTWRSETT</a>, <a class="code" href="phy__a_8h.html#ab3deaa97e98da5cc2f05197c7323df6b">B43_PHY_ANTWRSETT_ARXDIV</a>);
<a name="l02683"></a>02683         <span class="keywordflow">else</span> {
<a name="l02684"></a>02684                 <a class="code" href="phy__common_8c.html#af989c6b9b6c21865492deca5a70754d4">b43_phy_mask</a>(dev, <a class="code" href="phy__a_8h.html#a8b6742083eaf6f3cd168f85a167cee09">B43_PHY_ANTWRSETT</a>,
<a name="l02685"></a>02685                              <a class="code" href="phy__a_8h.html#ab3deaa97e98da5cc2f05197c7323df6b">B43_PHY_ANTWRSETT_ARXDIV</a>);
<a name="l02686"></a>02686         }
<a name="l02687"></a>02687 
<a name="l02688"></a>02688         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 2) {
<a name="l02689"></a>02689                 <a class="code" href="phy__common_8c.html#ac1f1488d81fb9ba843ec6c2995958452">b43_phy_set</a>(dev, <a class="code" href="phy__a_8h.html#a2873e8117dd1498db40f7f184f1e09fe">B43_PHY_OFDM61</a>, <a class="code" href="phy__a_8h.html#aa7269ea520f258d0347a4ae9189d027b">B43_PHY_OFDM61_10</a>);
<a name="l02690"></a>02690                 <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__a_8h.html#a939de7388186f7c8fcbdcbda86b1ee0b">B43_PHY_DIVSRCHGAINBACK</a>, 0xFF00, 0x15);
<a name="l02691"></a>02691 
<a name="l02692"></a>02692                 <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 2)
<a name="l02693"></a>02693                         <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__a_8h.html#a3ff59180eafd70bb13cfffd97fc5dcbf">B43_PHY_ADIVRELATED</a>, 8);
<a name="l02694"></a>02694                 <span class="keywordflow">else</span>
<a name="l02695"></a>02695                         <a class="code" href="phy__common_8c.html#aabba815f5765fe05a552c6c0cdf1e69b">b43_phy_maskset</a>(dev, <a class="code" href="phy__a_8h.html#a3ff59180eafd70bb13cfffd97fc5dcbf">B43_PHY_ADIVRELATED</a>, 0xFF00, 8);
<a name="l02696"></a>02696         }
<a name="l02697"></a>02697         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> &gt;= 6)
<a name="l02698"></a>02698                 <a class="code" href="phy__common_8c.html#a771be8516fddf5dd3f42196ba536739e">b43_phy_write</a>(dev, <a class="code" href="phy__a_8h.html#ace32943e6e81a5bd6e20bd0380798449">B43_PHY_OFDM9B</a>, 0xDC);
<a name="l02699"></a>02699 
<a name="l02700"></a>02700         <a class="code" href="main_8c.html#abbb7dc97d3d48c3504e1c35b366407ad">b43_hf_write</a>(dev, <a class="code" href="main_8c.html#a3f3a1d36e1882927e495fa890efbbe97">b43_hf_read</a>(dev) | <a class="code" href="b43_8h.html#a641194b823a700dea1d991ccf3cb1e28">B43_HF_ANTDIVHELP</a>);
<a name="l02701"></a>02701 }
<a name="l02702"></a>02702 
<a name="l02703"></a><a class="code" href="phy__g_8c.html#a6678d67f904d59b383f0b101f150d277">02703</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="phy__g_8c.html#a6678d67f904d59b383f0b101f150d277">b43_gphy_op_interf_mitigation</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l02704"></a>02704                                          <span class="keyword">enum</span> <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8">b43_interference_mitigation</a> mode)
<a name="l02705"></a>02705 {
<a name="l02706"></a>02706         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02707"></a>02707         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02708"></a>02708         <span class="keywordtype">int</span> currentmode;
<a name="l02709"></a>02709 
<a name="l02710"></a>02710         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> != <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>);
<a name="l02711"></a>02711         <span class="keywordflow">if</span> ((phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 0) || (!phy-&gt;<a class="code" href="structb43__phy.html#a425b0dbe6f1e5a44b92676f5d66387a8">gmode</a>))
<a name="l02712"></a>02712                 <span class="keywordflow">return</span> -ENODEV;
<a name="l02713"></a>02713 
<a name="l02714"></a>02714         gphy-&gt;<a class="code" href="structb43__phy__g.html#a039f294157f4707f4fabdca4c1721a04">aci_wlan_automatic</a> = 0;
<a name="l02715"></a>02715         <span class="keywordflow">switch</span> (mode) {
<a name="l02716"></a>02716         <span class="keywordflow">case</span> <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8af754b9a7d78f95b91962c44fe1ab48c8">B43_INTERFMODE_AUTOWLAN</a>:
<a name="l02717"></a>02717                 gphy-&gt;<a class="code" href="structb43__phy__g.html#a039f294157f4707f4fabdca4c1721a04">aci_wlan_automatic</a> = 1;
<a name="l02718"></a>02718                 <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#a716086bdb0a4e341090388e3d92e2e0b">aci_enable</a>)
<a name="l02719"></a>02719                         mode = <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a5d10454bcf2964e8914f360b4c11d9bc">B43_INTERFMODE_MANUALWLAN</a>;
<a name="l02720"></a>02720                 <span class="keywordflow">else</span>
<a name="l02721"></a>02721                         mode = <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a6f5b040d7a985ba576bb855fa8db53b2">B43_INTERFMODE_NONE</a>;
<a name="l02722"></a>02722                 <span class="keywordflow">break</span>;
<a name="l02723"></a>02723         <span class="keywordflow">case</span> <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a6f5b040d7a985ba576bb855fa8db53b2">B43_INTERFMODE_NONE</a>:
<a name="l02724"></a>02724         <span class="keywordflow">case</span> <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a013300a08f3e3e4f4cc335ec14e62b9f">B43_INTERFMODE_NONWLAN</a>:
<a name="l02725"></a>02725         <span class="keywordflow">case</span> <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a5d10454bcf2964e8914f360b4c11d9bc">B43_INTERFMODE_MANUALWLAN</a>:
<a name="l02726"></a>02726                 <span class="keywordflow">break</span>;
<a name="l02727"></a>02727         <span class="keywordflow">default</span>:
<a name="l02728"></a>02728                 <span class="keywordflow">return</span> -EINVAL;
<a name="l02729"></a>02729         }
<a name="l02730"></a>02730 
<a name="l02731"></a>02731         currentmode = gphy-&gt;<a class="code" href="structb43__phy__g.html#a8b5ca25c5979421db8a60d97d26d6716">interfmode</a>;
<a name="l02732"></a>02732         <span class="keywordflow">if</span> (currentmode == mode)
<a name="l02733"></a>02733                 <span class="keywordflow">return</span> 0;
<a name="l02734"></a>02734         <span class="keywordflow">if</span> (currentmode != <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a6f5b040d7a985ba576bb855fa8db53b2">B43_INTERFMODE_NONE</a>)
<a name="l02735"></a>02735                 <a class="code" href="phy__g_8c.html#a75396509b918588c68c1c712d2e8d57c">b43_radio_interference_mitigation_disable</a>(dev, currentmode);
<a name="l02736"></a>02736 
<a name="l02737"></a>02737         <span class="keywordflow">if</span> (mode == <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a6f5b040d7a985ba576bb855fa8db53b2">B43_INTERFMODE_NONE</a>) {
<a name="l02738"></a>02738                 gphy-&gt;<a class="code" href="structb43__phy__g.html#a716086bdb0a4e341090388e3d92e2e0b">aci_enable</a> = 0;
<a name="l02739"></a>02739                 gphy-&gt;<a class="code" href="structb43__phy__g.html#af2c7dfaedff08187e616a71bcae3af20">aci_hw_rssi</a> = 0;
<a name="l02740"></a>02740         } <span class="keywordflow">else</span>
<a name="l02741"></a>02741                 <a class="code" href="phy__g_8c.html#a1909155954c9987a88091fe7e6d3a033">b43_radio_interference_mitigation_enable</a>(dev, mode);
<a name="l02742"></a>02742         gphy-&gt;<a class="code" href="structb43__phy__g.html#a8b5ca25c5979421db8a60d97d26d6716">interfmode</a> = mode;
<a name="l02743"></a>02743 
<a name="l02744"></a>02744         <span class="keywordflow">return</span> 0;
<a name="l02745"></a>02745 }
<a name="l02746"></a>02746 
<a name="l02747"></a>02747 <span class="comment">/* http://bcm-specs.sipsolutions.net/EstimatePowerOut</span>
<a name="l02748"></a>02748 <span class="comment"> * This function converts a TSSI value to dBm in Q5.2</span>
<a name="l02749"></a>02749 <span class="comment"> */</span>
<a name="l02750"></a><a class="code" href="phy__g_8c.html#aeafbd226af4293cc4beeb33acbaf6197">02750</a> <span class="keyword">static</span> s8 <a class="code" href="phy__g_8c.html#aeafbd226af4293cc4beeb33acbaf6197">b43_gphy_estimate_power_out</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev, s8 tssi)
<a name="l02751"></a>02751 {
<a name="l02752"></a>02752         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02753"></a>02753         s8 dbm;
<a name="l02754"></a>02754         s32 tmp;
<a name="l02755"></a>02755 
<a name="l02756"></a>02756         tmp = (gphy-&gt;<a class="code" href="structb43__phy__g.html#ad6eaf8fba2c1851c2657ce71c4b8d5f4">tgt_idle_tssi</a> - gphy-&gt;<a class="code" href="structb43__phy__g.html#a55ded5b2fbe96f905cf19a1d9a6ecc37">cur_idle_tssi</a> + tssi);
<a name="l02757"></a>02757         tmp = clamp_val(tmp, 0x00, 0x3F);
<a name="l02758"></a>02758         dbm = gphy-&gt;<a class="code" href="structb43__phy__g.html#ae2843867b48eae1cbd69c18da68b869c">tssi2dbm</a>[tmp];
<a name="l02759"></a>02759 
<a name="l02760"></a>02760         <span class="keywordflow">return</span> dbm;
<a name="l02761"></a>02761 }
<a name="l02762"></a>02762 
<a name="l02763"></a><a class="code" href="phy__g_8c.html#afad2f5f73dcb41c55144abdad0c2a817">02763</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#afad2f5f73dcb41c55144abdad0c2a817">b43_put_attenuation_into_ranges</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l02764"></a>02764                                             <span class="keywordtype">int</span> *_bbatt, <span class="keywordtype">int</span> *_rfatt)
<a name="l02765"></a>02765 {
<a name="l02766"></a>02766         <span class="keywordtype">int</span> <a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a> = *_rfatt;
<a name="l02767"></a>02767         <span class="keywordtype">int</span> <a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a> = *_bbatt;
<a name="l02768"></a>02768         <span class="keyword">struct </span><a class="code" href="structb43__txpower__lo__control.html">b43_txpower_lo_control</a> *lo = dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>.<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>-&gt;<a class="code" href="structb43__phy__g.html#a60cccd94d4c9bcb2031a3d67dc80062b">lo_control</a>;
<a name="l02769"></a>02769 
<a name="l02770"></a>02770         <span class="comment">/* Get baseband and radio attenuation values into their permitted ranges.</span>
<a name="l02771"></a>02771 <span class="comment">         * Radio attenuation affects power level 4 times as much as baseband. */</span>
<a name="l02772"></a>02772 
<a name="l02773"></a>02773         <span class="comment">/* Range constants */</span>
<a name="l02774"></a>02774         <span class="keyword">const</span> <span class="keywordtype">int</span> rf_min = lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#a5a18a32a9ba71f3860873d3a3a9855fd">rfatt_list</a>.<a class="code" href="structb43__rfatt__list.html#aa02c9644ecdbd3cf8c1ef60835d77ba7">min_val</a>;
<a name="l02775"></a>02775         <span class="keyword">const</span> <span class="keywordtype">int</span> rf_max = lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#a5a18a32a9ba71f3860873d3a3a9855fd">rfatt_list</a>.<a class="code" href="structb43__rfatt__list.html#a7e1de863cebd26bf59ef8301c49a6d7f">max_val</a>;
<a name="l02776"></a>02776         <span class="keyword">const</span> <span class="keywordtype">int</span> bb_min = lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#ac465063ced589ab08a38ebd3343d1cca">bbatt_list</a>.<a class="code" href="structb43__bbatt__list.html#abf95f6e204c4f921b2eedcfad3f7c53b">min_val</a>;
<a name="l02777"></a>02777         <span class="keyword">const</span> <span class="keywordtype">int</span> bb_max = lo-&gt;<a class="code" href="structb43__txpower__lo__control.html#ac465063ced589ab08a38ebd3343d1cca">bbatt_list</a>.<a class="code" href="structb43__bbatt__list.html#a54da50e9c3b483a3737804bd61f55379">max_val</a>;
<a name="l02778"></a>02778 
<a name="l02779"></a>02779         <span class="keywordflow">while</span> (1) {
<a name="l02780"></a>02780                 <span class="keywordflow">if</span> (rfatt &gt; rf_max &amp;&amp; bbatt &gt; bb_max - 4)
<a name="l02781"></a>02781                         <span class="keywordflow">break</span>;  <span class="comment">/* Can not get it into ranges */</span>
<a name="l02782"></a>02782                 <span class="keywordflow">if</span> (rfatt &lt; rf_min &amp;&amp; bbatt &lt; bb_min + 4)
<a name="l02783"></a>02783                         <span class="keywordflow">break</span>;  <span class="comment">/* Can not get it into ranges */</span>
<a name="l02784"></a>02784                 <span class="keywordflow">if</span> (bbatt &gt; bb_max &amp;&amp; rfatt &gt; rf_max - 1)
<a name="l02785"></a>02785                         <span class="keywordflow">break</span>;  <span class="comment">/* Can not get it into ranges */</span>
<a name="l02786"></a>02786                 <span class="keywordflow">if</span> (bbatt &lt; bb_min &amp;&amp; rfatt &lt; rf_min + 1)
<a name="l02787"></a>02787                         <span class="keywordflow">break</span>;  <span class="comment">/* Can not get it into ranges */</span>
<a name="l02788"></a>02788 
<a name="l02789"></a>02789                 <span class="keywordflow">if</span> (bbatt &gt; bb_max) {
<a name="l02790"></a>02790                         bbatt -= 4;
<a name="l02791"></a>02791                         rfatt += 1;
<a name="l02792"></a>02792                         <span class="keywordflow">continue</span>;
<a name="l02793"></a>02793                 }
<a name="l02794"></a>02794                 <span class="keywordflow">if</span> (bbatt &lt; bb_min) {
<a name="l02795"></a>02795                         bbatt += 4;
<a name="l02796"></a>02796                         rfatt -= 1;
<a name="l02797"></a>02797                         <span class="keywordflow">continue</span>;
<a name="l02798"></a>02798                 }
<a name="l02799"></a>02799                 <span class="keywordflow">if</span> (rfatt &gt; rf_max) {
<a name="l02800"></a>02800                         rfatt -= 1;
<a name="l02801"></a>02801                         bbatt += 4;
<a name="l02802"></a>02802                         <span class="keywordflow">continue</span>;
<a name="l02803"></a>02803                 }
<a name="l02804"></a>02804                 <span class="keywordflow">if</span> (rfatt &lt; rf_min) {
<a name="l02805"></a>02805                         rfatt += 1;
<a name="l02806"></a>02806                         bbatt -= 4;
<a name="l02807"></a>02807                         <span class="keywordflow">continue</span>;
<a name="l02808"></a>02808                 }
<a name="l02809"></a>02809                 <span class="keywordflow">break</span>;
<a name="l02810"></a>02810         }
<a name="l02811"></a>02811 
<a name="l02812"></a>02812         *_rfatt = clamp_val(rfatt, rf_min, rf_max);
<a name="l02813"></a>02813         *_bbatt = clamp_val(bbatt, bb_min, bb_max);
<a name="l02814"></a>02814 }
<a name="l02815"></a>02815 
<a name="l02816"></a><a class="code" href="phy__g_8c.html#a6dfd6f28ee1cba28b9f97d65f3f69ddc">02816</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a6dfd6f28ee1cba28b9f97d65f3f69ddc">b43_gphy_op_adjust_txpower</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02817"></a>02817 {
<a name="l02818"></a>02818         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02819"></a>02819         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02820"></a>02820         <span class="keywordtype">int</span> <a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>, <a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>;
<a name="l02821"></a>02821         u8 <a class="code" href="structb43__phy__g.html#a517345f9708b14fe2280a1fe5fe69b2a">tx_control</a>;
<a name="l02822"></a>02822 
<a name="l02823"></a>02823         <a class="code" href="main_8c.html#a555504fbafc3537b275e563515f7f6d4">b43_mac_suspend</a>(dev);
<a name="l02824"></a>02824 
<a name="l02825"></a>02825         <span class="comment">/* Calculate the new attenuation values. */</span>
<a name="l02826"></a>02826         bbatt = gphy-&gt;<a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>.<a class="code" href="structb43__bbatt.html#afb22eb36d414900b27a1cea58718e822">att</a>;
<a name="l02827"></a>02827         bbatt += gphy-&gt;<a class="code" href="structb43__phy__g.html#adec532183cbb8d5b25a7a33ec28e77ab">bbatt_delta</a>;
<a name="l02828"></a>02828         rfatt = gphy-&gt;<a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>.<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a>;
<a name="l02829"></a>02829         rfatt += gphy-&gt;<a class="code" href="structb43__phy__g.html#a6e0c03e07d325faf1b43d88d39b5e469">rfatt_delta</a>;
<a name="l02830"></a>02830 
<a name="l02831"></a>02831         <a class="code" href="phy__g_8c.html#afad2f5f73dcb41c55144abdad0c2a817">b43_put_attenuation_into_ranges</a>(dev, &amp;bbatt, &amp;rfatt);
<a name="l02832"></a>02832         tx_control = gphy-&gt;<a class="code" href="structb43__phy__g.html#a517345f9708b14fe2280a1fe5fe69b2a">tx_control</a>;
<a name="l02833"></a>02833         <span class="keywordflow">if</span> ((phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050) &amp;&amp; (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 2)) {
<a name="l02834"></a>02834                 <span class="keywordflow">if</span> (rfatt &lt;= 1) {
<a name="l02835"></a>02835                         <span class="keywordflow">if</span> (tx_control == 0) {
<a name="l02836"></a>02836                                 tx_control =
<a name="l02837"></a>02837                                     <a class="code" href="phy__g_8h.html#a18559fa6d14f8bcafe2fb5138ec51e36">B43_TXCTL_PA2DB</a> |
<a name="l02838"></a>02838                                     <a class="code" href="phy__g_8h.html#a8d9d46847cde6629e925371d02900e1c">B43_TXCTL_TXMIX</a>;
<a name="l02839"></a>02839                                 rfatt += 2;
<a name="l02840"></a>02840                                 bbatt += 2;
<a name="l02841"></a>02841                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;
<a name="l02842"></a>02842                                    boardflags_lo &amp;
<a name="l02843"></a>02843                                    <a class="code" href="b43_8h.html#a993dd426a8e8aaa54db354185804d762">B43_BFL_PACTRL</a>) {
<a name="l02844"></a>02844                                 bbatt += 4 * (rfatt - 2);
<a name="l02845"></a>02845                                 rfatt = 2;
<a name="l02846"></a>02846                         }
<a name="l02847"></a>02847                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rfatt &gt; 4 &amp;&amp; tx_control) {
<a name="l02848"></a>02848                         tx_control = 0;
<a name="l02849"></a>02849                         <span class="keywordflow">if</span> (bbatt &lt; 3) {
<a name="l02850"></a>02850                                 rfatt -= 3;
<a name="l02851"></a>02851                                 bbatt += 2;
<a name="l02852"></a>02852                         } <span class="keywordflow">else</span> {
<a name="l02853"></a>02853                                 rfatt -= 2;
<a name="l02854"></a>02854                                 bbatt -= 2;
<a name="l02855"></a>02855                         }
<a name="l02856"></a>02856                 }
<a name="l02857"></a>02857         }
<a name="l02858"></a>02858         <span class="comment">/* Save the control values */</span>
<a name="l02859"></a>02859         gphy-&gt;<a class="code" href="structb43__phy__g.html#a517345f9708b14fe2280a1fe5fe69b2a">tx_control</a> = tx_control;
<a name="l02860"></a>02860         <a class="code" href="phy__g_8c.html#afad2f5f73dcb41c55144abdad0c2a817">b43_put_attenuation_into_ranges</a>(dev, &amp;bbatt, &amp;rfatt);
<a name="l02861"></a>02861         gphy-&gt;<a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>.<a class="code" href="structb43__rfatt.html#abcadb8b5bdb7a75db337496931e863e5">att</a> = rfatt;
<a name="l02862"></a>02862         gphy-&gt;<a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>.<a class="code" href="structb43__bbatt.html#afb22eb36d414900b27a1cea58718e822">att</a> = bbatt;
<a name="l02863"></a>02863 
<a name="l02864"></a>02864         <span class="keywordflow">if</span> (<a class="code" href="debugfs_8c.html#a2d8cac4c4fae4116d2248d9b5c3a782b">b43_debug</a>(dev, <a class="code" href="debugfs_8h.html#a9ce3904e91efa8e7a9663235bd3257f4aca6890bc7b28f7933c0b8bde140c92ba">B43_DBG_XMITPOWER</a>))
<a name="l02865"></a>02865                 <a class="code" href="main_8c.html#ac3164e7d1ba2fbd05fce755cdb232382">b43dbg</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>, <span class="stringliteral">&quot;Adjusting TX power\n&quot;</span>);
<a name="l02866"></a>02866 
<a name="l02867"></a>02867         <span class="comment">/* Adjust the hardware */</span>
<a name="l02868"></a>02868         <a class="code" href="phy__common_8c.html#a91f8d6f96e8acab0a95ea26f5490eaa5">b43_phy_lock</a>(dev);
<a name="l02869"></a>02869         <a class="code" href="phy__common_8c.html#a00c24702245c80591279e889e287d79f">b43_radio_lock</a>(dev);
<a name="l02870"></a>02870         <a class="code" href="phy__g_8c.html#a0e0f5052d0931d6fb44784874cc9235a">b43_set_txpower_g</a>(dev, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#a7dc8dcc2c1731fd685d8d19ff1497c05">bbatt</a>, &amp;gphy-&gt;<a class="code" href="structb43__phy__g.html#ac4c06bacb8515f14e48021e4bf49654d">rfatt</a>,
<a name="l02871"></a>02871                           gphy-&gt;<a class="code" href="structb43__phy__g.html#a517345f9708b14fe2280a1fe5fe69b2a">tx_control</a>);
<a name="l02872"></a>02872         <a class="code" href="phy__common_8c.html#afa073ccfcee4a29ec7e02a37c6995c30">b43_radio_unlock</a>(dev);
<a name="l02873"></a>02873         <a class="code" href="phy__common_8c.html#a7e20f7c7257bdf193df63ae1a3b2a26f">b43_phy_unlock</a>(dev);
<a name="l02874"></a>02874 
<a name="l02875"></a>02875         <a class="code" href="main_8c.html#a9078cc08815f04ffb2ca7d5e7eaf071c">b43_mac_enable</a>(dev);
<a name="l02876"></a>02876 }
<a name="l02877"></a>02877 
<a name="l02878"></a><a class="code" href="phy__g_8c.html#a5f37d01be0b234acacf17ae8ff4ca56d">02878</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="phy__common_8h.html#a6db3c97c17dd2ad5300b634b7526fd03">b43_txpwr_result</a> <a class="code" href="phy__g_8c.html#a5f37d01be0b234acacf17ae8ff4ca56d">b43_gphy_op_recalc_txpower</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev,
<a name="l02879"></a>02879                                                         <span class="keywordtype">bool</span> ignore_tssi)
<a name="l02880"></a>02880 {
<a name="l02881"></a>02881         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02882"></a>02882         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02883"></a>02883         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structb43__phy__g.html#a97f6e21a554091585f89ae0cd7496868">average_tssi</a>;
<a name="l02884"></a>02884         <span class="keywordtype">int</span> cck_result, ofdm_result;
<a name="l02885"></a>02885         <span class="keywordtype">int</span> estimated_pwr, desired_pwr, pwr_adjust;
<a name="l02886"></a>02886         <span class="keywordtype">int</span> <a class="code" href="structb43__phy__g.html#a6e0c03e07d325faf1b43d88d39b5e469">rfatt_delta</a>, <a class="code" href="structb43__phy__g.html#adec532183cbb8d5b25a7a33ec28e77ab">bbatt_delta</a>;
<a name="l02887"></a>02887         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_pwr;
<a name="l02888"></a>02888 
<a name="l02889"></a>02889         <span class="comment">/* First get the average TSSI */</span>
<a name="l02890"></a>02890         cck_result = <a class="code" href="phy__common_8c.html#a581634cd38f96a546a16e80ced8cf0b7">b43_phy_shm_tssi_read</a>(dev, <a class="code" href="b43_8h.html#a9af2bb015b0f3aba52e5234b7eb4e577">B43_SHM_SH_TSSI_CCK</a>);
<a name="l02891"></a>02891         ofdm_result = <a class="code" href="phy__common_8c.html#a581634cd38f96a546a16e80ced8cf0b7">b43_phy_shm_tssi_read</a>(dev, <a class="code" href="b43_8h.html#a09b95aad563e90219ac4d441feeb9b4d">B43_SHM_SH_TSSI_OFDM_G</a>);
<a name="l02892"></a>02892         <span class="keywordflow">if</span> ((cck_result &lt; 0) &amp;&amp; (ofdm_result &lt; 0)) {
<a name="l02893"></a>02893                 <span class="comment">/* No TSSI information available */</span>
<a name="l02894"></a>02894                 <span class="keywordflow">if</span> (!ignore_tssi)
<a name="l02895"></a>02895                         <span class="keywordflow">goto</span> no_adjustment_needed;
<a name="l02896"></a>02896                 cck_result = 0;
<a name="l02897"></a>02897                 ofdm_result = 0;
<a name="l02898"></a>02898         }
<a name="l02899"></a>02899         <span class="keywordflow">if</span> (cck_result &lt; 0)
<a name="l02900"></a>02900                 average_tssi = ofdm_result;
<a name="l02901"></a>02901         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ofdm_result &lt; 0)
<a name="l02902"></a>02902                 average_tssi = cck_result;
<a name="l02903"></a>02903         <span class="keywordflow">else</span>
<a name="l02904"></a>02904                 average_tssi = (cck_result + ofdm_result) / 2;
<a name="l02905"></a>02905         <span class="comment">/* Merge the average with the stored value. */</span>
<a name="l02906"></a>02906         <span class="keywordflow">if</span> (likely(gphy-&gt;<a class="code" href="structb43__phy__g.html#a97f6e21a554091585f89ae0cd7496868">average_tssi</a> != 0xFF))
<a name="l02907"></a>02907                 average_tssi = (average_tssi + gphy-&gt;<a class="code" href="structb43__phy__g.html#a97f6e21a554091585f89ae0cd7496868">average_tssi</a>) / 2;
<a name="l02908"></a>02908         gphy-&gt;<a class="code" href="structb43__phy__g.html#a97f6e21a554091585f89ae0cd7496868">average_tssi</a> = average_tssi;
<a name="l02909"></a>02909         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(average_tssi &gt;= <a class="code" href="b43_8h.html#abaf39b666a6db8a426f2f124472ecba4">B43_TSSI_MAX</a>);
<a name="l02910"></a>02910 
<a name="l02911"></a>02911         <span class="comment">/* Estimate the TX power emission based on the TSSI */</span>
<a name="l02912"></a>02912         estimated_pwr = <a class="code" href="phy__g_8c.html#aeafbd226af4293cc4beeb33acbaf6197">b43_gphy_estimate_power_out</a>(dev, average_tssi);
<a name="l02913"></a>02913 
<a name="l02914"></a>02914         <a class="code" href="b43_8h.html#a5e31a99344a0d0ea6d63fa726710556e">B43_WARN_ON</a>(phy-&gt;<a class="code" href="structb43__phy.html#a211f5d258a13c7775068db4ac529b0fa">type</a> != <a class="code" href="b43_8h.html#aeb74a87df0b70fff8df78f1cf4ca7701">B43_PHYTYPE_G</a>);
<a name="l02915"></a>02915         max_pwr = dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;maxpwr_bg;
<a name="l02916"></a>02916         <span class="keywordflow">if</span> (dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;boardflags_lo &amp; <a class="code" href="b43_8h.html#a993dd426a8e8aaa54db354185804d762">B43_BFL_PACTRL</a>)
<a name="l02917"></a>02917                 max_pwr -= 3; <span class="comment">/* minus 0.75 */</span>
<a name="l02918"></a>02918         <span class="keywordflow">if</span> (unlikely(max_pwr &gt;= <a class="code" href="b43_8h.html#adc9871d14bb190489a905c7a1f6a04e7">INT_TO_Q52</a>(30<span class="comment">/*dBm*/</span>))) {
<a name="l02919"></a>02919                 <a class="code" href="main_8c.html#adb2d09d5180d74a048194743ed67302b">b43warn</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>,
<a name="l02920"></a>02920                         <span class="stringliteral">&quot;Invalid max-TX-power value in SPROM.\n&quot;</span>);
<a name="l02921"></a>02921                 max_pwr = <a class="code" href="b43_8h.html#adc9871d14bb190489a905c7a1f6a04e7">INT_TO_Q52</a>(20); <span class="comment">/* fake it */</span>
<a name="l02922"></a>02922                 dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;maxpwr_bg = max_pwr;
<a name="l02923"></a>02923         }
<a name="l02924"></a>02924 
<a name="l02925"></a>02925         <span class="comment">/* Get desired power (in Q5.2) */</span>
<a name="l02926"></a>02926         <span class="keywordflow">if</span> (phy-&gt;<a class="code" href="structb43__phy.html#a99f561cf064583fa71632412293e8d74">desired_txpower</a> &lt; 0)
<a name="l02927"></a>02927                 desired_pwr = <a class="code" href="b43_8h.html#adc9871d14bb190489a905c7a1f6a04e7">INT_TO_Q52</a>(0);
<a name="l02928"></a>02928         <span class="keywordflow">else</span>
<a name="l02929"></a>02929                 desired_pwr = <a class="code" href="b43_8h.html#adc9871d14bb190489a905c7a1f6a04e7">INT_TO_Q52</a>(phy-&gt;<a class="code" href="structb43__phy.html#a99f561cf064583fa71632412293e8d74">desired_txpower</a>);
<a name="l02930"></a>02930         <span class="comment">/* And limit it. max_pwr already is Q5.2 */</span>
<a name="l02931"></a>02931         desired_pwr = clamp_val(desired_pwr, 0, max_pwr);
<a name="l02932"></a>02932         <span class="keywordflow">if</span> (<a class="code" href="debugfs_8c.html#a2d8cac4c4fae4116d2248d9b5c3a782b">b43_debug</a>(dev, <a class="code" href="debugfs_8h.html#a9ce3904e91efa8e7a9663235bd3257f4aca6890bc7b28f7933c0b8bde140c92ba">B43_DBG_XMITPOWER</a>)) {
<a name="l02933"></a>02933                 <a class="code" href="main_8c.html#ac3164e7d1ba2fbd05fce755cdb232382">b43dbg</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>,
<a name="l02934"></a>02934                        <span class="stringliteral">&quot;[TX power]  current = &quot;</span> <a class="code" href="b43_8h.html#ac03dcc599b360d63070473293d8071f6">Q52_FMT</a>
<a name="l02935"></a>02935                        <span class="stringliteral">&quot; dBm,  desired = &quot;</span> <a class="code" href="b43_8h.html#ac03dcc599b360d63070473293d8071f6">Q52_FMT</a>
<a name="l02936"></a>02936                        <span class="stringliteral">&quot; dBm,  max = &quot;</span> <a class="code" href="b43_8h.html#ac03dcc599b360d63070473293d8071f6">Q52_FMT</a> <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02937"></a>02937                        <a class="code" href="b43_8h.html#a3e2d0a674fbdfcafc5c00069844f0455">Q52_ARG</a>(estimated_pwr),
<a name="l02938"></a>02938                        <a class="code" href="b43_8h.html#a3e2d0a674fbdfcafc5c00069844f0455">Q52_ARG</a>(desired_pwr),
<a name="l02939"></a>02939                        <a class="code" href="b43_8h.html#a3e2d0a674fbdfcafc5c00069844f0455">Q52_ARG</a>(max_pwr));
<a name="l02940"></a>02940         }
<a name="l02941"></a>02941 
<a name="l02942"></a>02942         <span class="comment">/* Calculate the adjustment delta. */</span>
<a name="l02943"></a>02943         pwr_adjust = desired_pwr - estimated_pwr;
<a name="l02944"></a>02944         <span class="keywordflow">if</span> (pwr_adjust == 0)
<a name="l02945"></a>02945                 <span class="keywordflow">goto</span> no_adjustment_needed;
<a name="l02946"></a>02946 
<a name="l02947"></a>02947         <span class="comment">/* RF attenuation delta. */</span>
<a name="l02948"></a>02948         rfatt_delta = ((pwr_adjust + 7) / 8);
<a name="l02949"></a>02949         <span class="comment">/* Lower attenuation =&gt; Bigger power output. Negate it. */</span>
<a name="l02950"></a>02950         rfatt_delta = -rfatt_delta;
<a name="l02951"></a>02951 
<a name="l02952"></a>02952         <span class="comment">/* Baseband attenuation delta. */</span>
<a name="l02953"></a>02953         bbatt_delta = pwr_adjust / 2;
<a name="l02954"></a>02954         <span class="comment">/* Lower attenuation =&gt; Bigger power output. Negate it. */</span>
<a name="l02955"></a>02955         bbatt_delta = -bbatt_delta;
<a name="l02956"></a>02956         <span class="comment">/* RF att affects power level 4 times as much as</span>
<a name="l02957"></a>02957 <span class="comment">         * Baseband attennuation. Subtract it. */</span>
<a name="l02958"></a>02958         bbatt_delta -= 4 * rfatt_delta;
<a name="l02959"></a>02959 
<a name="l02960"></a>02960 <span class="preprocessor">#if B43_DEBUG</span>
<a name="l02961"></a>02961 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="debugfs_8c.html#a2d8cac4c4fae4116d2248d9b5c3a782b">b43_debug</a>(dev, <a class="code" href="debugfs_8h.html#a9ce3904e91efa8e7a9663235bd3257f4aca6890bc7b28f7933c0b8bde140c92ba">B43_DBG_XMITPOWER</a>)) {
<a name="l02962"></a>02962                 <span class="keywordtype">int</span> dbm = pwr_adjust &lt; 0 ? -pwr_adjust : pwr_adjust;
<a name="l02963"></a>02963                 <a class="code" href="main_8c.html#ac3164e7d1ba2fbd05fce755cdb232382">b43dbg</a>(dev-&gt;<a class="code" href="structb43__wldev.html#a98ac28e92a25ddf850259bdf6211ae4b">wl</a>,
<a name="l02964"></a>02964                        <span class="stringliteral">&quot;[TX power deltas]  %s&quot;</span> <a class="code" href="b43_8h.html#ac03dcc599b360d63070473293d8071f6">Q52_FMT</a> <span class="stringliteral">&quot; dBm   =&gt;   &quot;</span>
<a name="l02965"></a>02965                        <span class="stringliteral">&quot;bbatt-delta = %d,  rfatt-delta = %d\n&quot;</span>,
<a name="l02966"></a>02966                        (pwr_adjust &lt; 0 ? <span class="stringliteral">&quot;-&quot;</span> : <span class="stringliteral">&quot;&quot;</span>), <a class="code" href="b43_8h.html#a3e2d0a674fbdfcafc5c00069844f0455">Q52_ARG</a>(dbm),
<a name="l02967"></a>02967                        bbatt_delta, rfatt_delta);
<a name="l02968"></a>02968         }
<a name="l02969"></a>02969 <span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>
<a name="l02970"></a>02970 
<a name="l02971"></a>02971         <span class="comment">/* So do we finally need to adjust something in hardware? */</span>
<a name="l02972"></a>02972         <span class="keywordflow">if</span> ((rfatt_delta == 0) &amp;&amp; (bbatt_delta == 0))
<a name="l02973"></a>02973                 <span class="keywordflow">goto</span> no_adjustment_needed;
<a name="l02974"></a>02974 
<a name="l02975"></a>02975         <span class="comment">/* Save the deltas for later when we adjust the power. */</span>
<a name="l02976"></a>02976         gphy-&gt;<a class="code" href="structb43__phy__g.html#adec532183cbb8d5b25a7a33ec28e77ab">bbatt_delta</a> = bbatt_delta;
<a name="l02977"></a>02977         gphy-&gt;<a class="code" href="structb43__phy__g.html#a6e0c03e07d325faf1b43d88d39b5e469">rfatt_delta</a> = rfatt_delta;
<a name="l02978"></a>02978 
<a name="l02979"></a>02979         <span class="comment">/* We need to adjust the TX power on the device. */</span>
<a name="l02980"></a>02980         <span class="keywordflow">return</span> <a class="code" href="phy__common_8h.html#a6db3c97c17dd2ad5300b634b7526fd03a899c8d4ba958ab63ab33d04bee1bc01e">B43_TXPWR_RES_NEED_ADJUST</a>;
<a name="l02981"></a>02981 
<a name="l02982"></a>02982 no_adjustment_needed:
<a name="l02983"></a>02983         <span class="keywordflow">return</span> <a class="code" href="phy__common_8h.html#a6db3c97c17dd2ad5300b634b7526fd03ac688dafff0513e979c11092e64ba76fa">B43_TXPWR_RES_DONE</a>;
<a name="l02984"></a>02984 }
<a name="l02985"></a>02985 
<a name="l02986"></a><a class="code" href="phy__g_8c.html#a6614b1b575a8e5e210f572175a939435">02986</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a6614b1b575a8e5e210f572175a939435">b43_gphy_op_pwork_15sec</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l02987"></a>02987 {
<a name="l02988"></a>02988         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l02989"></a>02989         <span class="keyword">struct </span><a class="code" href="structb43__phy__g.html">b43_phy_g</a> *gphy = phy-&gt;<a class="code" href="structb43__phy.html#a1e9825add342ac2d7fd3890fe8244d3d">g</a>;
<a name="l02990"></a>02990 
<a name="l02991"></a>02991         <a class="code" href="main_8c.html#a555504fbafc3537b275e563515f7f6d4">b43_mac_suspend</a>(dev);
<a name="l02992"></a>02992         <span class="comment">//TODO: update_aci_moving_average</span>
<a name="l02993"></a>02993         <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#a716086bdb0a4e341090388e3d92e2e0b">aci_enable</a> &amp;&amp; gphy-&gt;<a class="code" href="structb43__phy__g.html#a039f294157f4707f4fabdca4c1721a04">aci_wlan_automatic</a>) {
<a name="l02994"></a>02994                 <span class="keywordflow">if</span> (!gphy-&gt;<a class="code" href="structb43__phy__g.html#a716086bdb0a4e341090388e3d92e2e0b">aci_enable</a> &amp;&amp; 1 <span class="comment">/*TODO: not scanning? */</span> ) {
<a name="l02995"></a>02995                         <span class="keywordflow">if</span> (0 <span class="comment">/*TODO: bunch of conditions */</span> ) {
<a name="l02996"></a>02996                                 phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#aa7290be7f21a289f2ea495328d8e90b3">interf_mitigation</a>(dev,
<a name="l02997"></a>02997                                         <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a5d10454bcf2964e8914f360b4c11d9bc">B43_INTERFMODE_MANUALWLAN</a>);
<a name="l02998"></a>02998                         }
<a name="l02999"></a>02999                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 <span class="comment">/*TODO*/</span>) {
<a name="l03000"></a>03000                            <span class="keywordflow">if</span> (<span class="comment">/*(aci_average &gt; 1000) &amp;&amp;*/</span> !<a class="code" href="phy__g_8c.html#ae5b73dc14faa8b9f5971769251972ebb">b43_gphy_aci_scan</a>(dev))
<a name="l03001"></a>03001                                 phy-&gt;<a class="code" href="structb43__phy.html#aa5e11d2a4191120b8fdbfd8b470323d2">ops</a>-&gt;<a class="code" href="structb43__phy__operations.html#aa7290be7f21a289f2ea495328d8e90b3">interf_mitigation</a>(dev, <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a6f5b040d7a985ba576bb855fa8db53b2">B43_INTERFMODE_NONE</a>);
<a name="l03002"></a>03002                 }
<a name="l03003"></a>03003         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gphy-&gt;<a class="code" href="structb43__phy__g.html#a8b5ca25c5979421db8a60d97d26d6716">interfmode</a> == <a class="code" href="phy__common_8h.html#aa38e1c1efe24b245d5a179da0b78e9a8a013300a08f3e3e4f4cc335ec14e62b9f">B43_INTERFMODE_NONWLAN</a> &amp;&amp;
<a name="l03004"></a>03004                    phy-&gt;<a class="code" href="structb43__phy.html#a371754dd59262cfc358aeea094ec9e67">rev</a> == 1) {
<a name="l03005"></a>03005                 <span class="comment">//TODO: implement rev1 workaround</span>
<a name="l03006"></a>03006         }
<a name="l03007"></a>03007         <a class="code" href="lo_8c.html#a90b99dbaf9cd48fcd505b7980f220aa2">b43_lo_g_maintanance_work</a>(dev);
<a name="l03008"></a>03008         <a class="code" href="main_8c.html#a9078cc08815f04ffb2ca7d5e7eaf071c">b43_mac_enable</a>(dev);
<a name="l03009"></a>03009 }
<a name="l03010"></a>03010 
<a name="l03011"></a><a class="code" href="phy__g_8c.html#a7ed07b2d173c9afcdbbe99e0b31dd3cb">03011</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phy__g_8c.html#a7ed07b2d173c9afcdbbe99e0b31dd3cb">b43_gphy_op_pwork_60sec</a>(<span class="keyword">struct</span> <a class="code" href="structb43__wldev.html">b43_wldev</a> *dev)
<a name="l03012"></a>03012 {
<a name="l03013"></a>03013         <span class="keyword">struct </span><a class="code" href="structb43__phy.html">b43_phy</a> *phy = &amp;dev-&gt;<a class="code" href="structb43__wldev.html#a8ed5d507cf1c689276669ce8935e2a7c">phy</a>;
<a name="l03014"></a>03014 
<a name="l03015"></a>03015         <span class="keywordflow">if</span> (!(dev-&gt;<a class="code" href="structb43__wldev.html#afd2240bbde9b9c300e8817aa90e1580b">dev</a>-&gt;<a class="code" href="structb43__bus__dev.html#a656976d02ad07d1f55055256410cb0fd">bus_sprom</a>-&gt;boardflags_lo &amp; <a class="code" href="b43_8h.html#aa3662813d12e20a94f8af57b16cb45b5">B43_BFL_RSSI</a>))
<a name="l03016"></a>03016                 <span class="keywordflow">return</span>;
<a name="l03017"></a>03017 
<a name="l03018"></a>03018         <a class="code" href="main_8c.html#a555504fbafc3537b275e563515f7f6d4">b43_mac_suspend</a>(dev);
<a name="l03019"></a>03019         <a class="code" href="phy__g_8c.html#ae11eeb69eea9f510730039dd9a623140">b43_calc_nrssi_slope</a>(dev);
<a name="l03020"></a>03020         <span class="keywordflow">if</span> ((phy-&gt;<a class="code" href="structb43__phy.html#a5a8e907e85dbb880185fa6f434075f4b">radio_ver</a> == 0x2050) &amp;&amp; (phy-&gt;<a class="code" href="structb43__phy.html#ad11081622fc78d9c32459a3109f13712">radio_rev</a> == 8)) {
<a name="l03021"></a>03021                 u8 old_chan = phy-&gt;<a class="code" href="structb43__phy.html#a68e5573cadabc1462bb752eefec9c599">channel</a>;
<a name="l03022"></a>03022 
<a name="l03023"></a>03023                 <span class="comment">/* VCO Calibration */</span>
<a name="l03024"></a>03024                 <span class="keywordflow">if</span> (old_chan &gt;= 8)
<a name="l03025"></a>03025                         <a class="code" href="phy__common_8c.html#a2efed98acfe2e35f6199b0e608e4a18c">b43_switch_channel</a>(dev, 1);
<a name="l03026"></a>03026                 <span class="keywordflow">else</span>
<a name="l03027"></a>03027                         <a class="code" href="phy__common_8c.html#a2efed98acfe2e35f6199b0e608e4a18c">b43_switch_channel</a>(dev, 13);
<a name="l03028"></a>03028                 <a class="code" href="phy__common_8c.html#a2efed98acfe2e35f6199b0e608e4a18c">b43_switch_channel</a>(dev, old_chan);
<a name="l03029"></a>03029         }
<a name="l03030"></a>03030         <a class="code" href="main_8c.html#a9078cc08815f04ffb2ca7d5e7eaf071c">b43_mac_enable</a>(dev);
<a name="l03031"></a>03031 }
<a name="l03032"></a>03032 
<a name="l03033"></a><a class="code" href="phy__g_8h.html#aeeb6af546e2258f6e982d93d8474bd66">03033</a> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structb43__phy__operations.html">b43_phy_operations</a> <a class="code" href="phy__g_8c.html#aeeb6af546e2258f6e982d93d8474bd66">b43_phyops_g</a> = {
<a name="l03034"></a>03034         .<a class="code" href="structb43__phy__operations.html#a165c4f4148350fc709122de3c7ce3efd">allocate</a>               = <a class="code" href="phy__g_8c.html#ad51e5e5a9c9afc0e0998d944efb4f981">b43_gphy_op_allocate</a>,
<a name="l03035"></a>03035         .free                   = <a class="code" href="phy__g_8c.html#a83490e37c9c939cd46af48482bef62c9">b43_gphy_op_free</a>,
<a name="l03036"></a>03036         .prepare_structs        = <a class="code" href="phy__g_8c.html#a6662c45225cebd487bf1f9d6f543f1f6">b43_gphy_op_prepare_structs</a>,
<a name="l03037"></a>03037         .prepare_hardware       = <a class="code" href="phy__g_8c.html#ac58f8e6b052606297bcfaa397f018db1">b43_gphy_op_prepare_hardware</a>,
<a name="l03038"></a>03038         .init                   = <a class="code" href="phy__g_8c.html#a72e65ff21cc5ab8a308938a006c667b7">b43_gphy_op_init</a>,
<a name="l03039"></a>03039         .exit                   = <a class="code" href="phy__g_8c.html#ac193d34b4888efa73100bf513a72e759">b43_gphy_op_exit</a>,
<a name="l03040"></a>03040         .phy_read               = <a class="code" href="phy__g_8c.html#a5d2663a34d1da3d618f153b3b11ca190">b43_gphy_op_read</a>,
<a name="l03041"></a>03041         .phy_write              = <a class="code" href="phy__g_8c.html#ad3e9bb5c5e09ec981e41cbf09f0af52d">b43_gphy_op_write</a>,
<a name="l03042"></a>03042         .radio_read             = <a class="code" href="phy__g_8c.html#a36deacb70c4d80e7864179de49d78c6d">b43_gphy_op_radio_read</a>,
<a name="l03043"></a>03043         .radio_write            = <a class="code" href="phy__g_8c.html#a11fdf0d7b0a413caec893736fb32eca3">b43_gphy_op_radio_write</a>,
<a name="l03044"></a>03044         .supports_hwpctl        = <a class="code" href="phy__g_8c.html#af5681505be9818f6281ad6e01ff2924a">b43_gphy_op_supports_hwpctl</a>,
<a name="l03045"></a>03045         .software_rfkill        = <a class="code" href="phy__g_8c.html#a7f37961fe4c82652096c062e7b68453f">b43_gphy_op_software_rfkill</a>,
<a name="l03046"></a>03046         .switch_analog          = <a class="code" href="phy__common_8c.html#af49ad5a8624b5b2cc16fa2bfc75d095d">b43_phyop_switch_analog_generic</a>,
<a name="l03047"></a>03047         .switch_channel         = <a class="code" href="phy__g_8c.html#a052fa7b1db8b365f179b27dbe1f93537">b43_gphy_op_switch_channel</a>,
<a name="l03048"></a>03048         .get_default_chan       = <a class="code" href="phy__g_8c.html#a61adbcc76893c27c0e32ed1dfa2a1c66">b43_gphy_op_get_default_chan</a>,
<a name="l03049"></a>03049         .set_rx_antenna         = <a class="code" href="phy__g_8c.html#afe70b48d80854e476af85a0c8b5013c0">b43_gphy_op_set_rx_antenna</a>,
<a name="l03050"></a>03050         .interf_mitigation      = <a class="code" href="phy__g_8c.html#a6678d67f904d59b383f0b101f150d277">b43_gphy_op_interf_mitigation</a>,
<a name="l03051"></a>03051         .recalc_txpower         = <a class="code" href="phy__g_8c.html#a5f37d01be0b234acacf17ae8ff4ca56d">b43_gphy_op_recalc_txpower</a>,
<a name="l03052"></a>03052         .adjust_txpower         = <a class="code" href="phy__g_8c.html#a6dfd6f28ee1cba28b9f97d65f3f69ddc">b43_gphy_op_adjust_txpower</a>,
<a name="l03053"></a>03053         .pwork_15sec            = <a class="code" href="phy__g_8c.html#a6614b1b575a8e5e210f572175a939435">b43_gphy_op_pwork_15sec</a>,
<a name="l03054"></a>03054         .pwork_60sec            = <a class="code" href="phy__g_8c.html#a7ed07b2d173c9afcdbbe99e0b31dd3cb">b43_gphy_op_pwork_60sec</a>,
<a name="l03055"></a>03055 };
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 11 22:05:16 2013 for CompatWireless3.2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
